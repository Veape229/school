<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<title>Veape Studio</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
		
		<script>
			tailwind.config = {
				darkMode: 'class',
				theme: {
					extend: {
						colors: {
							dark: {
								bg: '#0f172a',
								card: '#1e293b',
								text: '#f8fafc',
								muted: '#94a3b8'
							}
						}
					}
				}
			}
		</script>
		<!-- æ ¸å¿ƒåº“ï¼šä½¿ç”¨ Cloudflare CDN ç¡®ä¿ç¨³å®šæ€§ -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"
			crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"
			crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"
			crossorigin="anonymous"></script>

		<!-- LeanCloud SDK -->
		<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>

		<script>
			// --- [é…ç½®åŒºåŸŸ] ---
			// è­¦å‘Šï¼šLeanCloud å¯†é’¥å’Œ AppID å·²å…¬å¼€ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¯·å‹¿åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯ã€‚
			const LC_CONFIG = {
				appId: "yiH4miM1mv1Wd3gR5qknSDLQ-gzGzoHsz",
				appKey: "S1hUg6WIYZqWNSf10el4ECzd",
				serverURL: "https://yih4mim1.lc-cn-n1-shared.com"
			};

			// åˆå§‹åŒ– LeanCloud
			window.initLeanCloud = function() {
				if (typeof AV === 'undefined') return false;
				// æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†é»˜è®¤çš„å ä½ç¬¦é…ç½®
				if (LC_CONFIG.appId === "è¯·æ›¿æ¢ä¸ºæ‚¨çš„AppID") return false;

				let safeURL = LC_CONFIG.serverURL.trim();
				// ç§»é™¤åè®®å¤´ï¼Œç¡®ä¿ä½¿ç”¨ HTTPS
				safeURL = safeURL.replace(/https?:\/\//g, "").replace(/\/+$/, "");
				safeURL = "https://" + safeURL;

				try {
					// LeanCloud åˆå§‹åŒ–
					AV.init({
						appId: LC_CONFIG.appId,
						appKey: LC_CONFIG.appKey,
						serverURL: safeURL
					});
					console.log("LeanCloud initialized");
					return true;
				} catch (e) {
					console.error("LeanCloud init error:", e);
					return false;
				}
			};

			window.isLCReady = false;
			// é¡µé¢åŠ è½½å®Œæˆåå°è¯•åˆå§‹åŒ– LeanCloud
			window.addEventListener('load', () => {
				window.isLCReady = window.initLeanCloud();
			});
		</script>

		<style>
			/* å…¨å±€æ ·å¼å’ŒèƒŒæ™¯åŠ¨ç”» */
			body {
				font-family: 'Nunito', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
				-webkit-tap-highlight-color: transparent;
				background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
				background-size: 400% 400%;
				animation: gradientBG 15s ease infinite;
				color: #334155;
				overflow: hidden;
			}

			html.dark body {
				background: linear-gradient(-45deg, #020617, #1e1b4b, #312e81, #0f172a);
				background-size: 400% 400%;
				color: #e2e8f0;
			}

			@keyframes gradientBG {
				0% {
					background-position: 0% 50%;
				}

				50% {
					background-position: 100% 50%;
				}

				100% {
					background-position: 0% 50%;
				}
			}

			/* åŠ¨æ€æµä½“èƒŒæ™¯ */
			.blob-cont {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				z-index: -1;
				overflow: hidden;
				pointer-events: none;
			}

			.blob {
				position: absolute;
				border-radius: 50%;
				filter: blur(80px);
				opacity: 0.4;
				animation: floatBlob 20s infinite ease-in-out alternate;
			}

			html.dark .blob {
				opacity: 0.2;
			}

			.blob-1 {
				top: -10%;
				left: -10%;
				width: 50vw;
				height: 50vw;
				background: #bfdbfe;
				animation-delay: 0s;
			}

			.blob-2 {
				bottom: -10%;
				right: -10%;
				width: 60vw;
				height: 60vw;
				background: #e9d5ff;
				animation-delay: -5s;
			}

			html.dark .blob-1 {
				background: #1e3a8a;
			}

			html.dark .blob-2 {
				background: #581c87;
			}

			.blob-3 {
				top: 30%;
				right: 20%;
				width: 30vw;
				height: 30vw;
				background: #fecaca;
				animation-delay: -10s;
			}

			/* ç¡®ä¿ blob-3 åœ¨æš—æ¨¡å¼ä¸‹çš„æ ·å¼ä¹Ÿè¢«å®šä¹‰ */
			html.dark .blob-3 {
				background: #7c2d12;
			}

			@keyframes floatBlob {
				0% {
					transform: translate(0, 0) scale(1);
				}

				50% {
					transform: translate(30px, -50px) scale(0.9);
				}

				100% {
					transform: translate(0, 0) scale(1);
				}
			}

			/* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
			::-webkit-scrollbar {
				width: 6px;
				height: 6px;
			}

			::-webkit-scrollbar-track {
				background: rgba(255, 255, 255, 0.1);
			}

			::-webkit-scrollbar-thumb {
				background: rgba(255, 255, 255, 0.3);
				border-radius: 3px;
			}

			::-webkit-scrollbar-thumb:hover {
				background: rgba(255, 255, 255, 0.5);
			}

			html.dark ::-webkit-scrollbar-track {
				background: rgba(0, 0, 0, 0.2);
			}

			html.dark ::-webkit-scrollbar-thumb {
				background: rgba(255, 255, 255, 0.15);
			}

			.safe-area-pb {
				padding-bottom: env(safe-area-inset-bottom);
			}

			/* åŠ¨ç”» */
			@keyframes fadeInUp {
				from {
					opacity: 0;
					transform: translateY(20px);
				}

				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			@keyframes popIn {
				0% {
					opacity: 0;
					transform: scale(0.9);
				}

				70% {
					transform: scale(1.02);
				}

				100% {
					opacity: 1;
					transform: scale(1);
				}
			}

			@keyframes shimmer {
				0% {
					background-position: -200% 0;
				}

				100% {
					background-position: 200% 0;
				}
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}

				100% {
					transform: rotate(360deg);
				}
			}

			@keyframes breathe-glow {

				0%,
				100% {
					box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
				}

				50% {
					box-shadow: 0 0 25px rgba(59, 130, 246, 0.8);
				}
			}

			.animate-enter {
				animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
			}

			.animate-pop {
				animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
				opacity: 0;
			}

			.animate-spin-slow {
				animation: spin 4s linear infinite;
			}

			.modal-overlay {
				animation: fadeInUp 0.2s ease-out forwards;
				backdrop-filter: blur(4px);
				background: rgba(0, 0, 0, 0.2);
			}

			.spinner {
				border: 3px solid rgba(59, 130, 246, 0.3);
				border-radius: 50%;
				border-top: 3px solid #3b82f6;
				width: 24px;
				height: 24px;
				animation: spin 1s linear infinite;
			}

			.skeleton {
				background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.1) 75%);
				background-size: 200% 100%;
				animation: shimmer 1.5s infinite;
				border-radius: 0.5rem;
			}

			html.dark .skeleton {
				background: linear-gradient(90deg, rgba(255, 255, 255, 0.05) 25%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.05) 75%);
			}

			/* äº¤äº’æ•ˆæœ */
			.hover-lift {
				transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			}

			.hover-lift:hover {
				transform: translateY(-4px);
			}

			.tilt-card {
				transition: transform 0.1s ease-out;
				transform-style: preserve-3d;
			}

			.logo-glow {
				animation: breathe-glow 3s infinite ease-in-out;
			}

			/* ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
			.glass-panel {
				background: rgba(255, 255, 255, 0.65);
				backdrop-filter: blur(16px);
				-webkit-backdrop-filter: blur(16px);
				border: 1px solid rgba(255, 255, 255, 0.5);
				box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
			}

			html.dark .glass-panel {
				background: rgba(30, 41, 59, 0.6);
				border: 1px solid rgba(255, 255, 255, 0.08);
				box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
			}

			.glass-sidebar {
				background: rgba(255, 255, 255, 0.75);
				backdrop-filter: blur(20px);
				-webkit-backdrop-filter: blur(20px);
				border-right: 1px solid rgba(255, 255, 255, 0.6);
			}

			html.dark .glass-sidebar {
				background: rgba(15, 23, 42, 0.8);
				border-right: 1px solid rgba(255, 255, 255, 0.05);
			}

			/* Custom Toggle Switch Style */
			.toggle-switch input[type="checkbox"] {
				display: none;
			}

			.toggle-switch label {
				display: block;
				width: 48px;
				height: 24px;
				background-color: #cbd5e1;
				/* slate-300 */
				border-radius: 9999px;
				position: relative;
				cursor: pointer;
				transition: background-color 0.3s;
			}

			.toggle-switch label::after {
				content: '';
				position: absolute;
				top: 2px;
				left: 2px;
				width: 20px;
				height: 20px;
				background-color: white;
				border-radius: 50%;
				transition: transform 0.3s;
			}

			.toggle-switch input[type="checkbox"]:checked+label {
				background-color: var(--primary-color, #3b82f6);
				/* blue-500 default */
			}

			.toggle-switch input[type="checkbox"]:checked+label::after {
				transform: translateX(24px);
			}

			/* Dark mode compatibility */
			html.dark .toggle-switch label {
				background-color: #475569;
				/* slate-600 */
			}

			/* --- ä¸»é¢˜æ‰©æ•£è¿‡æ¸¡æ ·å¼ --- */
			.theme-transition-layer {
				position: fixed;
				top: 0;
				left: 0;
				width: 100vw;
				height: 100vh;
				z-index: 1000;
				/* ç¡®ä¿åœ¨æœ€é¡¶å±‚ */
				pointer-events: none;
				/* é»˜è®¤ä¸å¯äº¤äº’ */
			}

			/* æ‰©æ•£æ•ˆæœçš„åœ†å½¢å…ƒç´  */
			.ripple-circle {
				position: absolute;
				width: 0px;
				height: 0px;
				border-radius: 50%;
				transform: translate(-50%, -50%);
				/* å±…ä¸­äºå®šä½ç‚¹ */
				pointer-events: all;
				/* åŠ¨ç”»æ—¶å¯äº¤äº’ï¼Œé˜²æ­¢ç”¨æˆ·å¿«é€Ÿé‡å¤ç‚¹å‡» */
				opacity: 0;
				/* é»˜è®¤éšè— */
			}

			/* æ‰©æ•£åŠ¨ç”» */
			@keyframes ripple-expand {
				0% {
					width: 0px;
					height: 0px;
					opacity: 1;
					/* åŠ¨ç”»å¼€å§‹æ—¶æ˜¾ç¤º */
				}

				100% {
					/* ç¡®ä¿åœ†å½¢è¶³å¤Ÿå¤§ä»¥è¦†ç›–ä»»ä½•å±å¹• (å¯¹è§’çº¿é•¿åº¦çš„ 2-3 å€) */
					width: 300vmax;
					height: 300vmax;
					opacity: 1;
				}
			}

			/* --- ä¸»é¢˜æ‰©æ•£è¿‡æ¸¡æ ·å¼ (ç»“æŸ) */
		</style>
	</head>
	<body
		class="h-screen overflow-hidden selection:bg-indigo-200 selection:text-indigo-900 dark:selection:bg-indigo-500 dark:selection:text-white">
		<div class="blob-cont">
			<div class="blob blob-1"></div>
			<div class="blob blob-2"></div>
			<div class="blob blob-3"></div>
		</div>
		<div id="root" class="h-full relative z-10"></div>

		<script type="text/babel">
			const { useState, useEffect, useRef, useMemo, useContext, createContext, useCallback } = React;

        // --- å…¨å±€å¸¸é‡å®šä¹‰ ---
        const THEMES = [
            { id: 'blue', name: 'æå…‰è“', primary: 'blue', accent: 'cyan' },
            { id: 'rose', name: 'æ¨±èŠ±ç²‰', primary: 'rose', accent: 'pink' },
            { id: 'violet', name: 'æ˜Ÿäº‘ç´«', primary: 'violet', accent: 'fuchsia' },
            { id: 'emerald', name: 'æ£®æ—ç»¿', primary: 'emerald', accent: 'lime' },
            { id: 'orange', name: 'æ´»åŠ›æ©™', primary: 'orange', accent: 'amber' },
            { id: 'teal', name: 'æµ·æ´‹é’', primary: 'teal', accent: 'cyan' },
            { id: 'indigo', name: 'æ·±æµ·è“', primary: 'indigo', accent: 'violet' },
        ];
        // --- å…¨å±€å¸¸é‡å®šä¹‰ ---
                // ... (THEMES ä¿æŒä¸å˜)
                const DEFAULT_QUOTES = ["ä»Šå¤©ä¹Ÿæ˜¯å…ƒæ°”æ»¡æ»¡çš„ä¸€å¤©ï¼âœ¨", "æ•™è‚²çš„æœ¬è´¨æ˜¯å”¤é†’ã€‚ğŸŒ±", "ç§ä¸€æ£µæ ‘æœ€å¥½çš„æ—¶é—´æ˜¯åå¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨ã€‚ğŸŒ²", "æ˜Ÿå…‰ä¸é—®èµ¶è·¯äººã€‚â­"];
                const LEVEL_SALARY_MAP = {
					'åˆçº§ 3 çº§':900,
                    'åˆçº§ 2 çº§': 1000,
                    'åˆçº§ 1 çº§': 1100,
                    'ä¸­çº§ 3 çº§': 1200,
                    'ä¸­çº§ 2 çº§': 1300,
                    'ä¸­çº§ 1 çº§': 1400,
                    'é«˜çº§ 3 çº§': 1600,
                    'é«˜çº§ 2 çº§': 1800,
                    'é«˜çº§ 1 çº§': 2000,
                    'é»˜è®¤': 1000,
                };
                // ä¿®æ”¹ï¼šå›ºå®šçš„è¯¾ç¨‹ä»»åŠ¡åˆ—è¡¨ (5é¡¹)
                const DEFAULT_TASKS = [
                            { id: 'teachingDone', name: 'æˆè¯¾å®Œæˆ' },
                            { id: 'interpretationSent', name: 'è§£è¯»å‘é€' },
                            { id: 'homeworkSent', name: 'ä½œä¸šå‘é€' },
                            { id: 'reflectionDone', name: 'åæ€å®Œæˆ' },
                            { id: 'momentsPosted', name: 'æœ‹å‹åœˆå‘é€' }, // æ–°å¢çš„ä»»åŠ¡
                        ];

        // --- Context ---
        const AppDataContext = createContext(null);
        const ToastContext = createContext(null);
        // --- åŸºç¡€è®¾æ–½ç»„ä»¶ ---
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const TOAST_DURATION = 5000; 
            // ç¡®ä¿ä½¿ç”¨ useCallback é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
            const addToast = useCallback((msg, type = 'info') => { 
                const id = Date.now(); 
                setToasts(p => [...p, { id, msg, type }]); 
                setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), TOAST_DURATION); 
            }, []);
            
            return (
                <ToastContext.Provider value={addToast}>
                    {children}
                    <div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col gap-2 w-auto min-w-[300px]">
                        {toasts.map(t => (
                            <div 
                                key={t.id} 
                                className={`animate-enter px-6 py-3 rounded-2xl shadow-2xl flex items-center justify-between backdrop-blur-xl border border-white/20 dark:border-white/10 text-sm font-bold ${
                                    t.type === 'error' ? 'bg-red-500/80 text-white' : 
                                    t.type === 'success' ? 'bg-emerald-500/80 text-white' : 
                                    'bg-white/80 dark:bg-slate-800/90 text-slate-800 dark:text-slate-100'
                                }`}
                            >
                                <span>{t.type==='success'?'ğŸ‰ ':t.type==='error'?'âš ï¸ ':'ğŸ’¡ '} {t.msg}</span>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };
        const useToast = () => useContext(ToastContext) || (() => {});
        const useAppData = () => useContext(AppDataContext);

        // --- ç®€åŒ–ç‰ˆçš„ç¡®è®¤æ¨¡æ€æ¡†å·¥å…·å‡½æ•° (å…¨å±€) ---
        const showConfirmModal = (message, onConfirm) => {
            if(window.confirm(message)) {
                onConfirm();
            }
        };

        // Icons (Lucide Icons)
        const Icon = ({ path, size = 20, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>);
        const icons = {
            Home: <><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>,
            Users: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
            Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
            PhoneCall: <><path d="M15.05 5A5 5 0 0 1 19 8.95M15.05 1A9 9 0 0 1 23 8.94m-1 7.98v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></>,
            CheckSquare: <><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>,
            ClipboardList: <><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></>,
            Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
            Trash2: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>,
            Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
            X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
            ChevronLeft: <><polyline points="15 18 9 12 15 6"/></>,
            ChevronRight: <><polyline points="9 18 15 12 9 6"/></>,
            Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
            UserCheck: <><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></>,
            AlertCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
            Layers: <><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>,
            Palette: <><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.01 17.461 2 12 2z"/></>,
            TrendingUp: <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>,
            Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>,
            Search: <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
            Cloud: <><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></>,
            RefreshCw: <><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"/><path d="M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></>,
            Database: <><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>,
            UploadCloud: <><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/><polyline points="16 16 12 12 8 16"/></>,
            UserX: <><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></>,
            PieChart: <><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></>,
            Activity: <><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></>,
            Award: <><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></>,
            Coins: <><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="M17 17v.01"/></>,
            Wallet: <><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"/><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"/></>,
            Settings: <><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>,
            Sparkles: <><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></>,
            Sun: <><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></>,
            Moon: <><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></>,
            CloudSun: <><path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M20 12h2"/><path d="m19.07 4.93-1.41 1.41"/><path d="M15.947 12.65a4 4 0 0 0-5.925-4.128"/><path d="M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z"/></>,
            Coffee: <><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></>,
            Quote: <><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/></>,
            BookOpen: <><path d="M2 13h6"/><path d="M2 9h6"/><path d="M16 13h6"/><path d="M16 9h6"/><path d="M2 17h10"/><path d="M12 2h8a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2h-8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/></>
        };
        const LucideIcon = ({ name, size = 20, className = "" }) => <Icon path={icons[name] || icons.Users} size={size} className={className} />;
        
        // Modal Component
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-[60] p-4 safe-area-pb modal-overlay" onClick={onClose}>
                    <div className="bg-white/90 dark:bg-slate-800/95 backdrop-blur-md rounded-3xl shadow-2xl w-full max-w-lg max-h-[85vh] overflow-y-auto modal-content flex flex-col transform transition-all border border-white/50 dark:border-white/10" onClick={(e) => e.stopPropagation()}>
                        <div className="flex justify-between items-center p-5 border-b border-gray-100/50 dark:border-slate-700 sticky top-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur z-10 shrink-0">
                            <h3 className="text-xl font-bold text-slate-800 dark:text-white truncate pr-4 tracking-tight flex items-center gap-2">
                                <span className="w-1 h-6 bg-blue-500 rounded-full"></span>{title}
                            </h3>
                            <button onClick={onClose} className="text-slate-400 dark:text-slate-500 hover:text-slate-700 dark:hover:text-white p-2 rounded-full hover:bg-white/50 dark:hover:bg-slate-700 transition-colors"><LucideIcon name="X" size={24} /></button>
                        </div>
                        <div className="p-6 dark:text-slate-200">{children}</div>
                    </div>
                </div>
            );
        };

        // 3D Tilt Card Component
        const TiltCard = ({ children, className = "" }) => {
            const ref = useRef(null);
            const [transform, setTransform] = useState("perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)");
            const handleMouseMove = (e) => {
                if (!ref.current) return;
                const { left, top, width, height } = ref.current.getBoundingClientRect();
                const x = (e.clientX - left) / width;
                const y = (e.clientY - top) / height;
                const tiltX = (0.5 - y) * 5; 
                const tiltY = (x - 0.5) * 5;
                setTransform(`perspective(1000px) rotateX(${tiltX}deg) rotateY(${tiltY}deg) scale(1.01)`);
            };
            const handleMouseLeave = () => setTransform("perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)");
            return <div ref={ref} className={`tilt-card ${className}`} style={{ transform }} onMouseMove={handleMouseMove} onMouseLeave={handleMouseLeave}>{children}</div>;
        };

        const Skeleton = ({ className }) => <div className={`skeleton ${className}`}></div>;

        // --- æ–°å¢ï¼šå­¦å‘˜è¯¦æƒ…é¡µå­ç»„ä»¶ ---
        
        // å†å²è¯¾ç¨‹ Tab
        const HistoryTab = ({ data, theme }) => (
            <div className="space-y-4">
                {data.length > 0 ? data.map((c) => (
                    <div key={c.id} className="p-4 rounded-xl bg-white dark:bg-slate-700 border border-gray-100 dark:border-slate-600 shadow-sm flex items-start gap-4">
                        <div className={`w-12 h-12 rounded-lg flex flex-col items-center justify-center text-xs font-bold shrink-0 ${c.type === 'demo' ? 'bg-purple-100 text-purple-600' : `bg-${theme.primary}-100 text-${theme.primary}-600`}`}>
                            {c.dateStr.slice(5)}
                        </div>
                        <div className="flex-1">
                            <div className="font-bold text-slate-800 dark:text-white">{c.className} {c.type === 'demo' && <span className="text-[10px] bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 px-2 py-0.5 rounded-full ml-1">DEMO</span>}</div>
                            <div className="text-xs text-slate-500 dark:text-slate-400 mt-1 flex flex-col gap-0.5">
                                <span><LucideIcon name="Clock" size={12} className="inline mr-1"/> {c.startTime} - {c.endTime}</span>
                                <span><LucideIcon name="BookOpen" size={12} className="inline mr-1"/> {c.content || 'æš‚æ— å†…å®¹'}</span>
                                {c.tasks?.teachingDone && <span className="text-emerald-500"><LucideIcon name="CheckSquare" size={12} className="inline mr-1"/>å·²ç»“è¯¾å¹¶å®Œæˆä»»åŠ¡</span>}
                            </div>
                        </div>
                    </div>
                )) : (
                    <div className="text-center py-10 text-slate-400 dark:text-slate-500">è¯¥å­¦å‘˜æš‚æ— å†å²è¯¾ç¨‹è®°å½•ã€‚</div>
                )}
            </div>
        );

        // è€ƒå‹¤è®°å½• Tab
        const AttendanceTab = ({ data, studentId, theme }) => {
            const attRecords = data.map(c => ({
                date: c.dateStr,
                cname: c.className,
                type: c.type,
                att: c.attendance?.[studentId]
            })).filter(r => r.att);

            const getStatusColor = (status) => {
                if (!status) return 'text-slate-500 bg-slate-100 dark:bg-slate-700 dark:text-slate-400';
                if (status === 'present') return 'text-emerald-600 bg-emerald-100 dark:bg-emerald-900/50 dark:text-emerald-400';
                if (status === 'absent') return 'text-red-600 bg-red-100 dark:bg-red-900/50 dark:text-red-400';
                return 'text-slate-500 bg-slate-100 dark:bg-slate-700 dark:text-slate-400';
            };

            return (
                <div className="space-y-4">
                    {attRecords.length > 0 ? attRecords.map((r) => (
                        <div key={r.date + r.cname} className="p-4 rounded-xl bg-white dark:bg-slate-700 border border-gray-100 dark:border-slate-600 shadow-sm flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className="text-sm font-bold text-slate-800 dark:text-white">{r.date.slice(5)}</div>
                                <div className="text-sm text-slate-600 dark:text-slate-300">{r.cname}</div>
                            </div>
                            <div className={`px-3 py-1 text-xs font-bold rounded-full ${getStatusColor(r.att.status)}`}>
                                {r.att.status === 'present' ? 'åˆ°è¯¾' : r.att.status === 'absent' ? 'ç¼ºå‹¤' : 'æœªè®°'}
                                {r.att.isMadeUp && <span className="ml-1 text-xs"> (å·²è¡¥)</span>}
                            </div>
                        </div>
                    )) : (
                        <div className="text-center py-10 text-slate-400 dark:text-slate-500">è¯¥å­¦å‘˜æš‚æ— è€ƒå‹¤è®°å½•ã€‚</div>
                    )}
                </div>
            );
        };

        // å›è®¿å†å² Tab
        const FollowUpTab = ({ data, theme }) => (
            <div className="space-y-4">
                {data.length > 0 ? data.map((f) => (
                    <div key={f.monthStr} className="p-4 rounded-xl bg-white dark:bg-slate-700 border border-gray-100 dark:border-slate-600 shadow-sm flex items-center justify-between">
                        <div className="text-sm font-bold text-slate-800 dark:text-white">{f.monthStr.slice(0, 4)}å¹´ {f.monthStr.slice(5)}æœˆ</div>
                        <div className={`px-3 py-1 text-xs font-bold rounded-full ${f.count === 2 ? 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/50 dark:text-emerald-400' : f.count === 1 ? 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900/50 dark:text-yellow-400' : 'bg-red-100 text-red-600 dark:bg-red-900/50 dark:text-red-400'}`}>
                            å®Œæˆæ¬¡æ•°: {f.count} / 2
                        </div>
                    </div>
                )) : (
                    <div className="text-center py-10 text-slate-400 dark:text-slate-500">è¯¥å­¦å‘˜æš‚æ— å›è®¿è®°å½•ã€‚</div>
                )}
            </div>
        );

        // è¯¾æ—¶äº¤æ˜“è®°å½• Tab
        const FinanceTab = ({ data, theme, remainingHours }) => (
            <div className="space-y-4">
                <div className={`p-4 rounded-xl shadow-lg border-l-4 border-${theme.primary}-500 bg-${theme.primary}-50/50 dark:bg-${theme.primary}-900/20 flex justify-between items-center`}>
                    <div className="font-bold text-slate-700 dark:text-slate-200">å½“å‰å‰©ä½™è¯¾æ—¶</div>
                    <div className={`text-2xl font-extrabold text-${remainingHours > 8 ? 'emerald' : remainingHours > 4 ? 'orange' : 'red'}-600 dark:text-white`}>
                        {remainingHours} <span className="text-sm font-normal">è¯¾æ—¶</span>
                    </div>
                </div>
                <div className="text-xs text-slate-500 dark:text-slate-400 pt-2 pb-1 border-b border-gray-100 dark:border-slate-700">è¯¾æ—¶å˜åŠ¨å†å² (æ¨¡æ‹Ÿè®°å½•)</div>
                {data.length > 0 ? data.map((t, index) => (
                    <div key={t.date + index} className="p-3 rounded-xl bg-white dark:bg-slate-700 border border-gray-100 dark:border-slate-600 shadow-sm flex items-center justify-between">
                        <div>
                            <div className="text-sm font-bold text-slate-800 dark:text-white">{t.description}</div>
                            <div className="text-xs text-slate-400 mt-1">{t.date}</div>
                        </div>
                        <div className={`text-lg font-extrabold ${t.hours < 0 ? 'text-red-500' : 'text-emerald-500'}`}>
                            {t.hours > 0 && '+'} {t.hours} h
                        </div>
                    </div>
                )) : (
                    <div className="text-center py-10 text-slate-400 dark:text-slate-500">æš‚æ— äº¤æ˜“è®°å½•ã€‚</div>
                )}
                <div className="text-xs text-slate-400 pt-4 border-t border-gray-100 dark:border-slate-700">
                    * å¤‡æ³¨ï¼šäº¤æ˜“è®°å½•æ˜¯æ ¹æ®æ‰£è¯¾æ—¶æ“ä½œæ¨¡æ‹Ÿç”Ÿæˆï¼Œå®é™…è´­è¯¾è®°å½•éœ€ç³»ç»Ÿè¿›ä¸€æ­¥æ‰©å±•ã€‚
                </div>
            </div>
        );

        // å­¦å‘˜è¯¦æƒ…ä¸»ç»„ä»¶
        const StudentDetailPage = ({ studentId, onBack }) => {
            const { 
                students, courses, followUps, formatDate, theme, 
                lcUpdate, fetchAll, getPredictionText // <--- åŠ å…¥è¿™ä¸ª
            } = useAppData();
            const addToast = useToast(); 

            const student = useMemo(() => students.find(s => s.id === studentId), [students, studentId]);
            const [activeTab, setActiveTab] = useState('history'); 
            const [isEditOpen, setIsEditOpen] = useState(false);
            const [editStudent, setEditStudent] = useState({});

            useEffect(() => {
                if(student) {
                    setEditStudent(student);
                }
            }, [student]);


            if (!student) {
                return (
                    <div className="p-8 text-center text-red-500 animate-enter pt-20 md:pt-10">
                        å­¦å‘˜ä¿¡æ¯æœªæ‰¾åˆ°ï¼Œ<button onClick={onBack} className="text-blue-500 underline">è¿”å›åˆ—è¡¨</button>
                    </div>
                );
            }

            // --- æ•°æ®å¤„ç† ---
            const studentData = useMemo(() => {
                // 1. å†å²è¯¾ç¨‹ & è€ƒå‹¤
                const history = courses
                    .filter(c => c.studentIds && c.studentIds.includes(studentId) && c.type !== 'demo')
                    .sort((a, b) => b.dateStr.localeCompare(a.dateStr)); // æœ€è¿‘çš„åœ¨å‰

                // 2. å›è®¿å†å²
                const fuHistory = followUps
                    .filter(f => f.studentId === studentId)
                    .sort((a, b) => b.monthStr.localeCompare(a.monthStr));

                // 3. è¯¾æ—¶å˜åŠ¨è®°å½• (Transaction/Finance Log) - Placeholder/Simulation
                const hoursLog = [];
                let currentBalance = student.remainingHours; 

                // Process all courses where attendance was marked 'present' or 'isMadeUp'
                // Process all courses where attendance was marked 'present' or 'isMadeUp'
                                history.forEach(c => {
                                    const att = c.attendance?.[studentId];
                                    const hours = c.hoursDeducted || 2; // è·å–æ‰£é™¤è¯¾æ—¶æ•°
                                    // IMPORTANT: Only process if attendance status is present or absent and not marked as 'isMadeUp'
                                    // For the log, we track events that changed the balance. We assume -2h was deducted on attendance.
                                    if (att && att.status === 'present' && !att.isMadeUp) {
                                        hoursLog.push({
                                            date: c.dateStr,
                                            type: 'Attendance',
                                            description: `ä¸Šè¯¾æ‰£é™¤ (è¯¾ç¨‹: ${c.className})`,
                                            hours: -hours, // ä½¿ç”¨ hours
                                            courseId: c.id
                                        });
                                    }
                                    // ... (å…¶ä»–éƒ¨åˆ†ä¸å˜)
                                });
                
                // Add a dummy initial purchase/remaining hours (we don't have this data)
                if (student.createdAt || student.remainingHours > 0) {
                    hoursLog.push({
                        date: student.createdAt ? formatDate(new Date(student.createdAt)).slice(0,10) : 'æœªçŸ¥',
                        type: 'Initial',
                        description: `æœŸåˆæˆ–è´­è¯¾è®°å½•`,
                        hours: student.remainingHours, // Just show the final current balance here.
                        isInitial: true
                    });
                }
                
                // Sorting by date (newest first)
                hoursLog.sort((a, b) => b.date.localeCompare(a.date));

                return { history, fuHistory, hoursLog };
            }, [student, courses, followUps, studentId, formatDate]);

            const handleSave = async () => {
                if (!editStudent.name) return addToast("è¯·å¡«å†™å§“å", "error");
                const { id, ...data } = editStudent;
                data.remainingHours = Number(data.remainingHours || 0); 
                // StudentDetailPageçš„æ›´æ–°éœ€è¦åˆ·æ–°ï¼Œè¿™é‡Œä¸è·³è¿‡ fetchAll
                let success = await lcUpdate('Student', id, data);
                if(success) { 
                    setIsEditOpen(false); 
                    // lcUpdateç°åœ¨ä¼šè‡ªåŠ¨fetchAll
                    addToast("å­¦å‘˜ä¿¡æ¯å·²æ›´æ–°", "success"); 
                }
            };

            const Tabs = {
                history: { name: 'å†å²è¯¾ç¨‹', icon: 'Calendar', component: <HistoryTab data={studentData.history} theme={theme} /> },
                attendance: { name: 'è€ƒå‹¤è®°å½•', icon: 'UserCheck', component: <AttendanceTab data={studentData.history} studentId={studentId} theme={theme} /> },
                followup: { name: 'å›è®¿å†å²', icon: 'PhoneCall', component: <FollowUpTab data={studentData.fuHistory} theme={theme} /> },
                finance: { name: 'è¯¾æ—¶äº¤æ˜“è®°å½•', icon: 'Wallet', component: <FinanceTab data={studentData.hoursLog} theme={theme} remainingHours={student.remainingHours} /> },
            };

            const getWarningColor = (remaining) => {
                if (remaining <= 0) return "text-slate-900 bg-slate-100 border-slate-300 dark:text-slate-100 dark:bg-slate-700 dark:border-slate-600"; 
                if (remaining <= 4) return "text-red-600 bg-red-50 border-red-200 dark:bg-red-900/30 dark:border-red-800 dark:text-red-300";   
                if (remaining <= 8) return "text-yellow-600 bg-yellow-50 border-yellow-200 dark:bg-yellow-900/30 dark:border-yellow-800 dark:text-yellow-300"; 
                return "text-emerald-600 bg-emerald-50 border-emerald-200 dark:bg-emerald-900/30 dark:border-emerald-800 dark:text-emerald-400"; 
            };
            return (
                <div className="p-4 md:p-8 space-y-6 pb-24 md:pb-8 pt-16 md:pt-8 animate-enter max-w-7xl mx-auto">
                    {/* Header */}
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 border-b border-gray-200 dark:border-slate-700 pb-4">
                        <div className="flex items-center gap-3">
                            <button onClick={onBack} className={`text-slate-500 hover:text-${theme.primary}-600 dark:text-slate-400 dark:hover:text-white transition-colors p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700`}>
                                <LucideIcon name="ChevronLeft" size={24}/>
                            </button>
                            <div>
                                <h1 className="text-3xl font-extrabold text-slate-800 dark:text-white tracking-tight flex items-center gap-3">
                                    {student.name} çš„è¯¦æƒ…é¡µ 
                                </h1>
                                <p className="text-slate-500 dark:text-slate-400 mt-1 font-medium text-sm">ä¿¡æ¯é›†ä¸­åŒ–ï¼Œå…¨é¢äº†è§£å­¦å‘˜æƒ…å†µ</p>
                            </div>
                        </div>
                        <button 
                            onClick={() => setIsEditOpen(true)}
                            className={`bg-${theme.primary}-600 text-white px-4 py-2 rounded-xl flex items-center gap-2 text-sm shadow-md hover:bg-${theme.primary}-700 transition-colors`}
                        >
                            <LucideIcon name="Edit" size={16} /> ç¼–è¾‘åŸºæœ¬ä¿¡æ¯
                        </button>
                    </div>

                    {/* Basic Info & Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <TiltCard className="glass-panel p-6 rounded-3xl flex flex-col hover-lift">
                            <div className="flex justify-between items-center mb-4">
                                <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">åŸºæœ¬ä¿¡æ¯</div>
                                <div className={`w-10 h-10 rounded-full bg-${theme.accent}-100 text-${theme.accent}-600 flex items-center justify-center`}><LucideIcon name="Users" size={20}/></div>
                            </div>
                            <div className="space-y-2 text-sm dark:text-slate-200">
                                <p><span className="font-bold">æ€§åˆ«:</span> {student.gender}</p>
                                <p><span className="font-bold">å¹´é¾„:</span> {student.age || 'N/A'}</p>
                                <p className="truncate"><span className="font-bold">å…¥å†Œ:</span> {student.createdAt ? formatDate(new Date(student.createdAt)).slice(0,10) : 'æœªçŸ¥'}</p>
                            </div>
                        </TiltCard>

                        <TiltCard className="glass-panel p-6 rounded-3xl flex flex-col justify-center hover-lift">
                            <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">å‰©ä½™è¯¾æ—¶</div>
                            <div className={`text-4xl font-extrabold ${getWarningColor(student.remainingHours || 0)}`}>
                                {student.remainingHours || 0} <span className="text-lg font-normal">è¯¾æ—¶</span>
                            </div>
                            <div className="text-xs text-slate-400 mt-2">{getPredictionText(student.remainingHours || 0)}</div>
                        </TiltCard>

                        <TiltCard className="glass-panel p-6 rounded-3xl flex flex-col justify-center hover-lift">
                            <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">å­¦å‘˜å¤‡æ³¨</div>
                            <div className="text-sm dark:text-slate-200 flex-1 overflow-hidden">
                                {student.notes || <span className="text-slate-400 italic">æš‚æ— ç‰¹åˆ«å¤‡æ³¨</span>}
                            </div>
                        </TiltCard>
                    </div>

                    {/* Tabs Navigation */}
                    <div className="glass-panel p-1 rounded-2xl flex shadow-inner overflow-x-auto">
                        {Object.entries(Tabs).map(([key, tab]) => (
                            <button
                                key={key}
                                onClick={() => setActiveTab(key)}
                                className={`flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-bold transition-all duration-300 shrink-0 ${activeTab === key ? `bg-white dark:bg-slate-700 text-${theme.primary}-600 dark:text-white shadow-md` : 'text-slate-500 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-800'}`}
                            >
                                <LucideIcon name={tab.icon} size={18} /> {tab.name}
                            </button>
                        ))}
                    </div>

                    {/* Tabs Content */}
                    <div className="glass-panel p-6 rounded-2xl min-h-[400px]">
                        {Tabs[activeTab].component}
                    </div>

                    {/* å­¦å‘˜ç¼–è¾‘ Modal (å¤ç”¨ StudentManager çš„ Modal é€»è¾‘) */}
                    <Modal isOpen={isEditOpen} onClose={() => setIsEditOpen(false)} title="ç¼–è¾‘å­¦å‘˜ä¿¡æ¯">
                        <div className="space-y-5">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">å§“å</label>
                                    <input className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl focus:ring-2 focus:ring-blue-500/20 outline-none transition-all dark:bg-slate-700 dark:text-white" placeholder="è¾“å…¥å§“å" value={editStudent.name||''} onChange={e=>setEditStudent({...editStudent, name:e.target.value})} />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">å‰©ä½™è¯¾æ—¶</label>
                                    <input type="number" className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl focus:ring-2 focus:ring-blue-500/20 outline-none transition-all font-mono font-bold dark:bg-slate-700 dark:text-white" value={editStudent.remainingHours||0} onChange={e=>setEditStudent({...editStudent, remainingHours:e.target.value})} />
                                </div>
                            </div>
                            <div className="flex gap-4">
                                <div className="flex-1">
                                    <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">æ€§åˆ«</label>
                                    <select className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl bg-white dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-blue-500/20 outline-none transition-all" value={editStudent.gender||'ç”·'} onChange={e=>setEditStudent({...editStudent, gender:e.target.value})}>
                                        <option>ç”·</option><option>å¥³</option>
                                    </select>
                                </div>
                                <div className="flex-1">
                                    <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">å¹´é¾„</label>
                                    <input className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl focus:ring-2 focus:ring-blue-500/20 outline-none transition-all dark:bg-slate-700 dark:text-white" type="number" placeholder="0" value={editStudent.age||''} onChange={e=>setEditStudent({...editStudent, age:e.target.value})} />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">å¤‡æ³¨ä¿¡æ¯</label>
                                <textarea className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl h-24 text-sm focus:ring-2 focus:ring-blue-500/20 outline-none transition-all resize-none dark:bg-slate-700 dark:text-white" placeholder="è¾“å…¥å­¦å‘˜æƒ…å†µ..." value={editStudent.notes||''} onChange={e=>setEditStudent({...editStudent, notes:e.target.value})}></textarea>
                            </div>
                            <button onClick={handleSave} className={`w-full bg-${theme.primary}-600 text-white px-6 py-3.5 rounded-xl font-bold hover:bg-${theme.primary}-700 hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0 transition-all duration-200`}>ä¿å­˜å­¦å‘˜ä¿¡æ¯</button>
                        </div>
                    </Modal>
                </div>
            );
        };
        // --- ç»“æŸå­¦å‘˜è¯¦æƒ…é¡µå­ç»„ä»¶ ---
        // ** ç§»åŠ¨ SettingsManager åˆ°è¿™é‡Œ **
        // ** ç§»åŠ¨ SettingsManager åˆ°è¿™é‡Œ **
                const SettingsManager = () => {
                    const { 
                        teacherLevel, setTeacherLevel, classFeeBase, setClassFeeBase, theme, 
                        students, courses, classGroups, followUps, fetchAll,
                        quotes, setQuotes,
                        showTodayIncome, setShowTodayIncome,
                        handleThemeChange,formatDate
                    } = useAppData();
                    const addToast = useToast(); 
                    
                    // ä½¿ç”¨é™æ€æ—¥æœŸå­—ç¬¦ä¸²ï¼Œé˜²æ­¢ formatDate æœªå®šä¹‰å¯¼è‡´é¡µé¢å´©æºƒ
                    // ... (åœ¨ SettingsManager ç»„ä»¶å†…)
                    
                                // ä½¿ç”¨é™æ€æ—¥æœŸå­—ç¬¦ä¸²ï¼Œé˜²æ­¢ formatDate æœªå®šä¹‰å¯¼è‡´é¡µé¢å´©æºƒ
                                const UPDATE_HISTORY = [
                                            				
                                            				    { 
                                            				        version: "V1.2.3", 
                                            				        date: "2025-12-12", 
                                            				        changes: [
                                            				            "ä¼˜åŒ–ï¼šæ¦‚è§ˆé¡µï¼ˆDashboardï¼‰çš„ä»Šæ—¥è¯¾ç¨‹å¡ç‰‡ç°åœ¨å®Œç¾æ”¯æŒ**è¡¥è¯¾**ç±»å‹ï¼Œæ˜¾ç¤ºæ©™è‰²â€œè¡¥è¯¾â€æ ‡ç­¾åŠå¯¹åº”é‡‘é¢ã€‚",
                                            				            "æ–°å¢ï¼šåœ¨æ¦‚è§ˆé¡µç‚¹å‡»â€œè¡¥è¯¾â€ç±»è¯¾ç¨‹æ—¶ï¼Œç°åœ¨ä¼šå¼¹å‡º**ä¸“å±è¡¥è¯¾æ“ä½œç•Œé¢**ï¼Œä¸è¯¾ç¨‹ç®¡ç†é¡µä½“éªŒä¸€è‡´ã€‚",
                                            				            "æ–°å¢ï¼šæ”¯æŒåœ¨æ¦‚è§ˆé¡µç›´æ¥è¿›è¡Œ**ä¸€é”®å­¦å‘˜ç­¾åˆ°**ï¼ˆç¡®è®¤åˆ°è¯¾ï¼‰æˆ–**æ’¤é”€è¡¥è¯¾**ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†è¯¾æ—¶æ‰£é™¤ä¸åŸç¼ºå‹¤è®°å½•çš„çŠ¶æ€æ›´æ–°ï¼Œæ— éœ€è·³è½¬ã€‚",
                                            				            "ä¿®å¤ï¼šè§£å†³äº†æ¦‚è§ˆé¡µç»„ä»¶å› ä»£ç ç»“æ„åµŒå¥—è¿‡æ·±å¯¼è‡´çš„è¯­æ³•è§£æé”™è¯¯ï¼Œæé«˜äº†é¡µé¢ç¨³å®šæ€§ã€‚"
                                            				        ] 
                                            				    },
                                
                                            				
															{ version: "V1.2.2", date: "2025/12/10", changes: [
                                                                "æ–°å¢ï¼šç³»ç»Ÿè®¾ç½®ä¸­åŠ å…¥**èŒçº§é€‰æ‹©**åŠŸèƒ½ï¼Œå²—ä½å·¥èµ„ä¸èŒçº§åŠ¨æ€å…³è”ã€‚",
                                                                "ä¿®å¤ï¼šä¿®æ­£äº†æœˆåº¦è–ªèµ„è®¡ç®—é€»è¾‘ï¼Œæœ¬æœˆæ’è¯¾æœªä¸Šè¯¾è¯¾ç¨‹å°†ä¸è®¡å…¥æœ¬æœˆè–ªèµ„é¢„æµ‹",
																"ä¼˜åŒ–ï¼šä¼˜åŒ–è°ƒæ•´äº†å·¥ä½œæ—¥è®¡ç®—é€»è¾‘ï¼Œå‘¨ä¸€å‘¨äºŒå°†ä¸è®¡ç®—è–ªèµ„ã€‚"
                                                   
                                                            ] },
                                            				{ version: "V1.2.1", date: "2025-12-07", changes: ["æ–°å¢ï¼šè¯¾ç¨‹ç®¡ç†æ’è¯¾æ—¶ï¼Œæ”¯æŒé€‰æ‹©è‡ªå®šä¹‰çš„æ‰£é™¤è¯¾æ—¶æ•°ï¼ˆå¦‚1è¯¾æ—¶ã€1.5è¯¾æ—¶ï¼‰ï¼Œä»¥ä¾¿ç²¾ç¡®æ‰£è´¹ã€‚","ä¼˜åŒ–ï¼šè¯¾ç¨‹å¡ç‰‡ï¼ˆå‘¨/æ—¥è§†å›¾ï¼‰ç§»é™¤äº†å†—ä½™çš„è¯¾æ—¶æ ‡å‡†ä¿¡æ¯ï¼Œä»…æ˜¾ç¤ºå­¦å‘˜äººæ•°å’Œæ—¶é—´æ®µï¼Œä¿æŒç•Œé¢ç®€æ´ã€‚","ä¿®å¤ï¼šè§£å†³äº†è¯¾ç¨‹ç®¡ç†ä¸­ï¼Œå› ä¸º JSX ç»“æ„å¯¼è‡´çš„ Babel è¯­æ³•è§£æé”™è¯¯ã€‚"] },
                                            				{ version: "V1.2.0", date: "2025-12-05", changes: ["æ–°å¢ï¼šé¦–é¡µä»Šæ—¥è¯¾ç¨‹é¢æ¿å‚åŠ å¿«æ·è¯¾ç¨‹ç®¡ç†åŠŸèƒ½ï¼Œå¹¶ä¸”è¯¾ç¨‹å‡ºå‹¤æƒ…å†µä¼šè¿›è¡Œæ˜¾ç¤º","ä¼˜åŒ–ï¼šè¯¾ç¨‹ç®¡ç†ç•Œé¢ç”¨é¢œè‰²åŒºåˆ†äº†å·²æˆè¯¾å’Œæœªæˆè¯¾ï¼Œå‡ºå‹¤ç‡ä¿®æ”¹äº†è®¡ç®—é€»è¾‘ï¼Œå¢åŠ å®æ—¶è¿›åº¦æ¨¡å¼ï¼Œåˆ é™¤è¯¾ç¨‹æ•™å¸ˆä»»åŠ¡å®šåˆ¶åŠŸèƒ½ï¼Œ","ä¿®å¤ï¼šæ›´æ”¹å½“æ—¥è¯¾æ—¶è®¡ç®—é€»è¾‘ï¼Œä¸åŒ…æ‹¬æœªå‡ºå‹¤å­¦å‘˜è¯¾æ—¶ã€‚"] },
                                                            { version: "V1.1.1", date: "2025-12-05", changes: ["ä¿®å¤ï¼šå›è®¿ç®¡ç†ç³»ç»Ÿåœ¨æ›´æ–°å›è®¿æ¬¡æ•°åï¼ŒUIä¸ä¼šç«‹å³åˆ·æ–°çš„é—®é¢˜ã€‚"] },
                                                            { version: "V1.1.0", date: "2025-12-05", changes: ["æ–°å¢ï¼šè¯¾ç¨‹ç®¡ç†ä¸­æ”¯æŒ**å‘¨æœŸæ€§æ’è¯¾**åŠŸèƒ½ã€å­¦å‘˜ç®¡ç†åŠ å…¥**å­¦å‘˜è¯¦æƒ…**åŠŸèƒ½ï¼Œå¯ä»¥æ›´ç›´è§‚çœ‹åˆ°è€ƒå‹¤è®°å½•ï¼Œè¯¾æ—¶äº¤æ˜“è®°å½•ç­‰ã€è¯¾ç¨‹æ•™å¸ˆä»»åŠ¡å¯è‡ªå®šä¹‰ã€‚","ä¿®å¤ï¼šå­¦å‘˜æ‰£/è¿”è¯¾æ—¶æ—¶ï¼Œå¤šæ¬¡å¼¹å‡ºæç¤ºçš„é—®é¢˜ã€‚"] },
                                                            { version: "V1.0.5", date: "2025-12-05", changes: ["æ–°å¢ï¼šä¸»é¢˜åˆ‡æ¢åŠ¨ç”»æ•ˆæœã€‚","ä¼˜åŒ–ï¼šè°ƒæ•´ä¸»é¢˜é¢œè‰²ï¼Œç§»é™¤é»‘è‰²ä¸»é¢˜ï¼Œæ–°å¢æ´»åŠ›æ©™ã€æµ·æ´‹é’å’Œæ·±æµ·è“ä¸»é¢˜ã€‚"] },
                                                            { version: "V1.0.4", date: "2025-12-04", changes: ["æ–°å¢ï¼šæ’è¯¾åŠç­çº§ç®¡ç†ï¼Œæ·»åŠ å­¦ç”Ÿæœç´¢åŠŸèƒ½ã€‚", "ä¼˜åŒ–ï¼šè€ƒå‹¤ç›®æ ‡è®¡ç®—é€»è¾‘ï¼ˆé¢„ä¼°æ¨¡å¼æ”¹ä¸ºå­¦ç”Ÿé‡*4ï¼‰ã€‚", "ä¿®å¤ï¼šè€ƒå‹¤ç®¡ç†ä¸­è¡¥è¯¾åè¯¾æ—¶æ‰£é™¤é€»è¾‘ã€‚"] },
                                                        	{ version: "V1.0.3", date: "2025-12-02", changes: ["æ–°å¢ï¼šç³»ç»Ÿä¸»é¢˜æ¢è‰²åŠŸèƒ½ï¼Œç³»ç»Ÿç‰ˆæœ¬æ›´æ–°è®°å½•å¡ç‰‡ ","ä¼˜åŒ–ï¼šç³»ç»Ÿæ•´ä½“ç•Œé¢è®¾è®¡ã€‚"] },
                                                            { version: "V1.0.2", date: "2025-12-01", changes: ["æ–°å¢ï¼šæ¦‚è§ˆé¡µæ”¯æŒéšè—ä»Šæ—¥æ”¶å…¥ã€‚", "ä¼˜åŒ–ï¼šå­¦å‘˜ç®¡ç†åˆ—è¡¨æŒ‰å‰©ä½™è¯¾æ—¶å‡åºæ’åºã€‚"] },
                                                            { version: "V1.0.1", date: "2025-11-29", changes: ["æ–°å¢ï¼šä¸ªæ€§åŒ–è¯­å½•ç®¡ç†åŠŸèƒ½ï¼Œæ”¶å…¥è®¡ç®—åŠŸèƒ½ã€‚", "ä¿®å¤ï¼šå‘¨å¯¼èˆªå™¨åœ¨æœˆè§†å›¾ä¸‹è·³è½¬é”™è¯¯ã€‚"] },
                                                            { version: "V1.0.0", date: "2025-11-29", changes: ["ç³»ç»Ÿåˆå§‹åŒ–ï¼ŒåŒ…å«æ¦‚è§ˆã€è¯¾ç¨‹ã€å­¦å‘˜ã€ç­çº§ã€å›è®¿ã€è€ƒå‹¤ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚"] },
                                                        ];
                                // ... (å…¶ä»– SettingsManager ä»£ç ä¿æŒä¸å˜)
        			
                    const [newQuote, setNewQuote] = useState(""); 
                    
                    // è·å–æ‰€æœ‰èŒçº§åˆ—è¡¨ (æ’é™¤é»˜è®¤å€¼)
                    const levelOptions = useMemo(() => Object.keys(LEVEL_SALARY_MAP).filter(k => k !== 'é»˜è®¤'), []);
        
                    // ç›‘å¬ä¸»é¢˜å˜åŒ–
                    useEffect(() => {
                        if (theme && theme.primary) {
                            document.documentElement.style.setProperty('--primary-color', tailwind.config.theme.extend.colors[theme.primary]?.[600] || '#3b82f6');
                        }
                    }, [theme]);
        
                    const handleSave = () => {
                        // èŒçº§ä¿å­˜åœ¨ localStorageï¼Œåº”ç”¨åˆ·æ–°æ—¶é‡æ–°è¯»å–
                        localStorage.setItem('lms_teacher_level', teacherLevel);
                        localStorage.setItem('lms_class_fee_base', classFeeBase);
                        localStorage.setItem('lms_quotes', JSON.stringify(quotes));
                        localStorage.setItem('lms_show_today_income', showTodayIncome);
                        addToast("è®¾ç½®å·²ä¿å­˜", "success");
                    }
                    
                    const handleAddQuote = () => {
                        if (!newQuote.trim()) return addToast("å†…å®¹ä¸èƒ½ä¸ºç©º", "error");
                        const currentQuotes = Array.isArray(quotes) ? quotes : [];
                        setQuotes([...currentQuotes, newQuote.trim()]);
                        setNewQuote("");
                        addToast("è¯­å½•å·²æ·»åŠ ", "success");
                    };
        
                    const handleDeleteQuote = (index) => {
                        showConfirmModal("ç¡®å®šåˆ é™¤è¿™æ¡è¯­å½•å—ï¼Ÿ", () => {
                            const newQuotes = [...(quotes || [])];
                            newQuotes.splice(index, 1);
                            setQuotes(newQuotes);
                            addToast("è¯­å½•å·²åˆ é™¤", "success");
                        });
                    };
                    
                    const handleExport = () => {
                        const backupData = {
                            version: "1.2.1",
                            timestamp: new Date().toISOString(),
                            students, courses, classGroups, followUps, quotes
                        };
                        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `veape_backup.json`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        addToast("å¤‡ä»½æ–‡ä»¶å·²ä¸‹è½½", "success");
                    };
        
                    const handleImport = async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                const data = JSON.parse(event.target.result);
                                if(!data.students || !data.classGroups) throw new Error("æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶");
                                addToast("å¼€å§‹æ¢å¤æ•°æ®...", "info");
                                
                                // è¾…åŠ©æ¢å¤å‡½æ•°
                                const restoreItem = async (className, item) => {
                                    const { id, createdAt, updatedAt, objectId, ...payload } = item;
                                    try {
                                        const obj = AV.Object.createWithoutData(className, id);
                                        Object.keys(payload).forEach(k => { if (['id', 'objectId', 'createdAt', 'updatedAt'].includes(k)) return; obj.set(k, payload[k]); });
                                        await obj.save();
                                    } catch (err) {
                                        const NewObj = AV.Object.extend(className);
                                        const newObj = new NewObj();
                                        Object.keys(payload).forEach(k => { if (['id', 'objectId', 'createdAt', 'updatedAt'].includes(k)) return; newObj.set(k, payload[k]); });
                                        await newObj.save();
                                    }
                                };
        
                                for (const s of data.students) await restoreItem('Student', s);
                                for (const g of data.classGroups) await restoreItem('ClassGroup', g);
                                for (const c of data.courses) await restoreItem('Course', c);
                                for (const f of data.followUps) await restoreItem('FollowUp', f);
                                if (data.quotes && Array.isArray(data.quotes)) setQuotes(data.quotes);
        
                                await fetchAll();
                                addToast("æ•°æ®æ¢å¤å®Œæˆï¼", "success");
                            } catch (err) {
                                console.error(err);
                                addToast("æ¢å¤å¤±è´¥: " + err.message, "error");
                            } finally { e.target.value = ''; }
                        };
                        reader.readAsText(file);
                    };
        
                    return (
                        <div className="p-6 md:p-10 space-y-8 pb-24 md:pb-10 pt-20 md:pt-10 animate-enter max-w-6xl mx-auto">
                            <div className="flex justify-between items-end mb-2">
                                <div>
                                    <h2 className="text-3xl font-bold text-slate-800 dark:text-white tracking-tight flex items-center gap-3">
                                        <LucideIcon name="Settings" size={32} className={`text-${theme.primary}-500 animate-spin-slow`}/> 
                                        ç³»ç»Ÿè®¾ç½®
                                    </h2>
                                    <p className="text-slate-500 dark:text-slate-400 mt-2 font-medium">ä¸ªæ€§åŒ–é…ç½®æ‚¨çš„å·¥ä½œå°</p>
                                </div>
                            </div>
        
                            <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8">
                                {/* å¡ç‰‡ 1: å¸¸è§„é€‰é¡¹ */}
                                <TiltCard className="glass-panel p-8 rounded-3xl h-full flex flex-col hover-lift">
                                    <h3 className="font-bold text-xl text-slate-800 dark:text-white mb-8 flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-2xl bg-${theme.primary}-100 text-${theme.primary}-600 dark:bg-slate-700 dark:text-white flex items-center justify-center shadow-inner`}><LucideIcon name="Settings" size={22}/></div>
                                        å¸¸è§„é€‰é¡¹
                                    </h3>
                                    <div className="space-y-8 flex-1">
                                        <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-2xl bg-white/50 dark:bg-slate-800/50 flex justify-between items-center shadow-sm">
                                            <div>
                                                <label htmlFor="showIncomeToggle" className="block text-sm font-bold text-slate-600 dark:text-slate-300 mb-1 cursor-pointer">
                                                    æ˜¾ç¤ºä»Šæ—¥æ”¶å…¥
                                                </label>
                                                <p className="text-xs text-slate-400">åœ¨æ¦‚è§ˆé¡µå¡ç‰‡ä¸­æ˜¾ç¤ºæ•æ„Ÿçš„è–ªèµ„æ•°æ®</p>
                                            </div>
                                            <div className="toggle-switch">
                                                <input type="checkbox" id="showIncomeToggle" checked={showTodayIncome} onChange={() => setShowTodayIncome(!showTodayIncome)} />
                                                <label htmlFor="showIncomeToggle"></label>
                                            </div>
                                        </div>
                                        
                                        {/* ä¿®æ­£ï¼šæ•™å¸ˆè¯„çº§æ”¹ä¸ºä¸‹æ‹‰é€‰æ‹© */}
                                        <div>
                                            <label className="block text-sm font-bold text-slate-600 dark:text-slate-300 mb-2 uppercase tracking-wider">æ•™å¸ˆè¯„çº§</label>
                                            <select 
                                                className="w-full border border-slate-200 dark:border-slate-600 p-4 rounded-2xl focus:ring-4 focus:ring-blue-100 dark:focus:ring-slate-700 focus:border-blue-400 dark:focus:border-slate-500 outline-none transition-all text-slate-700 dark:text-white bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm" 
                                                value={teacherLevel} 
                                                onChange={e=>setTeacherLevel(e.target.value)}
                                            >
                                                {levelOptions.map(level => (
                                                    <option key={level} value={level}>{level} (å²—ä½: Â¥{LEVEL_SALARY_MAP[level]})</option>
                                                ))}
                                            </select>
                                            <p className="text-xs text-slate-400 mt-2">èŒçº§å˜åŠ¨å°†å½±å“æ‚¨çš„å›ºå®šå²—ä½å·¥èµ„ã€‚</p>
                                        </div>
                                        
                                        <div className="pt-6 border-t border-slate-100 dark:border-slate-700">
                                            <label className="block text-sm font-bold text-slate-600 dark:text-slate-300 mb-3 uppercase tracking-wider">å¸¸è§„è¯¾è¯¾æ—¶è´¹åŸºæ•° (å…ƒ/è¯¾æ—¶)</label>
                                            <div className="flex items-center gap-4">
                                                <div className="w-14 h-14 bg-white dark:bg-slate-700 rounded-2xl flex items-center justify-center text-slate-400 dark:text-slate-200 font-bold text-2xl shadow-sm border border-slate-100 dark:border-slate-600">Â¥</div>
                                                <input type="number" className="flex-1 border border-slate-200 dark:border-slate-600 p-4 rounded-2xl focus:ring-4 focus:ring-blue-100 dark:focus:ring-slate-700 focus:border-blue-400 dark:focus:border-slate-500 outline-none transition-all font-mono font-bold text-2xl text-slate-800 dark:text-white bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm" value={classFeeBase} onChange={e=>setClassFeeBase(Number(e.target.value))} />
                                            </div>
                                            <p className="text-xs text-slate-400 mt-2">æ³¨ï¼šè¯¾ç¨‹è¯¾æ—¶è´¹è®¡ç®—å…¬å¼ä¸º `1.5 * åŸºæ•° * (å®é™…æ‰£é™¤è¯¾æ—¶/2)`</p>
                                        </div>
                                    </div>
                                    <div className="pt-8 mt-auto">
                                        <button onClick={handleSave} className={`w-full bg-${theme.primary}-500 text-white py-4 rounded-2xl font-bold text-lg shadow-xl shadow-${theme.primary}-500/30 hover:bg-${theme.primary}-600 hover:scale-[1.02] active:scale-95 transition-all hover-jelly`}>ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
                                    </div>
                                </TiltCard>
        
                                {/* å¡ç‰‡ 2: ä¸ªæ€§åŒ–è¯­å½• (å·²æ¢å¤) */}
                                <TiltCard className="glass-panel p-8 rounded-3xl h-full flex flex-col hover-lift">
                                    <h3 className="font-bold text-xl text-slate-800 dark:text-white mb-8 flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-2xl bg-pink-100 text-pink-600 flex items-center justify-center shadow-inner"><LucideIcon name="Quote" size={22}/></div>
                                        ä¸ªæ€§åŒ–è¯­å½•
                                    </h3>
                                    <div className="space-y-4 flex-1 overflow-y-auto max-h-[400px] custom-scrollbar pr-2">
                                        {(quotes || []).map((q, idx) => (
                                            <div key={idx} className="flex items-center gap-3 group">
                                                <div className="flex-1 bg-white/50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700 text-sm text-slate-700 dark:text-slate-200 shadow-sm italic relative">
                                                    <span className="absolute -top-2 -left-1 text-2xl text-slate-200 dark:text-slate-600">â€œ</span>
                                                    {q}
                                                </div>
                                                <button onClick={() => handleDeleteQuote(idx)} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-all opacity-0 group-hover:opacity-100">
                                                    <LucideIcon name="Trash2" size={16}/>
                                                </button>
                                            </div>
                                        ))}
                                        {(!quotes || quotes.length === 0) && <div className="text-center text-slate-400 text-sm py-4">æš‚æ— è¯­å½•ï¼Œå¿«æ¥æ·»åŠ ä¸€æ¡å§~</div>}
                                    </div>
                                    <div className="pt-6 mt-auto border-t border-slate-100 dark:border-slate-700">
                                        <div className="flex gap-2">
                                            <input 
                                                className="flex-1 border border-slate-200 dark:border-slate-600 p-3 rounded-xl focus:ring-2 focus:ring-pink-200 outline-none transition-all text-sm dark:bg-slate-800 dark:text-white" 
                                                placeholder="è¾“å…¥ä¸€å¥æ¿€åŠ±è¯­..." 
                                                value={newQuote}
                                                onChange={e => setNewQuote(e.target.value)}
                                                onKeyPress={e => e.key === 'Enter' && handleAddQuote()}
                                            />
                                            <button onClick={handleAddQuote} className="bg-pink-500 text-white p-3 rounded-xl hover:bg-pink-600 active:scale-95 transition-all shadow-lg shadow-pink-200 dark:shadow-none">
                                                <LucideIcon name="Plus" size={20}/>
                                            </button>
                                        </div>
                                    </div>
                                </TiltCard>
        
                                {/* å¡ç‰‡ 3: ç‰ˆæœ¬æ›´æ–°è®°å½• */}
                                <TiltCard className="glass-panel p-8 rounded-3xl h-full flex flex-col hover-lift">
                                    <h3 className="font-bold text-xl text-slate-800 dark:text-white mb-8 flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-2xl bg-indigo-100 text-indigo-600 flex items-center justify-center shadow-inner"><LucideIcon name="Cloud" size={22}/></div>
                                        ç³»ç»Ÿæ›´æ–°æ—¥å¿—
                                    </h3>
                                    <div className="space-y-6 flex-1 overflow-y-auto max-h-[400px] custom-scrollbar pr-2">
                                        {UPDATE_HISTORY.map((item, index) => (
                                            <div key={item.version} className={`pb-4 ${index < UPDATE_HISTORY.length - 1 ? 'border-b border-slate-100 dark:border-slate-700' : ''}`}>
                                                <div className="flex items-center justify-between text-sm font-bold mb-1">
                                                    <span className={`text-slate-800 dark:text-white flex items-center gap-2 ${index === 0 ? 'text-lg text-emerald-600 dark:text-emerald-400' : ''}`}>{item.version}</span>
                                                    <span className="text-xs text-slate-400">{item.date}</span>
                                                </div>
                                                <ul className="text-xs text-slate-600 dark:text-slate-300 space-y-1 list-disc list-inside ml-2">
                                                    {item.changes.map((change, i) => <li key={i}>{change}</li>)}
                                                </ul>
                                            </div>
                                        ))}
                                    </div>
                                </TiltCard>
        
                                {/* å¡ç‰‡ 4: æ•°æ®å¤‡ä»½ (è·¨ 2 åˆ—) */}
                                <TiltCard className="glass-panel p-8 rounded-3xl h-full flex flex-col hover-lift lg:col-span-2 xl:col-span-3">
                                    <h3 className="font-bold text-xl text-slate-800 dark:text-white mb-8 flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-2xl bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300 flex items-center justify-center shadow-inner"><LucideIcon name="Database" size={22}/></div>
                                        æ•°æ®å®‰å…¨ä¸­å¿ƒ
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-white/60 dark:bg-slate-800/60 rounded-2xl p-6 border border-slate-100 dark:border-slate-700 hover:border-blue-300 dark:hover:border-blue-500 transition-all group cursor-pointer shadow-sm hover:shadow-md" onClick={handleExport}>
                                            <div className="flex items-center gap-5 mb-4">
                                                <div className="w-12 h-12 bg-blue-500 text-white rounded-full shadow-lg shadow-blue-500/30 flex items-center justify-center group-hover:scale-110 transition-transform"><LucideIcon name="Download" size={24}/></div>
                                                <div>
                                                    <div className="font-bold text-slate-800 dark:text-white text-lg">å¯¼å‡ºå…¨ç«™å¤‡ä»½</div>
                                                    <div className="text-xs text-slate-500 dark:text-slate-400 mt-1">ç”ŸæˆåŒ…å«æ‰€æœ‰å­¦å‘˜ã€è¯¾ç¨‹è®°å½•çš„ JSON æ–‡ä»¶</div>
                                                </div>
                                            </div>
                                            <div className="flex justify-end">
                                                <span className="text-xs font-bold text-blue-500 bg-blue-50 dark:bg-blue-900 dark:text-blue-300 px-3 py-1.5 rounded-full group-hover:bg-blue-100 dark:group-hover:bg-blue-800 transition-colors">ç«‹å³ä¸‹è½½</span>
                                            </div>
                                        </div>
                                        <div className="bg-white/60 dark:bg-slate-800/60 rounded-2xl p-6 border border-slate-100 dark:border-slate-700 hover:border-green-300 dark:hover:border-green-500 transition-all group relative shadow-sm hover:shadow-md">
                                            <div className="flex items-center gap-5 mb-4">
                                                <div className="w-12 h-12 bg-green-500 text-white rounded-full shadow-lg shadow-green-500/30 flex items-center justify-center group-hover:scale-110 transition-transform"><LucideIcon name="UploadCloud" size={24}/></div>
                                                <div>
                                                    <div className="font-bold text-slate-800 dark:text-white text-lg">æ¢å¤å†å²æ•°æ®</div>
                                                    <div className="text-xs text-slate-500 dark:text-slate-400 mt-1">ä¸Šä¼ å¤‡ä»½æ–‡ä»¶è¦†ç›–å½“å‰ç³»ç»Ÿæ•°æ®</div>
                                                </div>
                                            </div>
                                            <div className="relative">
                                                <input type="file" accept=".json" onChange={handleImport} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" disabled={false} /> 
                                                <div className="flex justify-end">
                                                    <span className="text-xs font-bold text-green-500 bg-green-50 dark:bg-green-900 dark:text-green-300 px-3 py-1.5 rounded-full group-hover:bg-green-100 dark:group-hover:bg-green-800 transition-colors flex items-center gap-2">{'ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶'}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="mt-8 text-xs text-amber-700/80 dark:text-amber-300 bg-amber-50/80 dark:bg-amber-900/20 p-4 rounded-2xl border border-amber-100/50 dark:border-amber-800/30 flex gap-3 items-start">
                                        <LucideIcon name="AlertCircle" size={18} className="shrink-0 mt-0.5"/>
                                        <span className="leading-relaxed">å®‰å…¨æç¤ºï¼šæ¢å¤æ“ä½œå°†æ™ºèƒ½åˆå¹¶æ•°æ®ã€‚å»ºè®®åœ¨æ‰§è¡Œæ¢å¤å‰ï¼Œå…ˆæ‰‹åŠ¨ç‚¹å‡»â€œå¯¼å‡ºå¤‡ä»½â€ä»¥é˜²ä¸‡ä¸€ã€‚</span>
                                    </div>
                                </TiltCard>
                            </div>
                        </div>
                    )
                }
        
        
       // 0. ä»ªè¡¨ç›˜ (ä¿®å¤ç»Ÿè®¡é€»è¾‘ï¼šæ’é™¤è¡¥è¯¾è¯¾ç¨‹)
               // 0. ä»ªè¡¨ç›˜ (å·²ä¿®æ”¹ï¼šè¡¥è¯¾å¼¹çª—é€»è¾‘ä¸è¯¾ç¨‹ç®¡ç†ä¸€è‡´)
               const Dashboard = () => {
                   const { 
                       students, courses, classGroups, followUps, theme, formatDate, 
                       teacherLevel, classFeeBase, loading, quotes, showTodayIncome,
                       lcUpdate, fetchAll, getPredictionText
                   } = useAppData();
                   const addToast = useToast(); 
               
                   const [greeting, setGreeting] = useState({ text: "æ—©å®‰", icon: "Sun" });
                   const [quote, setQuote] = useState("");
                   const [editCourse, setEditCourse] = useState(null);
                   const [isModalOpen, setIsModalOpen] = useState(false);
               
                   useEffect(() => {
                       const h = new Date().getHours();
                       if (h < 5) setGreeting({ text: "æ·±å¤œå¥½", icon: "Moon" }); else if (h < 11) setGreeting({ text: "æ—©ä¸Šå¥½", icon: "Sun" }); else if (h < 14) setGreeting({ text: "ä¸­åˆå¥½", icon: "Sun" }); else if (h < 19) setGreeting({ text: "ä¸‹åˆå¥½", icon: "Coffee" }); else setGreeting({ text: "æ™šä¸Šå¥½", icon: "Moon" });
                       const currentQuotes = (quotes && quotes.length > 0) ? quotes : DEFAULT_QUOTES;
                       setQuote(currentQuotes[Math.floor(Math.random() * currentQuotes.length)]);
                   }, [quotes]);
               
                   const handleCourseClick = (c) => { setEditCourse(JSON.parse(JSON.stringify(c))); setIsModalOpen(true); };
                   
                   // å¸¸è§„è¯¾/Demoè¯¾çš„ä»»åŠ¡åˆ‡æ¢
                   const toggleTask = (taskId) => { setEditCourse(prev => { const tasks = prev.tasks || {}; return { ...prev, tasks: { ...tasks, [taskId]: !tasks[taskId] } }; }); };
                   
                   // å¸¸è§„è¯¾/Demoè¯¾çš„è€ƒå‹¤åˆ‡æ¢ (æš‚å­˜çŠ¶æ€ï¼Œç‚¹å‡»ä¿å­˜æ—¶æäº¤)
                   const toggleAttendance = (sid, status) => { setEditCourse(prev => { const att = { ...(prev.attendance || {}) }; const current = att[sid] || {}; if (current.status === status) { delete att[sid]; } else { att[sid] = { studentId: sid, status: status, isMadeUp: current.isMadeUp || false }; } return { ...prev, attendance: att }; }); };
               
                   // --- æ–°å¢ï¼šè¡¥è¯¾ä¸“å±å¤„ç†é€»è¾‘ (å³æ—¶ç”Ÿæ•ˆ) ---
                   const handleMakeupAction = async (sid) => {
                       if (!editCourse) return;
                       
                       const currentStatus = editCourse.attendance?.[sid]?.status;
                       const isCheckingIn = currentStatus !== 'present'; // å¦‚æœå½“å‰ä¸æ˜¯presentï¼Œåˆ™æ“ä½œæ˜¯â€œç­¾åˆ°â€
                       const hours = editCourse.hoursDeducted || 2; // è·å–è¯¾ç¨‹è®¾å®šçš„è¯¾æ—¶æ•°
               
                       const actionName = isCheckingIn ? "ç¡®è®¤å·²è¡¥è¯¾" : "å–æ¶ˆè¡¥è¯¾çŠ¶æ€";
                       
                       showConfirmModal(`ç¡®è®¤${actionName}ï¼Ÿ\n${isCheckingIn ? `ç³»ç»Ÿå°†æ‰£é™¤å­¦å‘˜ ${hours} è¯¾æ—¶ï¼Œå¹¶å°†åŸç¼ºå‹¤è®°å½•æ ‡è®°ä¸ºâ€œå·²è¡¥â€ã€‚` : `ç³»ç»Ÿå°†è¿”è¿˜ ${hours} è¯¾æ—¶ï¼Œå¹¶æ’¤é”€åŸç¼ºå‹¤è®°å½•çš„â€œå·²è¡¥â€çŠ¶æ€ã€‚`}`, async () => {
                           // 1. æ›´æ–°å­¦å‘˜ä½™é¢
                           const student = students.find(s => s.id === sid);
                           if (student) {
                               const delta = isCheckingIn ? -hours : hours;
                               await lcUpdate('Student', sid, { remainingHours: (student.remainingHours || 0) + delta }, true);
                           }
               
                           // 2. æ›´æ–°åŸç¼ºå‹¤è¯¾ç¨‹çš„çŠ¶æ€ (isMadeUp)
                           const map = editCourse.makeupMap || {};
                           const originalCid = map[sid];
                           if (originalCid) {
                               const targetCourse = courses.find(c => c.id === originalCid);
                               if (targetCourse && targetCourse.attendance && targetCourse.attendance[sid]) {
                                   const updatedAtt = {
                                       ...targetCourse.attendance,
                                       [sid]: { ...targetCourse.attendance[sid], isMadeUp: isCheckingIn } 
                                   };
                                   await lcUpdate('Course', originalCid, { attendance: updatedAtt }, true);
                               }
                           }
               
                           // 3. æ›´æ–°å½“å‰è¡¥è¯¾è¯¾ç¨‹çš„çŠ¶æ€
                           const newAtt = { ...(editCourse.attendance || {}) };
                           if (isCheckingIn) newAtt[sid] = { studentId: sid, status: 'present' };
                           else delete newAtt[sid];
                           
                           // æäº¤æ›´æ–°
                           await lcUpdate('Course', editCourse.id, { attendance: newAtt }, true);
                           
                           // 4. åˆ·æ–°æœ¬åœ°çŠ¶æ€å’Œå…¨å±€æ•°æ®
                           setEditCourse(prev => ({ ...prev, attendance: newAtt }));
                           await fetchAll();
                           addToast("æ“ä½œæˆåŠŸ", "success");
                       });
                   };
               
                   // å¸¸è§„è¯¾/Demoè¯¾çš„ä¿å­˜é€»è¾‘
                   const handleSaveCourse = async () => { 
                       if (!editCourse) return; 
                       const originalCourse = courses.find(c => c.id === editCourse.id); 
                       if (!originalCourse) return; 
                       
                       const hours = originalCourse.hoursDeducted || 2; 
                       const studentUpdates = {}; 
                       
                       if (editCourse.type !== 'demo' && editCourse.type !== 'makeup') { // æ’é™¤ makeupï¼Œå› ä¸º makeup èµ°å•ç‹¬é€»è¾‘
                           const newAtt = editCourse.attendance || {}; 
                           const oldAtt = originalCourse.attendance || {}; 
                           (editCourse.studentIds || []).forEach(sid => { 
                               const newStatus = newAtt[sid]?.status; 
                               const oldStatus = oldAtt[sid]?.status; 
                               const isMadeUp = oldAtt[sid]?.isMadeUp; 
                               if (!isMadeUp) { 
                                   if (newStatus === 'present' && oldStatus !== 'present') { studentUpdates[sid] = -hours; } 
                                   else if (newStatus !== 'present' && oldStatus === 'present') { studentUpdates[sid] = hours; } 
                               } 
                           }); 
                       } 
                       
                       const { id, ...updateData } = editCourse; 
                       const success = await lcUpdate('Course', id, { tasks: updateData.tasks, attendance: updateData.attendance }, true); 
                       
                       if (success) { 
                           for (const [sid, delta] of Object.entries(studentUpdates)) { 
                               const student = students.find(s => s.id === sid); 
                               if (student) { 
                                   const newHours = (student.remainingHours || 0) + delta; 
                                   await lcUpdate('Student', sid, { remainingHours: newHours }, true); 
                                   const msg = delta < 0 ? `æ‰£é™¤ ${student.name} ${Math.abs(delta)} è¯¾æ—¶` : `è¿”è¿˜ ${student.name} ${delta} è¯¾æ—¶`; 
                                   addToast(msg, delta < 0 ? 'success' : 'info'); 
                               } 
                           } 
                           await fetchAll(); 
                           setIsModalOpen(false); 
                           addToast("è¯¾ç¨‹è¿›åº¦å·²æ›´æ–°", "success"); 
                       } 
                   };
               
                   // ... (ç»Ÿè®¡é€»è¾‘ä¿æŒä¸å˜) ...
                   const LEVEL_SALARY = LEVEL_SALARY_MAP[teacherLevel] || LEVEL_SALARY_MAP['é»˜è®¤'];
                   const SALARY = { base: 1000, level: LEVEL_SALARY, performance: 500, transport: 100, phone: 50, housing: 280, lunchPerDay: 20, lunchMax: 440, demoFee: 40 };
                   const FIXED_TOTAL = SALARY.base + SALARY.level + SALARY.performance + SALARY.transport + SALARY.phone + SALARY.housing;
                   const isWorkingDay = (d) => { const day = d.getDay(); return day === 0 || (day >= 3 && day <= 6); };
                   const now = new Date();
                   const currentMonthStr = formatDate(now).slice(0, 7);
                   const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                   const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                   let workingDaysCount = 0; for (let i = 1; i <= daysInMonth; i++) { if (isWorkingDay(new Date(now.getFullYear(), now.getMonth(), i))) { workingDaysCount++; } }
                   const fixedPerDay = workingDaysCount > 0 ? FIXED_TOTAL / workingDaysCount : 0;
                   const todayStr = formatDate(now);
                   const todayCourses = courses.filter(c => c.dateStr === todayStr).sort((a,b)=>a.startTime.localeCompare(b.startTime));
                   const classFeeRate = 1.5 * (classFeeBase || 0); 
                   const todayRegularIncome = todayCourses.filter(c => c.type !== 'demo').reduce((acc, c) => { let validCount = 0; const hours = c.hoursDeducted || 2; const atts = c.attendance || {}; Object.values(atts).forEach(record => { if (record.status === 'present' && c.studentIds?.includes(record.studentId) && !record.isMadeUp) { validCount++; } }); return acc + (validCount * classFeeRate * hours / 2); }, 0);
                   const todayDemoIncome = todayCourses.filter(c => c.type === 'demo') .reduce((acc, c) => acc + SALARY.demoFee, 0);
                   const todayTotalClassFee = todayRegularIncome + todayDemoIncome;
                   const isTodayWorking = isWorkingDay(now);
                   const todayLunch = isTodayWorking ? SALARY.lunchPerDay : 0;
                   const todayBase = isTodayWorking ? fixedPerDay : 0;
                   const todayTotalIncome = todayTotalClassFee + todayLunch + todayBase; 
                   const monthCourses = courses.filter(c => c.dateStr.startsWith(currentMonthStr));
                   let actualRegularHours = 0; let actualClassFee = 0; let pendingForecastFee = 0; 
                   monthCourses.forEach(c => { const hours = c.hoursDeducted || 2; const rateHours = hours / 2; if (c.tasks?.teachingDone) { if (c.type === 'demo') { actualClassFee += SALARY.demoFee; } else { let validStudentCount = 0; const atts = c.attendance || {}; (c.studentIds || []).forEach(sid => { const record = atts[sid]; if (record && (record.status === 'present' || record.isMadeUp)) { validStudentCount++; } }); actualRegularHours += (validStudentCount * hours); actualClassFee += (validStudentCount * classFeeRate * rateHours); } } else { if (c.type === 'demo') { pendingForecastFee += SALARY.demoFee; } else { const count = c.studentIds?.length || 0; pendingForecastFee += (count * classFeeRate * rateHours); } } });
                   const monthRegularHours = actualRegularHours; 
                   const monthClassFee = actualClassFee; 
                   const monthLunch = workingDaysCount * SALARY.lunchPerDay; 
                   const monthTotalEstimated = FIXED_TOTAL + monthLunch + actualClassFee;
                   const getStats = (dateObj) => { const mStr = formatDate(dateObj).slice(0, 7); const followUpTarget = students.length * 2; const followUpDone = followUps.filter(f => f.monthStr === mStr).reduce((acc, f) => acc + (f.count || 0), 0); const followUpRate = followUpTarget > 0 ? (followUpDone / followUpTarget) * 100 : 0; const mCourses = courses.filter(c => c.dateStr.startsWith(mStr) && c.type !== 'demo' && c.type !== 'makeup'); let expectedAtt = 0, actualAtt = 0; mCourses.forEach(c => { expectedAtt += (c.studentIds?.length || 0); if (c.attendance) Object.values(c.attendance).forEach(v => { if (v.status === 'present' || v.isMadeUp) actualAtt++; }); }); const attendanceRate = expectedAtt > 0 ? (actualAtt / expectedAtt) * 100 : 0; return { followUpRate, attendanceRate }; };
                   const thisMonthStats = getStats(now);
                   const lastMonthStats = getStats(lastMonthDate);
                   const getStudentGrowth = () => { const startOfThisMonth = new Date(now.getFullYear(), now.getMonth(), 1); const currentTotal = students.length; const newStudentsThisMonth = students.filter(s => s.createdAt && new Date(s.createdAt) >= startOfThisMonth).length; return { current: currentTotal, prev: currentTotal - newStudentsThisMonth }; };
                   const studentStats = getStudentGrowth();
                   const Trend = ({ curr, prev, isPercent }) => { const diff = curr - prev; const isUp = diff >= 0; let valStr = ''; if (isPercent) { valStr = `${Math.abs(diff).toFixed(1)}%`; } else { const percentageChange = prev === 0 ? (curr > 0 ? 100 : 0) : ((diff / prev) * 100); valStr = `${Math.abs(percentageChange).toFixed(1)}%`; } const color = isUp ? "text-emerald-600 bg-emerald-100 dark:bg-emerald-900/30 dark:text-emerald-400" : "text-rose-500 bg-rose-100 dark:bg-rose-900/30 dark:text-rose-400"; const arrow = isUp ? "â†‘" : "â†“"; return <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ml-2 inline-flex items-center gap-0.5 ${color}`}>{arrow} {valStr}</span>; };
                   const HiddenIncomeCard = () => ( <TiltCard className="glass-panel p-6 rounded-3xl flex flex-col justify-center items-center h-full hover-lift group"> <LucideIcon name="Wallet" size={32} className={`text-${theme.primary}-500 mb-2 opacity-50`}/> <div className="text-xl font-bold text-slate-800 dark:text-white">ä»Šæ—¥æ”¶å…¥å·²éšè—</div> <div className="text-xs text-slate-400 mt-1">è¯·åœ¨â€œç³»ç»Ÿè®¾ç½®â€ä¸­å¼€å¯æ˜¾ç¤º</div> </TiltCard> );
                   const IncomeCard = () => ( <TiltCard className={`col-span-1 md:col-span-2 bg-gradient-to-br from-${theme.primary}-500 to-${theme.primary}-700 rounded-3xl p-6 text-white shadow-xl shadow-${theme.primary}-500/30 relative overflow-hidden group`}> <div className="relative z-10 flex flex-col h-full justify-between"> <div className="flex justify-between items-start"> <div> <div className="flex items-center gap-2 opacity-90 text-xs font-bold mb-1 uppercase tracking-wider"> <LucideIcon name="Wallet" size={14}/> ä»Šæ—¥æ€»æ”¶å…¥ </div> <div className="text-4xl font-extrabold tracking-tight"> Â¥{todayTotalIncome.toFixed(2)} </div> </div> <div className="text-right opacity-80"> <div className="text-xs font-bold">{todayStr}</div> <div className="text-[10px] mt-0.5">{isTodayWorking ? 'å·¥ä½œæ—¥' : 'ä¼‘æ¯æ—¥'}</div> </div> </div> <div className="mt-8 grid grid-cols-3 gap-2 text-center border-t border-white/20 pt-4"> <div> <div className="text-xs opacity-70 uppercase tracking-wider mb-1">è¯¾æ—¶è´¹</div> <div className="text-xl font-bold">Â¥{todayTotalClassFee.toFixed(0)}</div> </div> <div> <div className="text-xs opacity-70 uppercase tracking-wider mb-1">åº•è–ªæ‘Š</div> <div className="text-xl font-bold">Â¥{todayBase.toFixed(0)}</div> </div> <div> <div className="text-xs opacity-70 uppercase tracking-wider mb-1">é¤è¡¥</div> <div className="text-xl font-bold">Â¥{todayLunch}</div> </div> </div> </div> <div className="absolute -right-6 -bottom-6 opacity-10 transform group-hover:scale-110 transition-transform duration-700 rotate-12"><LucideIcon name="Coins" size={160}/></div> </TiltCard> );
                   const QualityCard = () => ( <TiltCard className="glass-panel p-6 rounded-3xl flex flex-col justify-between relative overflow-hidden hover-lift group"> <div className="flex justify-between items-center mb-4 border-b border-gray-100 dark:border-slate-700 pb-2"> <div className="flex items-center gap-2 text-sm font-bold text-slate-700 dark:text-slate-200"><LucideIcon name="Activity" size={16} className="text-indigo-500"/> æ•™å­¦è´¨é‡</div> </div> <div className="space-y-4"> <div> <div className="flex justify-between items-center mb-1"> <span className="text-xs text-slate-500 dark:text-slate-400">å›è®¿ç‡</span> <Trend curr={thisMonthStats.followUpRate} prev={lastMonthStats.followUpRate} isPercent={true} /> </div> <div className="flex items-end gap-2"> <span className="text-lg font-bold text-slate-800 dark:text-white">{thisMonthStats.followUpRate.toFixed(0)}%</span> <div className="flex-1 h-1.5 bg-gray-100 dark:bg-slate-700 rounded-full mb-1.5 overflow-hidden"> <div className="h-full bg-emerald-500 rounded-full" style={{width: `${thisMonthStats.followUpRate}%`}}></div> </div> </div> </div> <div> <div className="flex justify-between items-center mb-1"> <span className="text-xs text-slate-500 dark:text-slate-400">å‡ºå‹¤ç‡</span> <Trend curr={thisMonthStats.attendanceRate} prev={lastMonthStats.attendanceRate} isPercent={true} /> </div> <div className="flex items-end gap-2"> <span className="text-lg font-bold text-slate-800 dark:text-white">{thisMonthStats.attendanceRate.toFixed(0)}%</span> <div className="flex-1 h-1.5 bg-gray-100 dark:bg-slate-700 rounded-full mb-1.5 overflow-hidden"> <div className="h-full bg-blue-500 rounded-full" style={{width: `${thisMonthStats.attendanceRate}%`}}></div> </div> </div> </div> </div> </TiltCard> );
               
                   return (
                       <div className="p-6 md:p-10 space-y-8 pb-24 md:pb-10 pt-20 md:pt-10 animate-enter max-w-7xl mx-auto">
                           {/* Header */}
                           <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 mb-6">
                               <div><h1 className="text-4xl font-extrabold text-slate-800 dark:text-white tracking-tight flex items-center gap-3">{greeting.text} <LucideIcon name={greeting.icon} className={`text-${theme.accent}-500 animate-float`}/></h1><p className="text-slate-500 dark:text-slate-400 mt-2 font-medium text-lg">{quote}</p></div>
                               <div className="glass-panel px-5 py-2 rounded-2xl flex items-center gap-4 shadow-sm"><div className="text-right"><div className="text-2xl font-bold text-slate-800 dark:text-white tracking-tighter">{new Date().getDate()}</div><div className="text-xs text-slate-400 dark:text-slate-500 font-bold uppercase tracking-wider">{new Date().toLocaleString('default', { month: 'long' })}</div></div><div className={`h-8 w-1 bg-${theme.primary}-400 rounded-full`}></div><div className="text-sm font-bold text-slate-600 dark:text-slate-300">{isTodayWorking ? 'å·¥ä½œæ—¥' : 'ä¼‘æ¯æ—¥'}</div></div>
                           </div>
                           {loading ? (<div className="grid grid-cols-1 md:grid-cols-4 gap-6">{[1,2,3,4].map(i => <Skeleton key={i} className="h-40 rounded-3xl" />)}<Skeleton className="md:col-span-2 h-96 rounded-3xl" /><Skeleton className="h-96 rounded-3xl" /></div>) : (
                           <>
                           <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                               {showTodayIncome ? <div className="col-span-1 md:col-span-2"><IncomeCard /></div> : <div className="col-span-1 md:col-span-2"><HiddenIncomeCard /></div>}
                               <TiltCard className="glass-panel p-6 rounded-3xl flex flex-col justify-between relative overflow-hidden hover-lift group"><div className="flex justify-between items-start mb-4"><div className={`p-3 rounded-2xl bg-${theme.accent}-50 text-${theme.accent}-500`}><LucideIcon name="Users" size={24}/></div><Trend curr={studentStats.current} prev={studentStats.prev} /></div><div><div className="text-3xl font-bold text-slate-800 dark:text-white">{studentStats.current}</div><div className="text-xs text-slate-400 font-bold mt-1 uppercase tracking-wider">åœ¨è¯»å­¦å‘˜æ€»æ•°</div></div></TiltCard>
                               <QualityCard />
                           </div>
                           <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                               <div className="lg:col-span-2 glass-panel rounded-3xl p-8 flex flex-col h-[500px]">
                                   <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-xl text-slate-800 dark:text-white flex items-center gap-3"><div className={`w-8 h-8 rounded-lg bg-${theme.primary}-100 text-${theme.primary}-600 dark:bg-slate-700 dark:text-white flex items-center justify-center`}><LucideIcon name="Calendar" size={18}/></div>ä»Šæ—¥è¯¾ç¨‹</h3><span className="text-xs font-bold bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 px-3 py-1 rounded-full">{todayCourses.length} èŠ‚</span></div>
                                   <div className="flex-1 overflow-y-auto space-y-4 custom-scrollbar pr-2 -mr-2">{todayCourses.length > 0 ? todayCourses.map(c => {
                                       // ä¿®æ­£ï¼šè¡¥è¯¾ç±»å‹æ˜¾ç¤ºé€»è¾‘ä¼˜åŒ–
                                       const isMakeup = c.type === 'makeup';
                                       return (
                                       <div key={c.id} onClick={() => handleCourseClick(c)} className={`group flex items-center p-4 rounded-2xl border transition-all duration-300 cursor-pointer ${c.type==='demo' ? 'bg-purple-50/50 border-purple-100 dark:bg-purple-900/20 dark:border-purple-800 hover:border-purple-200' : isMakeup ? 'bg-orange-50/50 border-orange-100 dark:bg-orange-900/20 dark:border-orange-800 hover:border-orange-200' : 'bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700 hover:border-blue-200'} hover:shadow-md`}>
                                           <div className={`w-14 h-14 rounded-2xl flex flex-col items-center justify-center text-sm font-bold mr-5 shrink-0 shadow-sm ${c.type==='demo' ? 'bg-white dark:bg-slate-700 text-purple-600 dark:text-purple-400' : isMakeup ? 'bg-white dark:bg-slate-700 text-orange-600 dark:text-orange-400' : `bg-${theme.primary}-50 dark:bg-slate-700 text-${theme.primary}-600 dark:text-white`}`}>
                                               <span>{c.startTime.split(':')[0]}</span><span className="text-[10px] opacity-60">:{c.startTime.split(':')[1]}</span>
                                           </div>
                                           <div className="flex-1 min-w-0">
                                               <div className="font-bold text-slate-800 dark:text-white text-base flex items-center gap-2 truncate">
                                                   {c.className}
                                                   {c.type==='demo' && <span className="bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 text-[10px] px-2 py-0.5 rounded-full font-extrabold tracking-wide">DEMO</span>}
                                                   {isMakeup && <span className="bg-orange-100 dark:bg-orange-900 text-orange-600 dark:text-orange-300 text-[10px] px-2 py-0.5 rounded-full font-extrabold tracking-wide">è¡¥è¯¾</span>}
                                               </div>
                                               <div className="text-xs text-slate-500 dark:text-slate-400 mt-1 flex items-center gap-3 font-medium">
                                                   <span className="flex items-center gap-1"><LucideIcon name="Clock" size={12}/> {c.startTime}-{c.endTime}</span>
                                                   {c.type !== 'demo' && (<span className="flex items-center gap-1"><LucideIcon name="Users" size={12}/><span className="flex items-center text-[10px] sm:text-xs"><span className="text-slate-500">åº”åˆ°{c.studentIds?.length||0}</span><span className="mx-1 text-slate-300">/</span><span className={Object.values(c.attendance || {}).filter(a => a.status === 'present' || a.isMadeUp).length < (c.studentIds?.length||0)? "text-rose-500 font-bold": "text-emerald-600 font-bold"}>å®åˆ°{Object.values(c.attendance || {}).filter(a => a.status === 'present' || a.isMadeUp).length}</span></span></span>)}
                                                   {c.type === 'demo' && <span className="text-purple-500 dark:text-purple-400">è¯•å¬è¯¾</span>}
                                               </div>
                                           </div>
                                           <div className="text-right pl-4 border-l border-slate-100 dark:border-slate-700 ml-4">
                                               <div className={`text-sm font-extrabold ${c.type==='demo'?'text-purple-600 dark:text-purple-400':isMakeup ? 'text-orange-600 dark:text-orange-400' : `text-${theme.primary}-600 dark:text-blue-400`}`}>
                                                   +Â¥{c.type === 'demo' ? SALARY.demoFee : (Object.values(c.attendance || {}).filter(a => a.status === 'present').length * classFeeRate).toFixed(1)}
                                               </div>
                                               <div className={`mt-1.5 px-2.5 py-0.5 rounded-md text-[10px] font-bold inline-block ${c.tasks?.teachingDone ? 'bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300' : 'bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300'}`}>
                                                   {c.tasks?.teachingDone ? 'å·²ç»“è¯¾' : 'å¾…ä¸Šè¯¾'}
                                               </div>
                                           </div>
                                       </div>)}) : (<div className="h-full flex flex-col items-center justify-center text-slate-400"><div className="w-20 h-20 bg-slate-50 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4"><LucideIcon name="Coffee" size={32} className="opacity-50"/></div><span className="font-medium">ä»Šå¤©æ²¡æœ‰è¯¾ç¨‹å®‰æ’ï¼Œå¥½å¥½ä¼‘æ¯ä¸€ä¸‹å§~</span></div>)}
                                   </div>
                               </div>
                               <div className="flex flex-col gap-6 h-full">
                                   <div className="glass-panel rounded-3xl p-8 flex-1 flex flex-col"><h3 className="font-bold text-lg text-slate-800 dark:text-white mb-6 flex items-center gap-3"><div className={`w-8 h-8 rounded-lg bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 flex items-center justify-center`}><LucideIcon name="PieChart" size={18}/></div>æœ¬æœˆç»©æ•ˆ</h3><div className="space-y-5 flex-1"><div className="bg-white dark:bg-slate-800 p-5 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition-shadow group"><div className="flex justify-between items-center"><div><div className="text-xs text-slate-400 font-bold mb-1 uppercase tracking-wider">ç´¯è®¡å¸¸è§„è¯¾æ—¶</div><div className="text-3xl font-bold text-slate-800 dark:text-white group-hover:text-blue-600 transition-colors">{monthRegularHours.toFixed(1)} <span className="text-sm font-normal text-slate-400">è¯¾æ—¶</span></div></div><div className="w-12 h-12 bg-blue-50 dark:bg-blue-900/20 rounded-2xl text-blue-500 flex items-center justify-center"><LucideIcon name="Clock" size={24}/></div></div></div><div className="bg-white dark:bg-slate-800 p-5 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition-shadow group"><div className="flex justify-between items-center"><div><div className="text-xs text-slate-400 font-bold mb-1 uppercase tracking-wider">å·²ç»“ç®—è¯¾æ—¶è´¹</div><div className="text-3xl font-bold text-slate-800 dark:text-white group-hover:text-orange-500 transition-colors">Â¥{monthClassFee.toFixed(0)}</div></div><div className="w-12 h-12 bg-orange-50 dark:bg-orange-900/20 rounded-2xl text-orange-500 flex items-center justify-center"><LucideIcon name="Coins" size={24}/></div></div></div><div className="bg-slate-50 dark:bg-slate-800/50 p-5 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-inner"><div className="flex justify-between items-center mb-2"><div className="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase tracking-wider">æœ¬æœˆè–ªèµ„é¢„æµ‹ (ç¨å‰)</div><div className="text-2xl font-extrabold text-slate-800 dark:text-white tracking-tight">Â¥{monthTotalEstimated.toFixed(0)}</div><div className="text-xs bg-white dark:bg-slate-700 px-2 py-0.5 rounded border dark:border-slate-600 text-slate-400 font-mono">{workingDaysCount}å·¥ä½œæ—¥</div></div>
                                   
                                   <div className="mt-3 text-xs text-slate-500 dark:text-slate-400">
                                       ç»„æˆ: å›ºå®šæ€»é¢(Â¥{FIXED_TOTAL}) + é¤è¡¥(Â¥{monthLunch}) + è¯¾æ—¶è´¹(Â¥{monthClassFee.toFixed(0)})
                                   </div>
               
                                   <div className="w-full h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mt-3 overflow-hidden"><div className="h-full bg-slate-400" style={{width: '60%'}}></div></div></div></div><div className="mt-6 pt-4 border-t border-slate-200/50 dark:border-slate-700 text-[10px] text-slate-400 flex justify-between items-center"><span className="font-mono bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded">Rate: Â¥{classFeeBase}/h</span><span>å«å¸¸è§„ + Demo</span></div></div>
                                   <TiltCard className="glass-panel rounded-3xl p-6 flex items-center justify-between hover-lift cursor-default"><div><div className="text-xs text-slate-400 font-bold mb-1 uppercase tracking-wider">å½“å‰èŒçº§</div><div className="text-lg font-bold text-slate-800 dark:text-white">{teacherLevel}</div><div className="text-xs text-slate-400 mt-1">å²—ä½å·¥èµ„: Â¥{SALARY.level}</div></div><div className="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-500 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-orange-500/30"><LucideIcon name="Award" size={24}/></div></TiltCard>
                               </div>
                           </div>
                           </>)}
                           
                           {/* Modal: æ ¹æ® editCourse.type æ¸²æŸ“ä¸åŒå†…å®¹ */}
                           <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="è¯¾ç¨‹å¿«æ·æ“ä½œ"> 
                               {editCourse && (
                                   <div className="space-y-6"> 
                                       {/* è¯¾ç¨‹å¤´éƒ¨ä¿¡æ¯ */}
                                       <div className={`flex items-center justify-between p-4 rounded-2xl border ${editCourse.type === 'makeup' ? 'bg-orange-50 dark:bg-orange-900/30 border-orange-100 dark:border-orange-800' : 'bg-gray-50 dark:bg-slate-700/50 border-gray-100 dark:border-slate-600'}`}> 
                                           <div> 
                                               <div className="text-lg font-extrabold text-slate-800 dark:text-white flex items-center gap-2"> 
                                                   {editCourse.className} 
                                                   {editCourse.type === 'demo' && <span className="bg-purple-100 text-purple-600 text-[10px] px-2 py-0.5 rounded-full">DEMO</span>} 
                                                   {editCourse.type === 'makeup' && <span className="bg-orange-100 text-orange-600 text-[10px] px-2 py-0.5 rounded-full">è¡¥è¯¾</span>}
                                               </div> 
                                               <div className="text-xs text-slate-500 dark:text-slate-400 mt-1 flex items-center gap-2"> 
                                                   <LucideIcon name="Clock" size={14}/> {editCourse.startTime} - {editCourse.endTime} 
                                               </div> 
                                           </div> 
                                           <div className="text-right"> 
                                               <div className="text-xs text-slate-400 uppercase font-bold mb-1">é¢„è®¡è¯¾é…¬</div> 
                                               <div className={`text-xl font-bold ${editCourse.type==='demo'?'text-purple-600': editCourse.type==='makeup'?'text-orange-600':'text-blue-600'}`}> 
                                                   Â¥{editCourse.type === 'demo' ? 40 : (Object.values(editCourse.attendance || {}).filter(a => a.status === 'present').length * (classFeeBase * 1.5)).toFixed(1)} 
                                               </div> 
                                           </div> 
                                       </div> 
                                       
                                       {/* åˆ†æ”¯æ¸²æŸ“ï¼šè¡¥è¯¾æ¨¡å¼ VS å¸¸è§„æ¨¡å¼ */}
                                       {editCourse.type === 'makeup' ? (
                                           // === è¡¥è¯¾ä¸“å±ç•Œé¢ ===
                                           <div className="space-y-4">
                                               <div className="text-sm font-bold text-slate-600 dark:text-slate-300 mb-3 flex items-center gap-2">
                                                   <LucideIcon name="UserCheck" size={16}/> å­¦å‘˜ç­¾åˆ°ä¸æ‰£è´¹
                                               </div>
                                               {editCourse.studentIds?.map(sid => {
                                                   const st = students.find(s=>s.id===sid);
                                                   const status = editCourse.attendance?.[sid]?.status;
                                                   return st ? (
                                                       <div key={sid} className="flex justify-between items-center bg-white dark:bg-slate-800 p-3 rounded-xl border border-gray-100 dark:border-slate-700">
                                                           <div className="flex items-center gap-3">
                                                               <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-white ${status === 'present' ? 'bg-green-500' : 'bg-gray-300 dark:bg-slate-600'}`}>
                                                                   {st.name[0]}
                                                               </div>
                                                               <div>
                                                                   <div className="font-bold text-sm text-gray-800 dark:text-white">{st.name}</div>
                                                                   <div className="text-[10px] text-gray-400">å‰©ä½™: {st.remainingHours} è¯¾æ—¶</div>
                                                               </div>
                                                           </div>
                                                           <button 
                                                               onClick={() => handleMakeupAction(sid)} 
                                                               className={`px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 shadow-md ${status === 'present' ? 'bg-green-50 text-green-600 border border-green-200' : 'bg-orange-500 text-white hover:bg-orange-600 hover:scale-105 active:scale-95'}`}
                                                           >
                                                               {status === 'present' ? <><LucideIcon name="Check" size={14}/> å·²è¡¥è¯¾</> : "ç¡®è®¤åˆ°è¯¾"}
                                                           </button>
                                                       </div>
                                                   ) : null;
                                               })}
                                               <div className="text-xs text-gray-400 text-center pt-2">ç‚¹å‡»â€œç¡®è®¤åˆ°è¯¾â€å°†è‡ªåŠ¨æ‰£é™¤è¯¾æ—¶å¹¶æ›´æ–°åŸç¼ºå‹¤è®°å½•çŠ¶æ€</div>
                                               <button onClick={() => setIsModalOpen(false)} className="w-full py-3 rounded-xl border border-gray-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 text-sm font-bold hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors mt-2"> 
                                                   å…³é—­ 
                                               </button>
                                           </div>
                                       ) : (
                                           // === å¸¸è§„/Demo ç•Œé¢ ===
                                           <>
                                           <div> 
                                               <h4 className="text-sm font-bold text-slate-600 dark:text-slate-300 mb-3 flex items-center gap-2"> 
                                                   <LucideIcon name="ClipboardList" size={16}/> æ•™å­¦ä»»åŠ¡ 
                                               </h4> 
                                               <div className="grid grid-cols-2 gap-3"> 
                                                   {DEFAULT_TASKS.map(task => ( 
                                                       <div key={task.id} onClick={() => toggleTask(task.id)} className={`p-3 rounded-xl border cursor-pointer transition-all flex items-center gap-3 ${ editCourse.tasks?.[task.id] ? `bg-${theme.primary}-50 border-${theme.primary}-200 dark:bg-${theme.primary}-900/30 dark:border-${theme.primary}-700` : 'bg-white dark:bg-slate-800 border-gray-200 dark:border-slate-700 hover:border-gray-300' }`} > 
                                                           <div className={`w-5 h-5 rounded-md border flex items-center justify-center transition-colors ${ editCourse.tasks?.[task.id] ? `bg-${theme.primary}-500 border-${theme.primary}-500 text-white` : 'border-gray-300 bg-white' }`}> 
                                                               {editCourse.tasks?.[task.id] && <LucideIcon name="CheckSquare" size={12}/>} 
                                                           </div> 
                                                           <span className={`text-sm font-medium ${editCourse.tasks?.[task.id] ? `text-${theme.primary}-700 dark:text-white` : 'text-slate-600 dark:text-slate-400'}`}>{task.name}</span> 
                                                       </div> 
                                                   ))} 
                                               </div> 
                                           </div> 
                                           {editCourse.type !== 'demo' && ( 
                                               <div> 
                                                   <h4 className="text-sm font-bold text-slate-600 dark:text-slate-300 mb-3 flex items-center gap-2"> 
                                                       <LucideIcon name="UserCheck" size={16}/> å­¦å‘˜è€ƒå‹¤ <span className="text-xs font-normal text-slate-400">(ç‚¹å‡»æ ‡è®°)</span> 
                                                   </h4> 
                                                   <div className="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-1"> 
                                                       {editCourse.studentIds?.map(sid => { 
                                                           const st = students.find(s => s.id === sid); 
                                                           if (!st) return null; 
                                                           const status = editCourse.attendance?.[sid]?.status; 
                                                           const isMadeUp = editCourse.attendance?.[sid]?.isMadeUp; 
                                                           return ( 
                                                               <div key={sid} className="flex items-center justify-between p-3 bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-xl"> 
                                                                   <div className="flex items-center gap-3"> 
                                                                       <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${status==='present' ? 'bg-emerald-100 text-emerald-600' : status==='absent' ? 'bg-red-100 text-red-600' : 'bg-gray-100 text-gray-400'}`}> {st.name[0]} </div> 
                                                                       <div> 
                                                                           <div className="text-sm font-bold text-slate-700 dark:text-white"> {st.name} {isMadeUp && <span className="ml-2 text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded">è¡¥è¯¾</span>} </div> 
                                                                           <div className="text-[10px] text-slate-400">å‰©ä½™: {st.remainingHours} è¯¾æ—¶</div> 
                                                                       </div> 
                                                                   </div> 
                                                                   <div className="flex bg-gray-100 dark:bg-slate-700 p-1 rounded-lg"> 
                                                                       <button onClick={() => toggleAttendance(sid, 'present')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${status === 'present' ? 'bg-white shadow text-emerald-600' : 'text-gray-400 hover:text-gray-600'}`} > åˆ°è¯¾ </button> 
                                                                       <button onClick={() => toggleAttendance(sid, 'absent')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${status === 'absent' ? 'bg-white shadow text-red-500' : 'text-gray-400 hover:text-gray-600'}`} > ç¼ºå‹¤ </button> 
                                                                   </div> 
                                                               </div> 
                                                           ); 
                                                       })} 
                                                   </div> 
                                               </div> 
                                           )} 
                                           <div className="pt-4 border-t border-gray-100 dark:border-slate-700 flex gap-3"> 
                                               <button onClick={() => setIsModalOpen(false)} className="flex-1 py-3 rounded-xl border border-gray-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 text-sm font-bold hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors"> å–æ¶ˆ </button> 
                                               <button onClick={handleSaveCourse} className={`flex-1 py-3 rounded-xl bg-${theme.primary}-600 text-white text-sm font-bold shadow-lg shadow-${theme.primary}-200 dark:shadow-none hover:bg-${theme.primary}-700 transition-all active:scale-95`}> ç¡®è®¤ä¿å­˜ </button> 
                                           </div>
                                           </>
                                       )}
                                   </div> 
                               )} 
                           </Modal>
                       </div>
                   )
               }
                
        
        
        
        
        // 1. å­¦å‘˜ç®¡ç†
        const StudentManager = () => {
            const { students, theme, lcAdd, lcUpdate, lcDelete, loading, setActiveStudentId, getPredictionText } = useAppData();
            const addToast = useToast();
            const [isAddOpen, setIsAddOpen] = useState(false);
            const [newStudent, setNewStudent] = useState({ gender: 'ç”·', remainingHours: 0 });
            const [searchTerm, setSearchTerm] = useState('');
            
            
            const handleSave = async () => {
                if (!newStudent.name) return addToast("è¯·å¡«å†™å§“å", "error");
                const { id, ...data } = newStudent;
                data.remainingHours = Number(data.remainingHours || 0); 
                // StudentManagerçš„æ›´æ–°ä¸è·³è¿‡ fetchAll
                let success = id ? await lcUpdate('Student', id, data) : await lcAdd('Student', data);
                if(success) { setIsAddOpen(false); setNewStudent({ gender: 'ç”·', remainingHours: 0 }); addToast("ä¿å­˜æˆåŠŸ", "success"); }
            };
            
            const handleDelete = (id) => { 
                showConfirmModal('ç¡®è®¤åˆ é™¤è¯¥å­¦å‘˜å—ï¼Ÿ', async () => {
                    await lcDelete('Student', id);
                    addToast("å­¦å‘˜å·²åˆ é™¤", "info");
                });
            };
            
            const getWarningColor = (remaining) => {
                if (remaining <= 0) return "text-slate-900 bg-slate-100 border-slate-300 dark:text-slate-100 dark:bg-slate-700 dark:border-slate-600"; 
                if (remaining <= 4) return "text-red-600 bg-red-50 border-red-200 dark:bg-red-900/30 dark:border-red-800 dark:text-red-300";   
                if (remaining <= 8) return "text-yellow-600 bg-yellow-50 border-yellow-200 dark:bg-yellow-900/30 dark:border-yellow-800 dark:text-yellow-300"; 
                return "text-emerald-600 bg-emerald-50 border-emerald-200 dark:bg-emerald-900/30 dark:border-emerald-800 dark:text-emerald-400"; 
            };
            
            // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ useMemo å®ç°æŒ‰å‰©ä½™è¯¾æ—¶ä»ä½åˆ°é«˜æ’åº
            const filteredStudents = useMemo(() => {
                return students
                    .filter(s => s.name && s.name.toLowerCase().includes(searchTerm.toLowerCase()))
                    .sort((a, b) => (a.remainingHours || 0) - (b.remainingHours || 0));
            }, [students, searchTerm]);

            return (
                <div className="p-4 space-y-6 pb-24 md:pb-4 pt-16 md:pt-4 animate-enter">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                        <h2 className="text-2xl font-bold text-gray-800 dark:text-white tracking-tight">å­¦å‘˜ç®¡ç†</h2>
                        <div className="flex gap-2 w-full md:w-auto">
                            <div className="relative flex-1 md:w-64 group">
                                <input 
                                    className="w-full pl-10 pr-4 py-2.5 border border-gray-200 dark:border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all shadow-sm group-hover:shadow-md dark:bg-slate-800 dark:text-white" 
                                    placeholder="æœç´¢å§“å..." 
                                    value={searchTerm} 
                                    onChange={e => setSearchTerm(e.target.value)} 
                                />
                                <div className="absolute left-3 top-3 text-gray-400 group-hover:text-blue-500 transition-colors"><LucideIcon name="Search" size={18} /></div>
                            </div>
                            <button 
                                onClick={() => { setNewStudent({gender:'ç”·', remainingHours: 0}); setIsAddOpen(true); }} 
                                className={`bg-${theme.primary}-600 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 text-sm shadow-lg shadow-${theme.primary}-500/30 hover:bg-${theme.primary}-700 hover:scale-105 active:scale-95 transition-all`}
                            >
                                <LucideIcon name="Plus" size={18} /> æ·»åŠ 
                            </button>
                        </div>
                    </div>
                    
                    {loading ? <div className="p-8"><Skeleton className="h-96 w-full"/></div> : (
                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-100 dark:divide-slate-700">
                                <thead className="bg-gray-50/50 dark:bg-slate-700/50">
                                    <tr>
                                        <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-slate-400 uppercase tracking-wider">å§“å</th>
                                        <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-slate-400 uppercase tracking-wider">å‰©ä½™è¯¾æ—¶</th>
                                        <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-slate-400 uppercase tracking-wider">é¢„æµ‹</th>
                                        <th className="px-6 py-4 text-right text-xs font-semibold text-gray-500 dark:text-slate-400 uppercase tracking-wider">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white dark:bg-slate-800 divide-y divide-gray-50 dark:divide-slate-700">
                                    {filteredStudents.map((s, idx) => (
                                        <tr 
                                            key={s.id} 
                                            className="hover:bg-gray-50/80 dark:hover:bg-slate-700/50 transition-colors animate-pop" 
                                            style={{animationDelay: `${idx * 50}ms`}}
                                        >
                                            <td className="px-6 py-4 font-medium text-gray-900 dark:text-white">{s.name} <span className="text-xs text-gray-400 ml-1">({s.gender})</span></td>
                                            <td className="px-6 py-4">
                                                <span className={`px-2.5 py-1 rounded-lg text-xs font-bold border ${getWarningColor(s.remainingHours || 0)}`}>
                                                    {s.remainingHours || 0} è¯¾æ—¶
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 text-xs text-gray-500 dark:text-slate-400">{getPredictionText(s.remainingHours || 0)}</td>
                                            <td className="px-6 py-4 text-right flex justify-end gap-3">
                                                {/* æ–°å¢ï¼šè¯¦æƒ…æŒ‰é’® - åˆ‡æ¢åˆ°å­¦å‘˜è¯¦æƒ…é¡µ */}
                                                <button 
                                                    onClick={() => setActiveStudentId(s.id)} 
                                                    className={`text-indigo-600 text-sm font-medium hover:underline hover:scale-105 inline-block transition-transform dark:text-indigo-400`}
                                                >
                                                    è¯¦æƒ…
                                                </button>
                                                <button 
                                                    onClick={() => {setNewStudent(s); setIsAddOpen(true)}} 
                                                    className={`text-${theme.primary}-600 text-sm font-medium hover:underline hover:scale-105 inline-block transition-transform`}
                                                >
                                                    ç¼–è¾‘
                                                </button>
                                                <button 
                                                    onClick={() => handleDelete(s.id)} 
                                                    className="text-red-500 text-sm font-medium hover:underline hover:scale-105 inline-block transition-transform"
                                                >
                                                    åˆ é™¤
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {filteredStudents.length === 0 && <div className="p-12 text-center text-gray-400 dark:text-slate-500">æœªæ‰¾åˆ°ç›¸å…³å­¦å‘˜</div>}
                    </div>
                    )}
                    
                    {/* å­¦å‘˜ç¼–è¾‘/æ·»åŠ  Modal (é€»è¾‘ä¸å˜) */}
                    <Modal isOpen={isAddOpen} onClose={() => setIsAddOpen(false)} title={newStudent.id ? "ç¼–è¾‘å­¦å‘˜" : "æ·»åŠ å­¦å‘˜"}>
                        <div className="space-y-5">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">å§“å</label>
                                    <input className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl focus:ring-2 focus:ring-blue-500/20 outline-none transition-all dark:bg-slate-700 dark:text-white" placeholder="è¾“å…¥å§“å" value={newStudent.name||''} onChange={e=>setNewStudent({...newStudent, name:e.target.value})} />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">å‰©ä½™è¯¾æ—¶</label>
                                    <input type="number" className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl focus:ring-2 focus:ring-blue-500/20 outline-none transition-all font-mono font-bold dark:bg-slate-700 dark:text-white" value={newStudent.remainingHours||0} onChange={e=>setNewStudent({...newStudent, remainingHours:e.target.value})} />
                                </div>
                            </div>
                            <div className="flex gap-4">
                                <div className="flex-1">
                                    <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">æ€§åˆ«</label>
                                    <select className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl bg-white dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-blue-500/20 outline-none transition-all" value={newStudent.gender||'ç”·'} onChange={e=>setNewStudent({...newStudent, gender:e.target.value})}>
                                        <option>ç”·</option><option>å¥³</option>
                                    </select>
                                </div>
                                <div className="flex-1">
                                    <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">å¹´é¾„</label>
                                    <input className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl focus:ring-2 focus:ring-blue-500/20 outline-none transition-all dark:bg-slate-700 dark:text-white" type="number" placeholder="0" value={newStudent.age||''} onChange={e=>setNewStudent({...newStudent, age:e.target.value})} />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">å¤‡æ³¨ä¿¡æ¯</label>
                                <textarea className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl h-24 text-sm focus:ring-2 focus:ring-blue-500/20 outline-none transition-all resize-none dark:bg-slate-700 dark:text-white" placeholder="è¾“å…¥å­¦å‘˜æƒ…å†µ..." value={newStudent.notes||''} onChange={e=>setNewStudent({...newStudent, notes:e.target.value})}></textarea>
                            </div>
                            <button onClick={handleSave} className={`w-full bg-${theme.primary}-600 text-white px-6 py-3.5 rounded-xl font-bold hover:bg-${theme.primary}-700 hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0 transition-all duration-200`}>ä¿å­˜å­¦å‘˜ä¿¡æ¯</button>
                        </div>
                    </Modal>
                </div>
            );
        };
// 2. è¯¾ç¨‹è¡¨ (UIè¿˜åŸç‰ˆï¼šè¡¥è¯¾åŠŸèƒ½ç‹¬ç«‹åµŒå…¥ï¼Œä¸å½±å“å¸¸è§„è¯¾)
        // 2. è¯¾ç¨‹è¡¨ (è¡¥è¯¾è¯¦æƒ…æç®€ç‰ˆï¼šåªçœ‹æ—¶é—´å’Œç­¾åˆ°)
        const CourseSchedule = () => {
            const { courses, students, classGroups, calendarDays, formatDate, theme, lcAdd, lcUpdate, lcDelete, setCourses, viewMode, setViewMode, classFeeBase, fetchAll, loading, makeupTarget, setMakeupTarget } = useAppData();
            const addToast = useToast();
            const [selectedCourse, setSelectedCourse] = useState(null);
            const [isEditOpen, setIsEditOpen] = useState(false);
            const [newCourse, setNewCourse] = useState({ type: 'regular', makeupMap: {}, hoursDeducted: 2 }); // æ·»åŠ  hoursDeducted
            
            const [studentSearchTerm, setStudentSearchTerm] = useState('');
            const [isRecurring, setIsRecurring] = useState(false);
            const [recurringConfig, setRecurringConfig] = useState({ recurringDays: [], repeatWeeks: 8 });

            // ç›‘å¬ makeupTarget è‡ªåŠ¨æ‰“å¼€
            useEffect(() => {
                if (makeupTarget) {
                    setNewCourse({
                        type: 'makeup',
                        className: 'å­¦å‘˜è¡¥è¯¾',
                        content: `è¡¥:${makeupTarget.cname}`,
                        studentIds: [makeupTarget.sid],
                        makeupMap: { [makeupTarget.sid]: makeupTarget.cid },
                        startTime: '09:00', endTime: '10:00',
                        dateStr: formatDate(new Date()), 
                        dayOfWeek: new Date().getDay() === 0 ? 6 : new Date().getDay() - 1,
                        tasks: {}, attendance: {},
                        hoursDeducted: 2 // è¡¥è¯¾é»˜è®¤ 2 è¯¾æ—¶
                    });
                    setSelectedCourse(null);
                    setIsEditOpen(true);
                    setMakeupTarget(null);
                }
            }, [makeupTarget, formatDate, setMakeupTarget]);

            const originalCourse = useMemo(() => {
                return selectedCourse ? courses.find(c => c.id === selectedCourse.id) : null;
            }, [selectedCourse, courses]);

            const absentRecords = useMemo(() => {
                const list = [];
                courses.forEach(c => {
                    if (c.type === 'demo') return;
                    if (!c.attendance) return;
                    Object.values(c.attendance).forEach(att => {
                        if (att.status === 'absent' && !att.isMadeUp) {
                            const s = students.find(stu => stu.id === att.studentId);
                            if (s) {
                                list.push({
                                    sid: att.studentId, sname: s.name,
                                    cid: c.id, cname: c.className, date: c.dateStr
                                });
                            }
                        }
                    });
                });
                return list.sort((a, b) => b.date.localeCompare(a.date)); 
            }, [courses, students]);

            const handleCellClick = (dStr, dayIndex) => {
                setNewCourse({ dateStr: dStr, dayOfWeek: dayIndex, startTime: '09:00', endTime: '10:00', studentIds: [], tasks: {}, attendance: {}, type: 'regular', makeupMap: {}, hoursDeducted: 2 }); // åˆå§‹åŒ– hoursDeducted
                setSelectedCourse(null); 
                setIsRecurring(false); 
                setRecurringConfig({ recurringDays: [], repeatWeeks: 8 }); 
                setIsEditOpen(true);
                setStudentSearchTerm(''); 
            };

            const handleMakeupToggle = async (sid) => {
                if (!newCourse.id) {
                    setNewCourse(prev => {
                        const currentStatus = prev.attendance?.[sid]?.status;
                        const newStatus = currentStatus === 'present' ? undefined : 'present';
                        const newAtt = { ...prev.attendance };
                        if (newStatus) newAtt[sid] = { studentId: sid, status: 'present' };
                        else delete newAtt[sid];
                        return { ...prev, attendance: newAtt };
                    });
                    return;
                }

                const currentStatus = newCourse.attendance?.[sid]?.status;
                const isCheckingIn = currentStatus !== 'present'; 
                
                // ä½¿ç”¨è¯¾ç¨‹è‡ªèº«çš„è¯¾æ—¶æ•°
                const hours = newCourse.hoursDeducted || 2; 

                const actionName = isCheckingIn ? "ç¡®è®¤å·²è¡¥è¯¾" : "å–æ¶ˆè¡¥è¯¾çŠ¶æ€";
                showConfirmModal(`ç¡®è®¤${actionName}ï¼Ÿ\n${isCheckingIn ? `ç³»ç»Ÿå°†æ‰£é™¤å­¦å‘˜ ${hours} è¯¾æ—¶ï¼Œå¹¶å°†åŸç¼ºå‹¤è®°å½•æ ‡è®°ä¸ºâ€œå·²è¡¥â€ã€‚` : `ç³»ç»Ÿå°†è¿”è¿˜ ${hours} è¯¾æ—¶ï¼Œå¹¶æ’¤é”€åŸç¼ºå‹¤è®°å½•çš„â€œå·²è¡¥â€çŠ¶æ€ã€‚`}`, async () => {
                    const map = newCourse.makeupMap || {};
                    const originalCid = map[sid];
                    
                    const student = students.find(s => s.id === sid);
                    if (student) {
                        const delta = isCheckingIn ? -hours : hours;
                        await lcUpdate('Student', sid, { remainingHours: (student.remainingHours || 0) + delta }, true);
                    }

                    if (originalCid) {
                        const targetCourse = courses.find(c => c.id === originalCid);
                        if (targetCourse && targetCourse.attendance && targetCourse.attendance[sid]) {
                            const updatedAtt = {
                                ...targetCourse.attendance,
                                [sid]: { ...targetCourse.attendance[sid], isMadeUp: isCheckingIn } 
                            };
                            await lcUpdate('Course', originalCid, { attendance: updatedAtt }, true);
                        }
                    }

                    const newAtt = { ...(newCourse.attendance || {}) };
                    if (isCheckingIn) newAtt[sid] = { studentId: sid, status: 'present' };
                    else delete newAtt[sid];
                    
                    await lcUpdate('Course', newCourse.id, { attendance: newAtt }, true);
                    
                    setNewCourse(prev => ({ ...prev, attendance: newAtt }));
                    await fetchAll();
                    addToast("æ“ä½œæˆåŠŸ", "success");
                });
            };

            const saveCourse = async () => {
                if (!newCourse.className) return addToast("è¯·å¡«å†™è¯¾ç¨‹åç§°", "error");
                if (isRecurring && newCourse.id) return addToast("å‘¨æœŸæ€§æ’è¯¾åªèƒ½ç”¨äºæ–°å¢è¯¾ç¨‹", "error");
                
                const { id, ...data } = newCourse;
                if (data.type === 'makeup' && !data.makeupMap) data.makeupMap = {};
                
                // ç¡®ä¿ hoursDeducted å­˜åœ¨ä¸”æ˜¯æ•°å­—
                data.hoursDeducted = Number(data.hoursDeducted || 2); 

                let success;
                if (id) {
                    await lcUpdate('Course', id, data, true); success = true;
                } else {
                    if (data.type === 'makeup' && !data.className) data.className = "å­¦å‘˜è¡¥è¯¾";
                    const recurringPayload = isRecurring ? { isRecurring, ...recurringConfig } : null;
                    success = await lcAdd('Course', data, recurringPayload); 
                }

                if (success) {
                    await fetchAll();
                    setIsEditOpen(false); 
                    if (!isRecurring) addToast("è¯¾ç¨‹å·²ä¿å­˜", "success"); 
                    setIsRecurring(false);
                }
            };

            const deleteCourse = () => { showConfirmModal("ç¡®è®¤åˆ é™¤è¯¾ç¨‹å—ï¼Ÿ", async () => { const success = await lcDelete('Course', selectedCourse.id); if(success) { setIsEditOpen(false); addToast("è¯¾ç¨‹å·²åˆ é™¤", "success"); } }); };
            
            const toggleAtt = (sid, status) => {
                if (newCourse.type === 'makeup') return; 
                if (newCourse.tasks?.teachingDone) return addToast("å·²ç»“è¯¾ï¼Œè¯·å…ˆå–æ¶ˆç»“è¯¾", "error");
                setNewCourse(prev => { 
                    const att = prev.attendance || {}; const currentStatus = att[sid]?.status; let newStatus = status; if (currentStatus === status) newStatus = undefined; const newAtt = { ...att }; if (newStatus) newAtt[sid] = { studentId: sid, status: newStatus }; else delete newAtt[sid]; return { ...prev, attendance: newAtt }; 
                });
            };
            
            const toggleTask = (taskId) => {
                if (taskId === 'teachingDone' && selectedCourse?.id) {
                    const isCompleting = !newCourse.tasks?.teachingDone;
                    // ä½¿ç”¨è¯¾ç¨‹è‡ªèº«çš„è¯¾æ—¶æ•°
                    const hours = newCourse.hoursDeducted || 2; 

                    showConfirmModal(isCompleting ? `ç¡®è®¤æˆè¯¾å®Œæˆï¼Ÿ\nç³»ç»Ÿå°†è‡ªåŠ¨æ‰£é™¤åˆ°è¯¾å­¦å‘˜ ${hours} è¯¾æ—¶ã€‚` : "ç¡®è®¤å–æ¶ˆç»“è¯¾ï¼Ÿ\nç³»ç»Ÿå°†è‡ªåŠ¨è¿”è¿˜è¯¾æ—¶ã€‚", async () => {
                        const currentAttendance = newCourse.attendance || {};
                        for (const sid of newCourse.studentIds || []) {
                            if (currentAttendance[sid]?.status === 'present') {
                                const student = students.find(s => s.id === sid);
                                if (student) {
                                    const delta = isCompleting ? -hours : hours;
                                    await lcUpdate('Student', sid, { remainingHours: (student.remainingHours || 0) + delta }, true);
                                }
                            }
                        }
                        const newTasks = { ...(newCourse.tasks || {}), teachingDone: isCompleting };
                        await lcUpdate('Course', newCourse.id, { tasks: newTasks }, true);
                        setNewCourse(prev => ({ ...prev, tasks: newTasks }));
                        await fetchAll();
                        addToast(isCompleting ? "å·²ç»“è¯¾æ‰£è´¹" : "å·²å–æ¶ˆç»“è¯¾", "success");
                    });
                } else {
                    setNewCourse(prev => { const tasks = prev.tasks || {}; return {...prev, tasks: {...tasks, [taskId]: !tasks[taskId]}}; });
                }
            };

            const handleStudentSelect = (sid) => { if (sid && !newCourse.studentIds?.includes(sid)) { setNewCourse(prev => ({...prev, studentIds: [...(prev.studentIds||[]), sid]})); setStudentSearchTerm(''); } };
            const handleMakeupSelect = (record) => { 
                const { sid, cid, cname } = record; 
                if (!newCourse.studentIds?.includes(sid)) { 
                    setNewCourse(prev => ({ 
                        ...prev, 
                        studentIds: [...(prev.studentIds || []), sid], 
                        makeupMap: { ...(prev.makeupMap || {}), [sid]: cid }, 
                        content: (prev.content ? prev.content + '; ' : '') + `è¡¥:${cname}` 
                    })); 
                } 
            };
            const handleClassGroupSelect = (e) => { const gid = e.target.value; const g = classGroups.find(x => x.id === gid); if (g) { setNewCourse(prev => { const newIds = [...new Set([...(prev.studentIds || []), ...(g.studentIds || [])])]; return {...prev, studentIds: newIds}; }); } e.target.value = ""; };
            
            const searchableStudents = useMemo(() => { if (!studentSearchTerm) return students.filter(s => !newCourse.studentIds?.includes(s.id)); const lowerSearch = studentSearchTerm.toLowerCase(); return students.filter(s => s.name?.toLowerCase().includes(lowerSearch) && !newCourse.studentIds?.includes(s.id)); }, [students, studentSearchTerm, newCourse.studentIds]);
            
            // ä½¿ç”¨ hoursDeducted è®¡ç®—è¯¾æ—¶æ€»æ•°
            const currentViewCourses = courses.filter(c => { const start = calendarDays[0]; const end = calendarDays[calendarDays.length - 1]; return c.dateStr >= formatDate(start) && c.dateStr <= formatDate(end); });
            const currentViewHours = currentViewCourses.reduce((acc, c) => { 
                if (c.type === 'demo') return acc; 
                const todayStr = formatDate(new Date()); 
                if (c.dateStr > todayStr) return acc; 
                const hours = c.hoursDeducted || 2; // ä½¿ç”¨ hoursDeducted
                let validCount = 0; 
                Object.values(c.attendance || {}).forEach(record => { 
                    if (c.type === 'makeup') { 
                        if(record.status==='present') validCount++; 
                    } else if (c.tasks?.teachingDone && (record.status === 'present' || record.isMadeUp)) validCount++; 
                }); 
                return acc + (validCount * hours); 
            }, 0);
            
            const viewText = viewMode === 'day' ? 'æœ¬æ—¥' : viewMode === 'week' ? 'æœ¬å‘¨' : 'æœ¬æœˆ';
            const gridColsClass = viewMode === 'day' ? 'grid-cols-1' : viewMode === 'month' ? 'grid-cols-7' : 'grid-cols-1 md:grid-cols-7';

            // æ ¸å¿ƒåˆ¤æ–­ï¼šæ˜¯å¦ä¸ºâ€œå·²å­˜åœ¨çš„è¡¥è¯¾â€
            const isExistingMakeup = selectedCourse && newCourse.type === 'makeup';

            return (
                <div className="flex flex-col h-full overflow-hidden animate-enter">
                    <div className="flex justify-between items-center p-4 bg-white dark:bg-slate-800 border-b border-gray-100 dark:border-slate-700 shadow-sm z-10 pt-16 md:pt-4">
                        <div className="flex items-center gap-4">
                            <h2 className="text-xl font-bold text-gray-800 dark:text-white tracking-tight">è¯¾ç¨‹è¡¨</h2>
                            <div className="hidden md:flex items-center bg-blue-50 dark:bg-blue-900/30 px-3 py-1 rounded-lg border border-blue-100 dark:border-blue-800 text-blue-700 dark:text-blue-300 text-xs font-bold gap-1"><LucideIcon name="Clock" size={14}/> {viewText}å¸¸è§„è¯¾æ—¶: {currentViewHours.toFixed(1)}</div>
                            <div className="flex bg-gray-100 dark:bg-slate-700 p-1 rounded-xl text-xs font-medium">
                                <button onClick={()=>setViewMode('day')} className={`px-3 py-1.5 rounded-lg transition-all duration-200 ${viewMode==='day'?'bg-white dark:bg-slate-600 shadow-sm text-gray-800 dark:text-white scale-105':'text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>æ—¥</button>
                                <button onClick={()=>setViewMode('week')} className={`px-3 py-1.5 rounded-lg transition-all duration-200 ${viewMode==='week'?'bg-white dark:bg-slate-600 shadow-sm text-gray-800 dark:text-white scale-105':'text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>å‘¨</button>
                                <button onClick={()=>setViewMode('month')} className={`px-3 py-1.5 rounded-lg transition-all duration-200 ${viewMode==='month'?'bg-white dark:bg-slate-600 shadow-sm text-gray-800 dark:text-white scale-105':'text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>æœˆ</button>
                            </div>
                        </div>
                        <WeekNavigator />
                    </div>
                    {loading ? (<div className="flex-1 p-4 grid grid-cols-1 md:grid-cols-7 gap-2">{[...Array(7)].map((_, i) => <Skeleton key={i} className="h-96 rounded-xl" />)}</div>) : (
                    <div className="flex-1 overflow-auto bg-gray-50 dark:bg-slate-900 p-2 pb-24 md:pb-4">
                        <div className={`grid ${gridColsClass} gap-2`}>
                            {calendarDays.map((d, i) => { 
                                const dStr = formatDate(d); 
                                const dayCourses = currentViewCourses.filter(c => c.dateStr === dStr).sort((a,b)=>a.startTime.localeCompare(b.startTime)); 
                                const isToday = dStr === formatDate(new Date()); 
                                const isMonthView = viewMode === 'month'; 
                                return (
                                    <div key={dStr} onClick={()=>handleCellClick(dStr, i)} className={`${isMonthView ? 'min-h-[100px]' : 'min-h-[120px] md:min-h-[400px]'} border rounded-xl p-2 transition-all cursor-pointer ${isToday ? `bg-${theme.primary}-50/50 dark:bg-slate-800 border-${theme.primary}-200 dark:border-${theme.primary}-700 ring-2 ring-${theme.primary}-100 dark:ring-${theme.primary}-900` : 'bg-white dark:bg-slate-800 border-gray-200 dark:border-slate-700 hover:border-gray-300 hover:shadow-md'}`}>
                                        <div className={`text-center py-1 border-b border-gray-100 dark:border-slate-700 mb-2 text-xs font-bold ${isToday ? `text-${theme.primary}-600` : 'text-gray-500 dark:text-slate-400'}`}>
                                            {isMonthView ? (<div className="flex justify-between px-1"><span className="opacity-50 text-[10px]">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]}</span><span>{d.getDate()}</span></div>) : (<div className="flex justify-between md:justify-center px-1"><span>å‘¨{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]}</span><span className="opacity-75">{dStr.slice(5)}</span></div>)}
                                        </div>
                                        <div className="space-y-1.5">
                                            {dayCourses.map((c, idx) => {
                                                const isDemo = c.type === 'demo'; const isMakeup = c.type === 'makeup';
                                                const isDone = c.tasks?.teachingDone; 
                                                const currentDateISO = formatDate(new Date());
                                                const isPastDue = c.dateStr < currentDateISO && !isDemo && !isMakeup; 
                                                let finalBgClass = 'bg-white dark:bg-slate-800', finalBorderClass = `border-${theme.primary}-500`;
                                                if (isDemo) { finalBgClass = 'bg-purple-50/50 dark:bg-purple-900/30'; finalBorderClass = 'border-purple-500'; } 
                                                else if (isMakeup) { finalBgClass = 'bg-orange-50/50 dark:bg-orange-900/30'; finalBorderClass = 'border-orange-500'; }
                                                else if (isDone) { finalBgClass = 'bg-emerald-50 dark:bg-emerald-900/20'; finalBorderClass = 'border-emerald-400'; } 
                                                else if (isPastDue) { finalBgClass = 'bg-rose-50 dark:bg-rose-900/30'; finalBorderClass = 'border-rose-500'; } 
                                                
                                                return (
                                                    <div key={c.id} onClick={(e)=>{e.stopPropagation(); setSelectedCourse(c); setNewCourse(c); setIsEditOpen(true);}} className={`${finalBgClass} ${finalBorderClass} border-l-4 shadow-sm p-2 rounded text-xs hover:shadow-md hover:-translate-y-0.5 transition-all group overflow-hidden animate-pop cursor-pointer relative`} style={{animationDelay: `${idx * 50}ms`}}>
                                                        <div className="flex justify-between items-start"><div className={`font-bold truncate ${isDone ? 'text-emerald-800 dark:text-emerald-400' : 'text-gray-800 dark:text-white'}`}>{c.className}</div>{isDone && <LucideIcon name="CheckSquare" size={12} className="text-emerald-600 ml-1 shrink-0"/>}</div>
                                                        
                                                        {/* æ¢å¤æ—¶é—´æ®µå’Œäººæ•°ï¼Œä»…ç§»é™¤è¯¾æ—¶æ ‡å‡†ä¿¡æ¯ */}
                                                        {!isMonthView && (<div className="space-y-1 mt-1">
                                                            <div className="text-gray-500 dark:text-slate-400 flex items-center gap-1">
                                                                <LucideIcon name="Clock" size={10}/> {c.startTime}-{c.endTime}
                                                            </div>
                                                            <div className="text-gray-500 dark:text-slate-400 flex items-center gap-1">
                                                                <LucideIcon name="Users" size={10}/> {c.studentIds?.length || 0}äºº
                                                            </div>
                                                        </div>)}
                                                        {isMonthView && <div className="text-[10px] text-gray-400 truncate mt-0.5">{c.startTime}</div>}

                                                        {isPastDue && !isDone && <div className="absolute top-1 right-1 w-2 h-2 bg-rose-500 rounded-full animate-pulse"></div>}
                                                        {isMakeup && <div className="absolute top-1 right-1 text-[8px] bg-orange-100 text-orange-600 px-1 rounded">è¡¥</div>}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ) 
                            })}
                        </div>
                    </div>
                    )}
                    
                    <Modal isOpen={isEditOpen} onClose={()=>setIsEditOpen(false)} title={selectedCourse ? (newCourse.type==='makeup'?"è¡¥è¯¾è¯¦æƒ…":"è¯¾ç¨‹è¯¦æƒ…") : "æ–°è¯¾ç¨‹æ’è¯¾"}>
                        <div className="space-y-5">
                            {/* å‘¨æœŸæ€§æ’è¯¾ (ä»…é™æ–°å¢) */}
                            {!selectedCourse && (
                                <div className="p-3 border border-slate-200 dark:border-slate-700 rounded-xl bg-white/50 dark:bg-slate-800/50 flex justify-between items-center">
                                    <label htmlFor="recurringToggle" className="text-xs font-bold text-slate-600 dark:text-slate-300 cursor-pointer">å‘¨æœŸæ€§æ’è¯¾</label>
                                    <div className="toggle-switch transform scale-75 origin-right"><input type="checkbox" id="recurringToggle" checked={isRecurring} onChange={() => setIsRecurring(!isRecurring)} /><label htmlFor="recurringToggle"></label></div>
                                </div>
                            )}

                            {/* è¯¾ç¨‹ç±»å‹ (å¦‚æœæ˜¯å·²æœ‰è¡¥è¯¾ï¼Œåˆ™éšè—åˆ‡æ¢æŒ‰é’®ï¼Œä¿æŒç•Œé¢ç®€æ´) */}
                            {!isExistingMakeup && (
                                <div className="flex gap-2 p-1 bg-gray-100 dark:bg-slate-700 rounded-xl">
                                    <button onClick={()=>setNewCourse({...newCourse, type:'regular', hoursDeducted: 2})} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${newCourse.type==='regular' ? 'bg-white dark:bg-slate-600 shadow text-blue-600 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400'}`}>å¸¸è§„è¯¾</button>
                                    <button onClick={()=>setNewCourse({...newCourse, type:'makeup', className: 'å­¦å‘˜è¡¥è¯¾', hoursDeducted: 2})} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${newCourse.type==='makeup' ? 'bg-white dark:bg-slate-600 shadow text-orange-600 dark:text-orange-400' : 'text-gray-500 dark:text-gray-400'}`}>è¡¥è¯¾(Makeup)</button>
                                    <button onClick={()=>setNewCourse({...newCourse, type:'demo', hoursDeducted: 0})} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${newCourse.type==='demo' ? 'bg-white dark:bg-slate-600 shadow text-purple-600 dark:text-purple-400' : 'text-gray-500 dark:text-gray-400'}`}>è¯•å¬è¯¾</button>
                                </div>
                            )}

                            {isRecurring && !selectedCourse && (
                                <div className="bg-blue-50/50 dark:bg-blue-900/30 p-3 rounded-xl border border-blue-200 dark:border-blue-800 space-y-3">
                                    <div className="text-xs font-bold text-blue-700 dark:text-blue-300">é‡å¤å‘¨å‡ </div>
                                    <div className="flex flex-wrap gap-2">
                                        {['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].map((day, index) => (
                                            <button key={day} onClick={() => setRecurringConfig(prev => { const days = prev.recurringDays.includes(index) ? prev.recurringDays.filter(i => i !== index) : [...prev.recurringDays, index]; return { ...prev, recurringDays: days }; })} className={`w-7 h-7 rounded-full text-xs font-bold transition-colors ${recurringConfig.recurringDays.includes(index) ? `bg-${theme.primary}-600 text-white` : 'bg-white dark:bg-slate-700 text-gray-500 border'}`}>{day}</button>
                                        ))}
                                    </div>
                                    <div className="flex items-center gap-2 text-xs"><span>é‡å¤</span><input type="number" min="1" max="52" className="w-12 border p-1 rounded text-center dark:bg-slate-800" value={recurringConfig.repeatWeeks} onChange={e=>setRecurringConfig({...recurringConfig, repeatWeeks: Number(e.target.value)})} /><span>å‘¨</span></div>
                                </div>
                            )}

                            {/* é€šç”¨å­—æ®µ (å¦‚æœæ˜¯å·²æœ‰è¡¥è¯¾ï¼Œå±•ç¤ºæç®€ä¿¡æ¯) */}
                            {isExistingMakeup ? (
                                <div className="bg-orange-50/50 dark:bg-slate-700/50 p-6 rounded-2xl border border-orange-100 dark:border-slate-600 text-center shadow-inner">
                                    <div className="text-xs font-bold text-orange-500 dark:text-orange-300 mb-1 uppercase tracking-wider">{newCourse.dateStr} (å‘¨{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(newCourse.dateStr).getDay()]})</div>
                                    <div className="text-4xl font-extrabold text-slate-800 dark:text-white tracking-tight my-2">{newCourse.startTime}</div>
                                    <div className="text-xs text-slate-400 font-medium">è‡³ {newCourse.endTime}</div>
                                    <div className="mt-4 pt-4 border-t border-orange-100 dark:border-slate-600 text-xs text-slate-500 dark:text-slate-400 italic">
                                        {newCourse.content || "æš‚æ— å¤‡æ³¨"}
                                    </div>
                                </div>
                            ) : (
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="col-span-2 md:col-span-1"><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">è¯¾ç¨‹åç§°</label><input className="w-full border border-gray-200 dark:border-slate-600 p-2.5 rounded-xl outline-none dark:bg-slate-700 dark:text-white" value={newCourse.className||''} onChange={e=>setNewCourse({...newCourse, className:e.target.value})} /></div>
                                    <div className="col-span-2 md:col-span-1"><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">æ—¥æœŸ</label><input type="date" className="w-full border border-gray-200 dark:border-slate-600 p-2.5 rounded-xl outline-none dark:bg-slate-700 dark:text-white" value={newCourse.dateStr||''} onChange={e=>setNewCourse({...newCourse, dateStr:e.target.value})} /></div>
                                    <div className="col-span-2 md:col-span-1">
                                        <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">æ‰£é™¤è¯¾æ—¶æ•°</label>
                                        <input 
                                            type="number" 
                                            min="0.5" step="0.5" 
                                            className="w-full border border-gray-200 dark:border-slate-600 p-2.5 rounded-xl outline-none dark:bg-slate-700 dark:text-white font-mono font-bold" 
                                            value={newCourse.hoursDeducted || 2} 
                                            onChange={e=>setNewCourse({...newCourse, hoursDeducted: Number(e.target.value)})} 
                                        />
                                    </div>
                                    <div className="col-span-2 md:col-span-1"><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">å†…å®¹/å¤‡æ³¨</label><input className="w-full border border-gray-200 dark:border-slate-600 p-2.5 rounded-xl outline-none dark:bg-slate-700 dark:text-white" value={newCourse.content||''} onChange={e=>setNewCourse({...newCourse, content:e.target.value})} /></div>
                                    <div><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">å¼€å§‹</label><input type="time" className="w-full border border-gray-200 dark:border-slate-600 p-2.5 rounded-xl outline-none dark:bg-slate-700 dark:text-white" value={newCourse.startTime||''} onChange={e=>setNewCourse({...newCourse, startTime:e.target.value})} /></div>
                                    <div><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">ç»“æŸ</label><input type="time" className="w-full border border-gray-200 dark:border-slate-600 p-2.5 rounded-xl outline-none dark:bg-slate-700 dark:text-white" value={newCourse.endTime||''} onChange={e=>setNewCourse({...newCourse, endTime:e.target.value})} /></div>
                                </div>
                            )}

                            {/* === åˆ†æ”¯ç•Œé¢ === */}

                            {/* 1. è¡¥è¯¾ä¸“ç”¨ç•Œé¢ */}
                            {newCourse.type === 'makeup' ? (
                                <div className="bg-white dark:bg-slate-800 p-4 rounded-xl border border-gray-100 dark:border-slate-700 shadow-sm">
                                    <div className="text-sm font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2 border-b border-gray-50 dark:border-slate-700 pb-3">
                                        <div className="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center"><LucideIcon name="UserCheck" size={18}/></div>
                                        å­¦å‘˜ç­¾åˆ°
                                    </div>
                                    {!selectedCourse && (
                                        <div className="max-h-32 overflow-y-auto space-y-2 mb-4 custom-scrollbar bg-gray-50 dark:bg-slate-700/50 p-2 rounded-lg border border-gray-200 dark:border-slate-600">
                                            <div className="text-xs text-gray-400 mb-1">é€‰æ‹©éœ€è¡¥è¯¾è®°å½•:</div>
                                            {absentRecords.map((r, i) => (
                                                <div key={i} onClick={() => handleMakeupSelect(r)} className={`p-2 rounded border cursor-pointer flex justify-between items-center transition-all ${newCourse.makeupMap?.[r.sid]===r.cid ? 'bg-orange-50 border-orange-300 dark:bg-orange-900/30 dark:border-orange-700' : 'bg-white dark:bg-slate-800 border-transparent hover:border-gray-200'}`}>
                                                    <span className="text-xs text-slate-600 dark:text-slate-300">{r.sname} <span className="text-gray-400 ml-1">ç¼º:{r.date.slice(5)}</span></span>
                                                    {newCourse.makeupMap?.[r.sid]===r.cid && <LucideIcon name="Check" size={12} className="text-orange-500"/>}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    <div className="space-y-3">
                                        {newCourse.studentIds?.map(sid => {
                                            const st = students.find(s=>s.id===sid);
                                            const status = newCourse.attendance?.[sid]?.status;
                                            return st ? (
                                                <div key={sid} className="flex justify-between items-center">
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white ${status === 'present' ? 'bg-green-500' : 'bg-gray-300 dark:bg-slate-600'}`}>{st.name[0]}</div>
                                                        <div>
                                                            <div className="font-bold text-sm text-gray-800 dark:text-white">{st.name}</div>
                                                            <div className="text-[10px] text-gray-400">å‰©ä½™: {st.remainingHours} è¯¾æ—¶</div>
                                                        </div>
                                                    </div>
                                                    <button onClick={() => handleMakeupToggle(sid)} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 ${status === 'present' ? 'bg-green-50 text-green-600 border border-green-200' : 'bg-orange-600 text-white shadow-md hover:bg-orange-700'}`}>
                                                        {status === 'present' ? <><LucideIcon name="Check" size={14}/> å·²è¡¥è¯¾</> : "ç¡®è®¤è¡¥è¯¾"}
                                                    </button>
                                                </div>
                                            ) : null;
                                        })}
                                        {(!newCourse.studentIds || newCourse.studentIds.length === 0) && <div className="text-center text-xs text-gray-400 py-4">è¯·å…ˆæ·»åŠ å­¦å‘˜</div>}
                                    </div>
                                </div>
                            ) : (
                                /* 2. å¸¸è§„è¯¾/è¯•å¬è¯¾ (ä¿æŒåŸæ ·) */
                                <>
                                {newCourse.type !== 'demo' ? (
                                    <div className="bg-gray-50/80 dark:bg-slate-700/50 p-4 rounded-xl border border-gray-200 dark:border-slate-600">
                                        <div className="flex gap-3 mb-3">
                                            <select className="border border-gray-200 dark:border-slate-600 p-2 rounded-lg text-xs flex-1 bg-white dark:bg-slate-700 dark:text-white outline-none" onChange={handleClassGroupSelect}><option value="">+ å¯¼å…¥ç­çº§</option>{classGroups.map(g=><option key={g.id} value={g.id}>{g.name}</option>)}</select>
                                            <div className="relative flex-1">
                                                <div className="flex items-center border border-gray-200 dark:border-slate-600 p-2 rounded-lg bg-white dark:bg-slate-700 dark:text-white"><LucideIcon name="Search" size={14} className="text-gray-400 mr-2"/><input type="text" placeholder="æœç´¢å­¦å‘˜..." className="w-full text-xs bg-transparent outline-none" value={studentSearchTerm} onChange={e => setStudentSearchTerm(e.target.value)} /></div>
                                                {studentSearchTerm && searchableStudents.length > 0 && <div className="absolute top-full left-0 w-full mt-1 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-lg shadow-lg max-h-40 overflow-y-auto z-20">{searchableStudents.map(s => <div key={s.id} className="p-2 text-xs text-gray-800 dark:text-white cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-600" onClick={() => handleStudentSelect(s.id)}>{s.name}</div>)}</div>}
                                            </div>
                                        </div>
                                        <div className="flex flex-wrap gap-2 min-h-[2rem]">{newCourse.studentIds?.map(sid => { const st = students.find(s=>s.id===sid); return st ? <span key={sid} className="bg-white dark:bg-slate-600 border px-2.5 py-1 rounded-lg text-xs flex items-center gap-1.5 shadow-sm dark:text-white">{st.name} <button onClick={()=>setNewCourse(prev=>({...prev, studentIds: prev.studentIds.filter(id=>id!==sid)}))} className="text-red-400 font-bold">Ã—</button></span> : null; })}</div>
                                    </div>
                                ) : (
                                    <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-xl border border-purple-100 dark:border-purple-800 text-xs text-purple-700 dark:text-purple-300 flex items-center gap-2"><LucideIcon name="Sparkles" size={16}/><span>Demoè¯¾ä¸ºè¯•å¬æ€§è´¨ï¼Œä¸å…³è”ç³»ç»Ÿå­¦å‘˜ï¼Œè¯¾é…¬å›ºå®š Â¥40/èŠ‚ã€‚</span></div>
                                )}

                                {selectedCourse && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
                                        <div className="border border-orange-100 dark:border-orange-900/50 p-3 rounded-xl bg-orange-50/50 dark:bg-orange-900/20">
                                            <div className="font-bold mb-3 text-orange-800 dark:text-orange-400 flex items-center gap-2"><LucideIcon name="ClipboardList" size={16}/> æ•™å¸ˆä»»åŠ¡ (ç‚¹æ­¤ç»“è¯¾æ‰£è´¹)</div>
                                            <div className="space-y-2">{DEFAULT_TASKS.map(task => <label key={task.id} className="flex items-center gap-2 cursor-pointer p-1.5 rounded-lg hover:bg-orange-100/50"><input type="checkbox" className="rounded text-orange-500" checked={newCourse.tasks?.[task.id]||false} onChange={()=>toggleTask(task.id)} /><span className="dark:text-slate-300">{task.name}</span></label>)}</div>
                                        </div>
                                        {newCourse.type !== 'demo' && (
                                            <div className="border border-blue-100 dark:border-blue-900/50 p-3 rounded-xl bg-blue-50/50 dark:bg-blue-900/20">
                                                <div className="font-bold mb-3 text-blue-800 dark:text-blue-400 flex items-center gap-2"><LucideIcon name="UserCheck" size={16}/> è€ƒå‹¤æ‰“å¡</div>
                                                <div className="max-h-40 overflow-y-auto space-y-1 pr-1 custom-scrollbar">
                                                    {newCourse.studentIds?.map(sid => { 
                                                        const st = students.find(s=>s.id===sid); 
                                                        const status = newCourse.attendance?.[sid]?.status; 
                                                        const isMadeUp = originalCourse?.attendance?.[sid]?.isMadeUp || newCourse.attendance?.[sid]?.isMadeUp || false; 
                                                        return st ? (
                                                            <div key={sid} className="flex justify-between items-center p-1.5 hover:bg-blue-100/50 rounded-lg">
                                                                <span className="dark:text-slate-300">{st.name} {isMadeUp && <span className="text-[10px] text-green-500">(å·²è¡¥)</span>}</span> 
                                                                <div className="flex gap-1">
                                                                    <button onClick={()=>toggleAtt(sid,'present')} disabled={newCourse.tasks?.teachingDone} className={`px-2 py-0.5 rounded text-[10px] border ${status==='present'?'bg-green-500 text-white border-green-600':'bg-white dark:bg-slate-700 text-gray-500'} ${newCourse.tasks?.teachingDone ? 'opacity-50 cursor-not-allowed' : ''}`}>åˆ°</button>
                                                                    <button onClick={()=>toggleAtt(sid,'absent')} disabled={newCourse.tasks?.teachingDone} className={`px-2 py-0.5 rounded text-[10px] border ${status==='absent'?'bg-red-500 text-white border-red-600':'bg-white dark:bg-slate-700 text-gray-500'} ${newCourse.tasks?.teachingDone ? 'opacity-50 cursor-not-allowed' : ''}`}>ç¼º</button>
                                                                </div>
                                                            </div>
                                                        ) : null; 
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                                </>
                            )}

                            <div className="flex gap-3 pt-2">
                                {selectedCourse && <button onClick={deleteCourse} className="text-red-500 text-sm border border-red-200 px-5 rounded-xl hover:bg-red-50">åˆ é™¤</button>}
                                <div className="flex-1"></div>
                                <button onClick={() => setIsEditOpen(false)} className="text-gray-500 px-5 rounded-xl hover:bg-gray-100">å–æ¶ˆ</button>
                                {/* ä»…å½“ä¸æ˜¯ å·²å­˜åœ¨çš„è¡¥è¯¾è®°å½• æ—¶ï¼Œæ‰æ˜¾ç¤ºä¿å­˜æŒ‰é’® (è¡¥è¯¾è®°å½•æ“ä½œæ˜¯å³æ—¶çš„) */}
                                <button onClick={saveCourse} className={`bg-${theme.primary}-600 text-white px-8 py-2.5 rounded-xl shadow-lg hover:bg-${theme.primary}-700 ${isExistingMakeup ? 'hidden' : ''}`}>ä¿å­˜</button>
                                {isExistingMakeup && <div className="text-xs text-gray-400 self-center">è¡¥è¯¾æ“ä½œå®æ—¶ä¿å­˜</div>}
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };
        // å¯¼èˆªæ¡
        const WeekNavigator = () => {
            const { changeWeek, calendarDays, formatDate, viewMode } = useAppData();
            const title = useMemo(() => {
                if (!calendarDays.length) return "";
                const start = calendarDays[0];
                if (viewMode === 'day') return formatDate(start);
                if (viewMode === 'month') return `${start.getFullYear()}å¹´ ${start.getMonth() + 1}æœˆ`;
                const end = calendarDays[calendarDays.length - 1];
                return `${formatDate(start).slice(5)} - ${formatDate(end).slice(5)}`;
            }, [calendarDays, viewMode, formatDate]);

            return (
                <div className="flex items-center gap-2 bg-gray-50 dark:bg-slate-700 rounded-xl p-1.5 border border-gray-200 dark:border-slate-600">
                    <button onClick={()=>changeWeek(-1)} className="p-1.5 rounded-lg hover:bg-white dark:hover:bg-slate-600 hover:shadow-sm text-gray-600 dark:text-gray-300 transition-all"><LucideIcon name="ChevronLeft" size={18}/></button>
                    <span className="text-xs px-3 font-bold text-gray-700 dark:text-gray-300 min-w-[90px] text-center">{title}</span>
                    <button onClick={()=>changeWeek(1)} className="p-1.5 rounded-lg hover:bg-white dark:hover:bg-slate-600 hover:shadow-sm text-gray-600 dark:text-gray-300 transition-all"><LucideIcon name="ChevronRight" size={18}/></button>
                </div>
            )
        }

        // 3. ç­çº§ç®¡ç†
        const ClassGroupManager = () => {
            const { classGroups, students, theme, lcAdd, lcUpdate, lcDelete } = useAppData();
            const addToast = useToast();
            const [isEdit, setIsEdit] = useState(false);
            const [group, setGroup] = useState({});
            
            // ç­çº§åˆ—è¡¨æœç´¢è¯ (æ–°å¢)
            const [groupSearchTerm, setGroupSearchTerm] = useState('');
            
            // ç”¨äºç­çº§ç®¡ç†æ·»åŠ å­¦å‘˜æ—¶çš„æœç´¢è¯
            const [studentSearchTerm, setSearchTerm] = useState('');

            const save = async () => { 
                if(!group.name) return addToast("è¯·å¡«å†™ç­çº§åç§°", "error");
                const { id, ...data } = group; 
                // ç¡®ä¿ studentIds æ˜¯ä¸€ä¸ªæ•°ç»„
                data.studentIds = data.studentIds || [];
                // ClassGroupManagerçš„æ›´æ–°ä¸è·³è¿‡ fetchAll
                let success = id ? await lcUpdate('ClassGroup', id, data) : await lcAdd('ClassGroup', data); 
                if(success) { setIsEdit(false); setGroup({}); addToast("ä¿å­˜æˆåŠŸ", "success"); } 
            };
            
            const deleteGroup = (id) => { 
                showConfirmModal('ç¡®è®¤åˆ é™¤è¯¥ç­çº§å—ï¼Ÿ', async () => {
                    await lcDelete('ClassGroup', id);
                    addToast("ç­çº§å·²åˆ é™¤", "info");
                });
            };
            
            // æœç´¢è¿‡æ»¤åçš„å­¦ç”Ÿåˆ—è¡¨ (ç”¨äºç­çº§æ·»åŠ  modal)
            const searchableStudents = useMemo(() => {
                if (!studentSearchTerm) return students.filter(s => !group.studentIds?.includes(s.id));
                const lowerSearch = studentSearchTerm.toLowerCase();
                return students.filter(s => 
                    s.name?.toLowerCase().includes(lowerSearch) && 
                    !group.studentIds?.includes(s.id)
                );
            }, [students, studentSearchTerm, group.studentIds]);
            
            const handleStudentToggle = (sid) => {
                setGroup(prev => {
                    const ids = prev.studentIds || [];
                    const newIds = ids.includes(sid) ? ids.filter(i => i !== sid) : [...ids, sid];
                    return { ...prev, studentIds: newIds };
                });
                setSearchTerm(''); // æ·»åŠ æˆ–ç§»é™¤åæ¸…ç©ºæœç´¢
            };
            
            const handleModalOpen = (g) => {
                setGroup(g);
                setIsEdit(true);
                setSearchTerm(''); // æ¯æ¬¡æ‰“å¼€é‡ç½®æœç´¢
            }

            return (
                <div className="p-4 space-y-6 pb-24 md:pb-4 pt-16 md:pt-4 animate-enter">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                        <h2 className="text-2xl font-bold text-gray-800 dark:text-white tracking-tight">ç­çº§ç®¡ç†</h2>
                        <div className="flex gap-2 w-full md:w-auto">
                            <div className="relative flex-1 md:w-64 group">
                                <input 
                                    className="w-full pl-10 pr-4 py-2.5 border border-gray-200 dark:border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all shadow-sm group-hover:shadow-md dark:bg-slate-800 dark:text-white" 
                                    placeholder="æœç´¢ç­çº§åç§°..." 
                                    value={groupSearchTerm} 
                                    onChange={e => setGroupSearchTerm(e.target.value)} 
                                />
                                <div className="absolute left-3 top-3 text-gray-400 group-hover:text-blue-500 transition-colors"><LucideIcon name="Search" size={18} /></div>
                            </div>
                            <button onClick={()=>{handleModalOpen({name:'', studentIds:[]});}} className={`bg-${theme.primary}-600 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 text-sm shadow-lg shadow-${theme.primary}-500/30 hover:bg-${theme.primary}-700 hover:scale-105 active:scale-95 transition-all`}>
                                <LucideIcon name="Plus" size={18}/> æ–°å»º
                            </button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {classGroups.filter(g => g.name?.toLowerCase().includes(groupSearchTerm.toLowerCase())).map((g, idx) => { 
                            const groupStudents = (g.studentIds || []).map(sid => students.find(s => s.id === sid)).filter(Boolean); 
                            return (
                                <div 
                                    key={g.id} 
                                    className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 hover:shadow-lg hover:border-gray-200 hover:-translate-y-1 transition-all duration-300 hover-lift animate-pop group" 
                                    style={{animationDelay: `${idx * 50}ms`}}
                                >
                                    <div className="flex justify-between items-start mb-4">
                                        <h3 className="font-bold text-lg text-gray-800 dark:text-white">{g.name}</h3>
                                        <div className="flex gap-1 transition-opacity">
                                            <button onClick={()=>{handleModalOpen(g)}} className={`text-${theme.primary}-600 p-1.5 hover:bg-${theme.primary}-50 dark:hover:bg-slate-700 rounded-lg transition-colors`}>
                                                <LucideIcon name="Edit" size={16}/>
                                            </button>
                                            <button onClick={()=>{deleteGroup(g.id)}} className="text-red-500 p-1.5 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors">
                                                <LucideIcon name="Trash2" size={16}/>
                                            </button>
                                        </div>
                                    </div>
                                    <div className="bg-gray-50/80 dark:bg-slate-700/50 p-3 rounded-xl border border-gray-100 dark:border-slate-600 min-h-[80px]">
                                        <div className="text-[10px] text-gray-400 font-bold mb-2 flex justify-between uppercase tracking-wider">
                                            <span>å­¦å‘˜åå•</span>
                                            <span className={`px-2 py-0.5 rounded-full text-xs ${groupStudents.length > 0 ? `bg-${theme.primary}-100 text-${theme.primary}-700 dark:bg-slate-600 dark:text-white` : 'bg-gray-200 text-gray-500'}`}>{groupStudents.length}äºº</span>
                                        </div>
                                        <div className="flex flex-wrap gap-1.5">
                                            {groupStudents.length > 0 ? groupStudents.map(s => 
                                                <span key={s.id} className="bg-white dark:bg-slate-600 border border-gray-100 dark:border-slate-500 px-2.5 py-1 rounded-lg text-xs text-gray-600 dark:text-slate-200 shadow-sm flex items-center hover:border-gray-300 transition-colors">{s.name}</span>
                                            ) : <span className="text-xs text-gray-300 italic py-1 pl-1">æš‚æ— å­¦å‘˜...</span>}
                                        </div>
                                    </div>
                                </div>
                            ); 
                        })}
                    </div>
                    
                    {/* ç­çº§ç¼–è¾‘ Modal */}
                    <Modal isOpen={isEdit} onClose={()=>setIsEdit(false)} title="ç¼–è¾‘ç­çº§">
                        <div className="space-y-5">
                            {/* ç­çº§åç§° */}
                            <input className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl focus:ring-2 focus:ring-blue-500/20 outline-none transition-all dark:bg-slate-700 dark:text-white" placeholder="ç­çº§å" value={group.name||''} onChange={e=>setGroup({...group, name:e.target.value})} />
                            
                            <div className="border border-gray-200 dark:border-slate-600 p-3 rounded-xl bg-gray-50/50 dark:bg-slate-700/50">
                                <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-2">æ·»åŠ å­¦å‘˜</label>
                                {/* æœç´¢è¾“å…¥æ¡† */}
                                <div className="relative mb-3">
                                    <div className="flex items-center border border-gray-200 dark:border-slate-600 p-2 rounded-lg bg-white dark:bg-slate-700 dark:text-white transition-colors">
                                        <LucideIcon name="Search" size={16} className="text-gray-400 mr-2"/>
                                        <input 
                                            type="text" 
                                            placeholder="æœç´¢å­¦å‘˜å§“åæ·»åŠ ..." 
                                            className="w-full text-sm bg-transparent outline-none" 
                                            value={studentSearchTerm} 
                                            onChange={e => setSearchTerm(e.target.value)} 
                                        />
                                    </div>
                                    {/* æœç´¢ç»“æœåˆ—è¡¨ */}
                                    {studentSearchTerm && searchableStudents.length > 0 && (
                                        <div className="absolute top-full left-0 w-full mt-1 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-lg shadow-lg max-h-40 overflow-y-auto z-20">
                                            {searchableStudents.map(s => (
                                                <div 
                                                    key={s.id} 
                                                    className="p-2 text-sm text-gray-800 dark:text-white cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-600 flex justify-between items-center" 
                                                    onClick={() => handleStudentToggle(s.id)}
                                                >
                                                    <span>{s.name}</span>
                                                    <span className="text-xs text-gray-400">({s.remainingHours}h)</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    {studentSearchTerm && searchableStudents.length === 0 && (
                                        <div className="absolute top-full left-0 w-full mt-1 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-lg shadow-lg p-2 text-sm text-gray-400 z-20">æœªæ‰¾åˆ°ç›¸å…³å­¦å‘˜</div>
                                    )}
                                </div>
                                
                                {/* å·²é€‰ä¸­å­¦å‘˜åˆ—è¡¨ */}
                                <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1 mt-4">å·²åœ¨ç­å­¦å‘˜ ({group.studentIds?.length || 0}äºº)</label>
                                <div className="max-h-40 overflow-y-auto border border-gray-200 dark:border-slate-600 p-3 rounded-xl grid grid-cols-2 gap-2 bg-white/50 dark:bg-slate-800/50 custom-scrollbar">
                                    {students.filter(s => group.studentIds?.includes(s.id)).map(s=>(
                                        <label key={s.id} className="flex items-center gap-2 text-xs bg-white dark:bg-slate-700 p-2 rounded-lg border border-gray-100 dark:border-slate-600 hover:border-red-200 cursor-pointer transition-all dark:text-slate-200" onClick={() => handleStudentToggle(s.id)}>
                                            <LucideIcon name="UserX" size={14} className="text-red-500"/>
                                            {s.name}
                                        </label>
                                    ))}
                                    {group.studentIds?.length === 0 && <div className="col-span-2 text-center text-gray-300 italic py-2">è¯·ä½¿ç”¨ä¸Šæ–¹æœç´¢æˆ–ç‚¹å‡»å­¦å‘˜ç§»é™¤</div>}
                                </div>
                            </div>

                            <button onClick={save} className={`w-full bg-${theme.primary}-600 text-white py-3 rounded-xl font-bold hover:bg-${theme.primary}-700 transition-all shadow-md`}>ä¿å­˜ç­çº§</button>
                        </div>
                    </Modal>
                </div>
            )
        }

        // 4. å›è®¿ç®¡ç†
        const FollowUpManager = () => {
            const { students, classGroups, followUps, formatDate, theme, exportToCSV, lcAdd, lcUpdate, fetchAll } = useAppData();
            const addToast = useToast(); 
            const currentMonth = formatDate(new Date()).slice(0,7);
            const total = students.length * 2; // æ¯äººæ¯æœˆ 2 æ¬¡å›è®¿ç›®æ ‡
            // ä¿®å¤ï¼šç¡®ä¿ followUps ä¸ä¸º null ä¸”æ˜¯æ•°ç»„
            
           // 1. æœ€ç»ˆæ˜¾ç¤ºçš„å›è®¿æ€»æ•° (æ’é™¤æ‰‹åŠ¨æ ¡å¯¹è®°å½•å’Œæ— æ•ˆå­¦å‘˜ID)
                       const done = Array.isArray(followUps) 
                           ? followUps.filter(f => f.monthStr === currentMonth && 
                                                   f.studentId !== 'manual_override' && 
                                                   students.some(s => s.id === f.studentId) // ä»…è®¡ç®—æœ‰æ•ˆçš„å­¦å‘˜ID
                                             ).reduce((s,r)=>s+r.count,0) 
                           : 0;
            const groupedData = useMemo(() => {
                const groups = classGroups.map(g => { 
                    const groupStudents = (g.studentIds || []).map(sid => students.find(s => s.id === sid)).filter(Boolean); 
                    return { id: g.id, name: g.name, students: groupStudents }; 
                });
                
                // æ‰¾å‡ºæœªåˆ†é…ç­çº§çš„å­¦ç”Ÿ
                const assignedStudentIds = new Set(); 
                classGroups.forEach(g => { if(g.studentIds) g.studentIds.forEach(sid => assignedStudentIds.add(sid)); });
                const unassignedStudents = students.filter(s => !assignedStudentIds.has(s.id));
                
                // æ·»åŠ æœªåˆ†é…ç­çº§ç»„
                if (unassignedStudents.length > 0) { 
                    groups.push({ id: 'unassigned', name: 'æœªåˆ†é…ç­çº§', students: unassignedStudents, isUnassigned: true }); 
                }
                return groups;
            }, [students, classGroups]);

            const toggle = async (sid, idx) => { 
                
                const ex = followUps.find(f => f.studentId === sid && f.monthStr === currentMonth); 
                const newCount = (ex && ex.count === idx + 1) ? idx : idx + 1; // åˆ‡æ¢é€»è¾‘
                
                if (ex) {
                    // æ›´æ–°ç°æœ‰è®°å½•ã€‚ç”±äº lcUpdate å†…éƒ¨ä¼šè°ƒç”¨ fetchAllï¼ŒUI å°†è‡ªåŠ¨æ›´æ–°ã€‚
                    await lcUpdate('FollowUp', ex.id, { count: newCount }); 
                } else {
                    // åˆ›å»ºæ–°è®°å½•ã€‚lcAdd å†…éƒ¨ä¼šè°ƒç”¨ fetchAllã€‚
                    await lcAdd('FollowUp', { studentId: sid, monthStr: currentMonth, count: newCount }); 
                }
                addToast(`å›è®¿æ¬¡æ•°å·²æ›´æ–°ä¸º ${newCount} æ¬¡`, "info");
            };
            
            const exportCSV = () => { 
                const rows = []; 
                groupedData.forEach(g => { 
                    g.students.forEach(s => { 
                        // å¿½ç•¥æ‰‹åŠ¨æ ¡å¯¹è®°å½•çš„å¯¼å‡º
						// æ–°å¢ï¼šæ£€æŸ¥è¯¥å­¦ç”ŸIDæ˜¯å¦å­˜åœ¨äºå½“å‰çš„ students åˆ—è¡¨ä¸­
	
                        if (!students.find(st => st.id === s.id)) return;
                        if (s.id === 'manual_override') return;
                        const rec = followUps.find(f => f.studentId === s.id && f.monthStr === currentMonth); 
                        rows.push([g.name, s.name, currentMonth, rec?rec.count:0]); 
                    }); 
                }); 
                exportToCSV(`å›è®¿_${currentMonth}.csv`, [['ç­çº§', 'å§“å','æœˆä»½','æ¬¡æ•°'], ...rows]); 
            };

            return (
                <div className="p-4 md:p-6 max-w-5xl mx-auto space-y-6 pb-24 md:pb-6 pt-16 md:pt-4 animate-enter">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-800 dark:text-white tracking-tight">å›è®¿ç®¡ç† <span className="text-sm font-normal text-gray-400 ml-2">({currentMonth})</span></h2>
                        <button onClick={exportCSV} className={`text-${theme.primary}-600 bg-${theme.primary}-50 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-${theme.primary}-100 transition-colors flex items-center gap-1`}>
                            <LucideIcon name="Download" size={14}/> å¯¼å‡ºè¡¨æ ¼
                        </button>
                    </div>
                    {/* è¿›åº¦å¡ç‰‡ */}
                    <div className={`bg-gradient-to-br from-${theme.primary}-500 to-${theme.primary}-700 text-white p-6 rounded-2xl shadow-xl shadow-${theme.primary}-500/20 flex justify-between text-center relative overflow-hidden group`}>
                        <div className="absolute top-0 right-0 p-8 opacity-10 transform translate-x-4 -translate-y-4 group-hover:scale-110 transition-transform duration-700"><LucideIcon name="TrendingUp" size={100}/></div>
                        <div className="flex-1 z-10">
                            <div className="text-xs opacity-75 mb-1 uppercase tracking-wider font-semibold">ç›®æ ‡</div>
                            <div className="text-3xl font-bold">{total}</div>
                        </div>
                        <div className="flex-1 z-10 border-l border-white/20 border-r">
                            <div className="text-xs opacity-75 mb-1 uppercase tracking-wider font-semibold">å®Œæˆ</div>
                            <div className="text-3xl font-bold">{done}</div>
                        </div>
                        <div className="flex-1 z-10">
                            <div className="text-xs opacity-75 mb-1 uppercase tracking-wider font-semibold">è¿›åº¦</div>
                            <div className="text-3xl font-bold text-yellow-300">{total>0?Math.round(done/total*100):0}%</div>
                        </div>
                    </div>
                    
                    
                    {/* å›è®¿åˆ—è¡¨ */}
                    <div className="space-y-6">
                        {groupedData.map((group, gIdx) => (
                            <div key={group.id} className={`bg-white dark:bg-slate-800 rounded-2xl shadow-sm border overflow-hidden transition-all hover:shadow-md animate-pop ${group.isUnassigned ? 'border-dashed border-gray-300' : 'border-gray-100 dark:border-slate-700'}`} style={{animationDelay: `${gIdx * 100}ms`}}>
                                <div className={`px-6 py-4 border-b border-gray-50 dark:border-slate-700 flex justify-between items-center ${group.isUnassigned ? 'bg-gray-50/50 dark:bg-slate-700/50' : 'bg-white dark:bg-slate-800'}`}>
                                    <h3 className="font-bold text-gray-700 dark:text-slate-200 flex items-center gap-2">
                                        {group.isUnassigned ? <LucideIcon name="Users" size={18} className="text-gray-400"/> : <LucideIcon name="Layers" size={18} className={`text-${theme.primary}-500`}/>}
                                        {group.name}
                                    </h3>
                                    <span className="text-xs font-bold bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-slate-400 px-2.5 py-1 rounded-full">{group.students.length} äºº</span>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="min-w-full divide-y divide-gray-50 dark:divide-slate-700">
                                        <thead className="bg-gray-50/30 dark:bg-slate-700/30">
                                            <tr>
                                                <th className="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase tracking-wider w-1/3">å­¦å‘˜</th>
                                                <th className="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase tracking-wider">æœ¬æœˆè¿›åº¦</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-50 dark:divide-slate-700 bg-white dark:bg-slate-800">
                                            {group.students.map(s => { 
                                                // å¿½ç•¥æ‰‹åŠ¨æ ¡å¯¹è®°å½•çš„æ˜¾ç¤º
                                                if (s.id === 'manual_override') return null;
												// å¿½ç•¥æ‰‹åŠ¨æ ¡å¯¹è®°å½•çš„æ˜¾ç¤º
												if (s.id === 'manual_override') return null;
												// ç¡®ä¿å­¦ç”Ÿ ID å­˜åœ¨äºå½“å‰çš„ students åˆ—è¡¨ä¸­
												if (!students.find(st => st.id === s.id)) return null; 
										
                                                const rec = followUps.find(f => f.studentId === s.id && f.monthStr === currentMonth); 
                                                const c = rec?.count||0; 
                                                return (
                                                    <tr key={s.id} className="hover:bg-gray-50/80 dark:hover:bg-slate-700/50 transition-colors group">
                                                        <td className="px-6 py-3.5 font-medium text-gray-700 dark:text-slate-300 flex items-center gap-3">
                                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shadow-sm ${c===2 ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'}`}>{s.name[0]}</div>
                                                            {s.name}
                                                        </td>
                                                        <td className="px-6 py-3.5">
                                                            <div className="flex items-center gap-2">
                                                                {[0,1,2].map(i => (
                                                                    <div 
                                                                        key={i} 
                                                                        onClick={()=>toggle(s.id, i)} 
                                                                        className={`w-8 h-8 rounded-lg flex items-center justify-center cursor-pointer transition-all duration-200 border ${
                                                                            i<c ? `bg-${theme.primary}-500 text-white border-${theme.primary}-600 shadow-md scale-110` : 
                                                                            'bg-white dark:bg-slate-700 text-gray-300 border-gray-200 dark:border-border-slate-600 hover:border-gray-300 hover:bg-gray-50 dark:hover:bg-slate-600'
                                                                        }`}
                                                                    >
                                                                        <LucideIcon name="CheckSquare" size={14}/>
                                                                    </div>
                                                                ))}
                                                                <span className="text-xs text-gray-400 ml-2 opacity-0 group-hover:opacity-100 transition-opacity transform translate-x-2 group-hover:translate-x-0 duration-300">
                                                                    {c === 0 ? 'æœªå¼€å§‹' : c === 1 ? 'è·Ÿè¿›ä¸­' : c === 2 ? 'å®Œæˆ' : 'å·²å½’æ¡£'}
                                                                </span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ); 
                                            })}
                                            {group.students.length === 0 && <tr><td colSpan="2" className="p-8 text-center text-gray-400 italic text-sm">ç©ºç©ºå¦‚ä¹Ÿ ~</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ))}
                        {groupedData.length === 0 && students.length === 0 && <div className="text-center py-16 bg-white dark:bg-slate-800 rounded-2xl border-2 border-dashed border-gray-200 dark:border-slate-700"><div className="text-gray-300 mb-2"><LucideIcon name="Users" size={48} className="mx-auto"/></div><p className="text-gray-400">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆå‰å¾€â€œå­¦å‘˜ç®¡ç†â€æ·»åŠ å­¦å‘˜</p></div>}
                    </div>
                    {/* ç§»é™¤æ‰‹åŠ¨æ ¡å¯¹æ¨¡æ€æ¡† */}
                </div>
            )
        }
       // 5. è€ƒå‹¤ç®¡ç†
// 5. è€ƒå‹¤ç®¡ç† (æ”¯æŒæ’¤é”€æ—¶è‡ªåŠ¨æ¸…ç†è¡¥è¯¾è¯¾ç¨‹)
       // 5. è€ƒå‹¤ç®¡ç† (æ”¯æŒæ’¤é”€æ—¶è‡ªåŠ¨æ¸…ç†è¡¥è¯¾è¯¾ç¨‹ & ç»Ÿè®¡é€»è¾‘ä¿®æ­£)
               const AttendanceManager = () => {
                   const { courses, students, attendanceMode, handleAttendanceModeChange, theme, formatDate, exportToCSV, lcUpdate, lcDelete, fetchAll, setActiveTab, setMakeupTarget } = useAppData(); 
                   const addToast = useToast(); 
                   const now = new Date();
                   const currentMonth = formatDate(now).slice(0,7);
                   const safeCourses = Array.isArray(courses) ? courses : [];
       
                   // =================================================================
                   // [é€»è¾‘ä¿®æ­£]: ç›®æ ‡å‡ºå‹¤(Target) æ’é™¤è¡¥è¯¾
                   // =================================================================
                   let target = 0;
                   if(attendanceMode === 'estimated') {
                       safeCourses.forEach(c => { 
                           // æ’é™¤ makeup
                           if(c.dateStr && c.dateStr.startsWith(currentMonth) && c.type !== 'demo' && c.type !== 'makeup') {
                               try { if (new Date(`${c.dateStr}T${c.startTime||'00:00'}`) <= now) target += (c.studentIds?.length || 0); } catch (e) {}
                           }
                       });
                   } else {
                       safeCourses.forEach(c => { 
                           // æ’é™¤ makeup
                           if(c.dateStr && c.dateStr.startsWith(currentMonth) && c.type !== 'demo' && c.type !== 'makeup') target += (c.studentIds?.length||0); 
                       });
                   }
                   
                   // =================================================================
                   // [é€»è¾‘ä¿®æ­£]: å®é™…å‡ºå‹¤(Actual) æ’é™¤è¡¥è¯¾è¯¾ç¨‹æœ¬èº« (å› ä¸ºåŸè¯¾ç¨‹å·²ç»è®°äº† 'isMadeUp')
                   // =================================================================
                   let actual = 0;
                   const absents = [];
                   safeCourses.forEach(c => { 
                       // æ’é™¤ makeupï¼Œé˜²æ­¢åŒé‡è®¡ç®—
                       if(c.dateStr && c.dateStr.startsWith(currentMonth) && c.type !== 'demo' && c.type !== 'makeup') { 
                           Object.values(c.attendance||{}).forEach(a => { 
                               // åŸè¯¾ç¨‹çš„çŠ¶æ€ï¼š'present' æˆ–è€… 'isMadeUp' éƒ½ç®—ä½œå®é™…å®Œæˆ
                               if(a.status==='present' || a.isMadeUp) actual++; 
                               
                               if(a.status==='absent') {
                                   const student = students.find(s => s.id === a.studentId);
                                   if(student) {
                                       absents.push({
                                           cname: c.className, date: c.dateStr, 
                                           sid: a.studentId, sname: student.name, cid: c.id,
                                           isMadeUp: a.isMadeUp 
                                       }); 
                                   }
                               }
                           }); 
                       } 
                   });
                   const rate = target > 0 ? (actual / target) * 100 : 0;
                   
                   // æ’¤é”€/è·³è½¬é€»è¾‘ (ä¿æŒä¸å˜)
                   const handleAction = (record) => {
                       if (record.isMadeUp) {
                           showConfirmModal(`ç¡®è®¤æ’¤é”€è¡¥è¯¾çŠ¶æ€ï¼Ÿ\n1. è¿”è¿˜å­¦å‘˜ 2 è¯¾æ—¶\n2. æ¢å¤â€œç¼ºå‹¤â€çŠ¶æ€\n3. åˆ é™¤å¯¹åº”çš„è¡¥è¯¾è¯¾ç¨‹`, async () => {
                               const course = courses.find(c => c.id === record.cid); 
                               const student = students.find(s => s.id === record.sid); 
                               if (!course || !student) return;
                               
                               const newAtt = { ...course.attendance, [record.sid]: { ...course.attendance[record.sid], isMadeUp: false } };
                               await lcUpdate('Course', record.cid, { attendance: newAtt }, true); 
                               
                               const newRemaining = (student.remainingHours || 0) + 2;
                               await lcUpdate('Student', record.sid, {remainingHours: newRemaining}, true); 
       
                               const makeupCourse = courses.find(c => c.type === 'makeup' && c.makeupMap && c.makeupMap[record.sid] === record.cid);
                               if (makeupCourse) {
                                   if (makeupCourse.studentIds && makeupCourse.studentIds.length > 1) {
                                       const newStudentIds = makeupCourse.studentIds.filter(id => id !== record.sid);
                                       const newMakeupMap = { ...makeupCourse.makeupMap };
                                       delete newMakeupMap[record.sid]; 
                                       const newMjAtt = { ...makeupCourse.attendance };
                                       delete newMjAtt[record.sid]; 
                                       await lcUpdate('Course', makeupCourse.id, { studentIds: newStudentIds, makeupMap: newMakeupMap, attendance: newMjAtt }, true);
                                       addToast("å·²æ’¤é”€çŠ¶æ€å¹¶ä»è¡¥è¯¾åå•ä¸­ç§»é™¤", "success");
                                   } else {
                                       await lcDelete('Course', makeupCourse.id); 
                                       addToast("å·²æ’¤é”€çŠ¶æ€å¹¶åˆ é™¤è¡¥è¯¾è¯¾ç¨‹", "success");
                                       return; 
                                   }
                               } else {
                                   addToast("å·²æ’¤é”€çŠ¶æ€ (æœªæ‰¾åˆ°å¯¹åº”è¡¥è¯¾è®°å½•)", "info");
                               }
                               await fetchAll(); 
                           });
                       } else {
                           setMakeupTarget(record);
                           setActiveTab('schedule');
                           addToast("æ­£åœ¨å‰å¾€æ’è¯¾ç•Œé¢...", "info");
                       }
                   };
       
                   return (
                       <div className="p-4 md:p-6 max-w-4xl mx-auto space-y-6 md:space-y-8 pb-24 md:pb-6 pt-16 md:pt-4 animate-enter">
                           {/* Header */}
                           <div className="flex flex-col md:flex-row justify-between items-center gap-3">
                               <h2 className="text-xl font-bold text-gray-800 dark:text-white">è€ƒå‹¤çœ‹æ¿ ({currentMonth})</h2>
                               <div className="flex gap-2 bg-white dark:bg-slate-700 p-1 rounded-lg shadow-sm border border-gray-200 dark:border-slate-600">
                                   <button onClick={()=>handleAttendanceModeChange('estimated')} className={`px-3 py-1.5 text-xs rounded-md transition-all ${attendanceMode==='estimated'?`bg-${theme.primary}-100 text-${theme.primary}-700 font-bold`:''}`}>å®æ—¶è¿›åº¦</button>
                                   <button onClick={()=>handleAttendanceModeChange('scheduled')} className={`px-3 py-1.5 text-xs rounded-md transition-all ${attendanceMode==='scheduled'?`bg-${theme.primary}-100 text-${theme.primary}-700 font-bold`:''}`}>ç²¾å‡†æ¨¡å¼</button>
                               </div>
                           </div>
                           {/* Stats Card */}
                           <div className={`p-6 rounded-xl shadow-lg text-white grid grid-cols-3 gap-4 text-center relative overflow-hidden ${rate>=94?'bg-gradient-to-br from-green-500 to-green-700':'bg-gradient-to-br from-red-500 to-red-700'}`}>
                               <div className="z-10"><div>ç›®æ ‡</div><div className="text-3xl font-bold">{target}</div></div>
                               <div className="z-10"><div>å®é™…</div><div className="text-3xl font-bold">{actual}</div></div>
                               <div className="z-10"><div>è¾¾æ ‡ç‡</div><div className="text-3xl font-bold">{rate.toFixed(1)}%</div></div>
                           </div>
       
                           <div className="bg-white dark:bg-slate-800 rounded-lg shadow-sm overflow-hidden border border-gray-200 dark:border-slate-700">
                               <div className="p-3 font-bold text-gray-600 dark:text-slate-300 text-xs bg-gray-50 dark:bg-slate-700 border-b border-gray-200 dark:border-slate-600 flex items-center gap-2"><LucideIcon name="AlertCircle" size={14} className="text-red-500"/> ç¼ºå‹¤åˆ—è¡¨ (ç‚¹å‡»æŒ‰é’®å¤„ç†)</div>
                               <table className="min-w-full divide-y divide-gray-100 dark:divide-slate-700">
                                   <tbody className="text-sm">
                                       {absents.map((r,i) => (
                                           <tr key={i} className="hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors">
                                               <td className="px-4 py-3 font-medium text-gray-800 dark:text-slate-200">{r.sname}</td>
                                               <td className="px-4 py-3 text-gray-500 dark:text-slate-400">{r.cname} <span className="text-xs text-gray-400">({r.date.slice(5)})</span></td>
                                               <td className="px-4 py-3 text-right">
                                                   <button 
                                                       onClick={()=>handleAction(r)} 
                                                       className={`px-3 py-1 rounded-full text-xs font-bold transition-colors shadow-sm border flex items-center gap-1 ml-auto ${r.isMadeUp ? 'bg-gray-100 text-gray-500 border-gray-200 hover:bg-gray-200' : 'bg-orange-100 text-orange-700 hover:bg-orange-200 border-orange-200'}`}
                                                   >
                                                       {r.isMadeUp ? "æ’¤é”€å·²è¡¥" : <><LucideIcon name="Plus" size={12}/> æ ‡è®°è¡¥è¯¾</>}
                                                   </button>
                                               </td>
                                           </tr>
                                       ))}
                                       {absents.length===0 && <tr><td colSpan="3" className="p-8 text-center text-gray-400 italic">ğŸ‰ æœ¬æœˆæ— ç¼ºå‹¤è®°å½•</td></tr>}
                                   </tbody>
                               </table>
                           </div>
                       </div>
                   )
               }
        // --- ä¸»ç¨‹åºå…¥å£ ---
// --- ä¸»ç¨‹åºå…¥å£ (ä¿®å¤ç‰ˆï¼šå·²æ‰¾å›æ•°æ®åŠ è½½é€»è¾‘) ---
        // --- ä¸»ç¨‹åºå…¥å£ (ä¿®å¤ç‰ˆï¼šå·²æ‰¾å›æ•°æ®åŠ è½½é€»è¾‘) ---
                function SchoolSystem() {
                    const addToast = useToast(); 
                    const [activeTab, setActiveTab] = useState('dashboard'); 
                    const [activeStudentId, setActiveStudentId] = useState(null); 
                    
                    // è¡¥è¯¾ç›®æ ‡æ•°æ®
                    const [makeupTarget, setMakeupTarget] = useState(null); 
        
                    // çŠ¶æ€å®šä¹‰
                    const [theme, setTheme] = useState(() => { const lsThemeId = localStorage.getItem('lms_theme_id'); const defaultTheme = THEMES[0]; return lsThemeId ? (THEMES.find(t => t.id === lsThemeId) || defaultTheme) : defaultTheme; });
                    const [rippleEffect, setRippleEffect] = useState(null);
                    // ä¿®æ­£ï¼šä» localStorage åŠ è½½èŒçº§ï¼Œä½¿ç”¨é»˜è®¤å€¼ 'åˆçº§ 2 çº§'
                    const [teacherLevel, setTeacherLevel] = useState(localStorage.getItem('lms_teacher_level') || 'åˆçº§ 2 çº§');
                    const [classFeeBase, setClassFeeBase] = useState(Number(localStorage.getItem('lms_class_fee_base')) || 8);
                    const [showTodayIncome, setShowTodayIncome] = useState(() => { const saved = localStorage.getItem('lms_show_today_income'); return saved !== null ? JSON.parse(saved) : true; });
                    const [quotes, setQuotes] = useState(() => { try { const saved = JSON.parse(localStorage.getItem('lms_quotes')); return (saved && saved.length > 0) ? saved : DEFAULT_QUOTES; } catch(e) { return DEFAULT_QUOTES; } });
                    const [isThemeModalOpen, setIsThemeModalOpen] = useState(false);
                    const [attendanceMode, setAttendanceMode] = useState(localStorage.getItem('lms_attendance_mode') || 'scheduled');
                    const [loading, setLoading] = useState(false);
                    
                    // æ ¸å¿ƒæ•°æ®çŠ¶æ€
                    const [students, setStudents] = useState([]);
                    const [courses, setCourses] = useState([]);
                    const [followUps, setFollowUps] = useState([]);
                    const [classGroups, setClassGroups] = useState([]);
                    const [recurringSchedules, setRecurringSchedules] = useState([]);
                    
                    const [currentWeekStart, setCurrentWeekStart] = useState(new Date());
                    const [viewMode, setViewMode] = useState('week'); 
        
                    // è¾…åŠ©å‡½æ•°
                    const calendarDays = useMemo(() => { const days = []; let start = new Date(currentWeekStart); if (viewMode === 'day') { days.push(new Date(start)); } else if (viewMode === 'week') { const day = start.getDay(); const diff = start.getDate() - day + (day === 0 ? -6 : 1); start.setDate(diff); for(let i=0; i<7; i++){ days.push(new Date(start)); start.setDate(start.getDate()+1); } } else if (viewMode === 'month') { start.setDate(1); const dayOfWeek = start.getDay(); const offset = (dayOfWeek + 6) % 7; start.setDate(start.getDate() - offset); for(let i=0; i<42; i++) { days.push(new Date(start)); start.setDate(start.getDate()+1); } } return days; }, [currentWeekStart, viewMode]);
                    const changeWeek = (offset) => { const newDate = new Date(currentWeekStart); if (viewMode === 'day') newDate.setDate(newDate.getDate() + offset); else if (viewMode === 'week') newDate.setDate(newDate.getDate() + offset * 7); else if (viewMode === 'month') newDate.setMonth(newDate.getMonth() + offset); setCurrentWeekStart(newDate); };
                    const formatDate = (date) => { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };
                    const getPredictionText = useCallback((remaining) => { if (remaining <= 0) return "å·²æ¬ è´¹"; const hoursToDeplete = remaining; const daysToDeplete = (hoursToDeplete / 8) * 30; const targetDate = new Date(); targetDate.setDate(targetDate.getDate() + daysToDeplete); const dateStr = `${targetDate.getMonth()+1}æœˆ${targetDate.getDate()}æ—¥`; if (remaining <= 4) return `é¢„è®¡${dateStr}ç”¨å°½ (å‰©ä½™4è¯¾æ¬¡è­¦å‘Š)`; if (remaining <= 8) return `é¢„è®¡${dateStr}ç”¨å°½ (å‰©ä½™8è¯¾æ¬¡æé†’)`; return `é¢„è®¡${dateStr}ç”¨å°½`; }, []);
                    
                    // CRUD å‡½æ•°
                    const lcAdd = async (className, data, recurring = null) => { if (typeof AV === 'undefined' || !window.isLCReady) { addToast("äº‘ç«¯æœåŠ¡æœªè¿æ¥ï¼Œè¯·åˆ·æ–°é‡è¯•", "error"); return false; } try { if (className === 'Course' && recurring && recurring.isRecurring) { const { recurringDays, repeatWeeks } = recurring; if (!recurringDays || recurringDays.length === 0 || repeatWeeks <= 0) { addToast("å‘¨æœŸæ€§æ’è¯¾é…ç½®ä¸å®Œæ•´", "error"); return false; } const today = new Date(); const currentDayOfWeek = today.getDay(); const diffToMonday = currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1; const startDate = new Date(today); startDate.setDate(today.getDate() - diffToMonday); const finalEndDate = new Date(startDate); finalEndDate.setDate(startDate.getDate() + (repeatWeeks * 7)); let totalCourses = 0; let currentDate = new Date(startDate); while (currentDate < finalEndDate) { const dayOfWeek = currentDate.getDay(); const dayIndex = (dayOfWeek === 0) ? 6 : dayOfWeek - 1; if (recurringDays.includes(dayIndex)) { const Obj = AV.Object.extend(className); const obj = new Obj(); const courseDateStr = formatDate(currentDate); Object.keys(data).forEach(k => { if (['id', 'objectId', 'createdAt', 'updatedAt'].includes(k)) return; obj.set(k, data[k]); }); obj.set('dateStr', courseDateStr); obj.set('dayOfWeek', dayIndex); obj.set('studentIds', data.studentIds || []); await obj.save(); totalCourses++; } currentDate.setDate(currentDate.getDate() + 1); } if (totalCourses > 0) { addToast(`å·²æˆåŠŸæ‰¹é‡åˆ›å»º ${totalCourses} èŠ‚è¯¾ç¨‹ (${repeatWeeks} å‘¨)`, "success"); lcAdd('RecurringSchedule', { name: data.className, classGroupIds: data.classGroupIds, type: data.type, startTime: data.startTime, endTime: data.endTime, content: data.content, recurringDays, repeatWeeks }); } else { addToast("æœªåˆ›å»ºä»»ä½•è¯¾ç¨‹ï¼Œè¯·æ£€æŸ¥é‡å¤æ—¥è®¾ç½®", "error"); } await fetchAll(); return true; } const Obj = AV.Object.extend(className); const obj = new Obj(); Object.keys(data).forEach(k => { if (['id', 'objectId', 'createdAt', 'updatedAt'].includes(k)) return; obj.set(k, data[k]); }); await obj.save(); await fetchAll(); return true; } catch (e) { addToast("ä¿å­˜å¤±è´¥: " + e.message, "error"); return false; } };
                    const lcUpdate = async (className, id, data, skipFetch = false) => { if (typeof AV === 'undefined' || !window.isLCReady) { addToast("äº‘ç«¯æœåŠ¡æœªè¿æ¥ï¼Œè¯·åˆ·æ–°é‡è¯•", "error"); return false; } try { const obj = AV.Object.createWithoutData(className, id); Object.keys(data).forEach(k => { if (['id', 'objectId', 'createdAt', 'updatedAt'].includes(k)) return; obj.set(k, data[k]); }); await obj.save(); if (!skipFetch) { await fetchAll(); } return true; } catch (e) { addToast("æ›´æ–°å¤±è´¥: " + e.message, "error"); return false; } };
                    const lcDelete = async (className, id) => { if (typeof AV === 'undefined' || !window.isLCReady) { addToast("äº‘ç«¯æœåŠ¡æœªè¿æ¥ï¼Œè¯·åˆ·æ–°é‡è¯•", "error"); return false; } try { const obj = AV.Object.createWithoutData(className, id); await obj.destroy(); await fetchAll(); return true; } catch (e) { addToast("åˆ é™¤å¤±è´¥: " + e.message, "error"); return false; } };
                    const exportToCSV = (filename, rows) => { try { const processRow = (row) => row.map(val => `"${String(val).replace(/"/g, '""')}"`).join(","); const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + rows.map(processRow).join("\n"); const link = document.createElement("a"); link.href = encodeURI(csvContent); link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); addToast("å¯¼å‡ºæˆåŠŸ", "success"); } catch (e) { addToast("å¯¼å‡ºå¤±è´¥", "error"); } };
                    
                    // æ•°æ®æ‹‰å–å‡½æ•°
                    const fetchAll = useCallback(async () => { if (typeof AV === 'undefined' || !window.isLCReady) return; setLoading(true); try { const fetchTableSafe = async (className) => { try { const q = new AV.Query(className); q.limit(1000); const results = await q.find(); return results.map(item => ({...item.attributes, id: item.id, createdAt: item.createdAt, updatedAt: item.updatedAt})); } catch (err) { if (err.code === 101) return []; console.warn(`Fetch ${className} failed:`, err); return []; } }; const s = await fetchTableSafe('Student'); const c = await fetchTableSafe('Course'); const g = await fetchTableSafe('ClassGroup'); const f = await fetchTableSafe('FollowUp'); const r = await fetchTableSafe('RecurringSchedule'); setStudents(s); setCourses(c); setClassGroups(g); setFollowUps(f); setRecurringSchedules(r); } catch (error) { console.error("Fetch error", error); } finally { setLoading(false); } }, [addToast]);
                    
                    const handleThemeChange = useCallback((t, event) => { let x = window.innerWidth / 2; let y = window.innerHeight / 2; if (event && event.clientX !== undefined && event.clientY !== undefined) { x = event.clientX; y = event.clientY; } else { const paletteButton = document.querySelector('.bottom-8.right-8 button'); if (paletteButton) { const rect = paletteButton.getBoundingClientRect(); x = rect.left + rect.width / 2; y = rect.top + rect.height / 2; } } const newPrimaryColorClass = `bg-${t.primary}-500`; setRippleEffect({ x, y, colorClass: newPrimaryColorClass, onEnd: () => { setTheme(t); localStorage.setItem('lms_theme_id', t.id); setIsThemeModalOpen(false); if (t.isDark) { document.documentElement.classList.add('dark'); } else { document.documentElement.classList.remove('dark'); } setRippleEffect(null); } }); }, []);
                    const ThemeTransitionRipple = React.memo(({ effect, duration }) => { if (!effect) return null; return ( <div className="theme-transition-layer" style={{ zIndex: 70 }} > <div className={`ripple-circle ${effect.colorClass} fixed`} style={{ left: `${effect.x}px`, top: `${effect.y}px`, animation: `ripple-expand ${duration}ms cubic-bezier(0.4, 0, 0.2, 1) forwards`, }} onAnimationEnd={effect.onEnd} /> </div> ); });
                    const handleAttendanceModeChange = (m) => { setAttendanceMode(m); localStorage.setItem('lms_attendance_mode', m); };
        
                    // =================================================================
                    // [ä¿®å¤]ï¼šè¡¥å›äº†åˆå§‹åŒ– useEffectï¼Œæ•°æ®ç°åœ¨ä¼šè‡ªåŠ¨åŠ è½½äº†ï¼
                    // =================================================================
                    useEffect(() => {
                        // æ¢å¤ä¸»é¢˜
                        const lsTheme = localStorage.getItem('lms_theme_id');
                        if (lsTheme) {
                            const savedTheme = THEMES.find(t => t.id === lsTheme) || theme;
                            setTheme(savedTheme);
                            if (savedTheme.isDark) document.documentElement.classList.add('dark');
                            else document.documentElement.classList.remove('dark');
                        }
                        
                        // åˆå§‹åŒ– LeanCloud æ•°æ®
                        setTimeout(() => {
                            if(window.isLCReady) fetchAll();
                        }, 500);
                    }, [fetchAll]);
        
                    // æ„å»ºå…¨å±€ Context
                    const contextValue = {
                        students, setStudents, courses, setCourses, followUps, setFollowUps, classGroups, setClassGroups, recurringSchedules, setRecurringSchedules, theme, setTheme, activeTab, setActiveTab, activeStudentId, setActiveStudentId, attendanceMode, handleAttendanceModeChange, loading, setLoading, currentWeekStart, setCurrentWeekStart, weekDays: calendarDays, changeWeek, calendarDays, formatDate, viewMode, setViewMode, teacherLevel, setTeacherLevel, classFeeBase, setClassFeeBase, fetchAll, exportToCSV, lcAdd, lcUpdate, lcDelete, quotes, setQuotes, showTodayIncome, setShowTodayIncome, handleThemeChange, getPredictionText,
                        makeupTarget, setMakeupTarget 
                    };
        
                    return (
                        <AppDataContext.Provider value={contextValue}>
                             <div className="flex h-screen bg-gray-100 dark:bg-slate-900 flex-col md:flex-row overflow-hidden font-sans transition-colors duration-300">
                                <div className={`hidden md:flex w-64 glass-sidebar flex-col z-20`}>
                                    <div className="p-6 text-2xl font-bold border-b border-gray-200/50 dark:border-white/10 flex items-center gap-3 tracking-tight"><div className={`w-10 h-10 rounded-xl bg-${theme.primary}-500 flex items-center justify-center shadow-lg text-white`}><LucideIcon name="Award" size={24}/></div><span className="text-slate-800 dark:text-white">Veape Studio</span></div>
                                    <nav className="flex-1 py-6 space-y-1 overflow-y-auto px-3">
                                        {['dashboard','schedule','groups','students','followup','attendance'].map(k=><button key={k} onClick={()=>{setActiveTab(k); setActiveStudentId(null); setMakeupTarget(null);}} className={`w-full text-left px-4 py-3 rounded-2xl flex items-center gap-3 transition-all duration-200 ${activeTab===k?`bg-${theme.primary}-50 dark:bg-slate-700 text-${theme.primary}-600 dark:text-white shadow-sm font-bold`:'text-slate-500 dark:text-slate-400 hover:bg-white/60 dark:hover:bg-slate-800 hover:text-slate-800 dark:hover:text-white'}`}><LucideIcon name={k==='dashboard'?'Home':k==='schedule'?'Calendar':k==='groups'?'Layers':k==='students'?'Users':k==='followup'?'PhoneCall':'CheckSquare'} size={18} /> {k==='dashboard'?'æ¦‚è§ˆ':k==='schedule'?'è¯¾ç¨‹ç®¡ç†':k==='groups'?'ç­çº§ç®¡ç†':k==='students'?'å­¦å‘˜ç®¡ç†':k==='followup'?'å›è®¿ç®¡ç†':'è€ƒå‹¤ç®¡ç†'}</button>)}
                                        <div className="my-2 border-t border-gray-200/50 dark:border-white/10"></div>
                                        <button onClick={()=>{setActiveTab('settings'); setActiveStudentId(null); setMakeupTarget(null);}} className={`w-full text-left px-4 py-3 rounded-2xl flex items-center gap-3 transition-all duration-200 ${activeTab==='settings'?`bg-${theme.primary}-50 dark:bg-slate-700 text-${theme.primary}-600 dark:text-white shadow-sm`:'text-slate-500 dark:text-slate-400 hover:bg-white/60 dark:hover:bg-slate-800 hover:text-slate-800 dark:hover:text-white'}`}><LucideIcon name="Settings" size={18}/> ç³»ç»Ÿè®¾ç½®</button>
                                    </nav>
                                    <div className="p-4 border-t border-gray-200/50 dark:border-white/10">{loading ? <div className="text-center text-xs text-slate-400 flex justify-center gap-2"><div className="spinner w-3 h-3 border-slate-300 border-t-blue-500"></div> åŒæ­¥ä¸­...</div> : <div className="mt-3 text-[10px] text-center text-slate-400 font-mono flex justify-center items-center gap-1.5 cursor-pointer hover:text-green-500 transition-colors" onClick={fetchAll} title="ç‚¹å‡»åˆ·æ–°"><span className={`w-2 h-2 rounded-full bg-green-500`}></span> LeanCloud åœ¨çº¿ <LucideIcon name="RefreshCw" size={10} /></div>}</div>
                                </div>
                                <div className="flex-1 flex flex-col overflow-hidden relative bg-white/50 dark:bg-slate-900/50">
                                    <div className="absolute top-2 right-2 z-10 flex gap-2 md:hidden"><button onClick={(e)=> {e.stopPropagation(); setIsThemeModalOpen(true);}} className="bg-white dark:bg-slate-800 p-2 rounded-full shadow-md border border-gray-100 dark:border-slate-700 text-gray-600 dark:text-gray-300"><LucideIcon name="Palette" size={18}/></button></div>
                                    <div className="hidden md:block fixed bottom-8 right-8 z-50"><button onClick={(e)=> {e.stopPropagation(); setIsThemeModalOpen(true);}} className="glass-panel p-3 rounded-full hover:scale-110 transition-transform flex items-center gap-2 text-slate-600 dark:text-slate-300 hover-jelly"><LucideIcon name="Palette" size={20}/><span className="font-medium text-sm">ä¸»é¢˜é£æ ¼</span></button></div>
                                    <div className="flex-1 overflow-auto scroll-smooth">
                                        <div className="max-w-7xl mx-auto w-full h-full">
                                            {activeStudentId ? (<StudentDetailPage studentId={activeStudentId} onBack={() => setActiveStudentId(null)} />) : (
                                                <>
                                                    {activeTab==='dashboard' && <Dashboard />}
                                                    {activeTab==='schedule' && <CourseSchedule />}
                                                    {activeTab==='groups' && <ClassGroupManager />}
                                                    {activeTab==='students' && <StudentManager />}
                                                    {activeTab==='followup' && <FollowUpManager />}
                                                    {activeTab==='attendance' && <AttendanceManager />}
                                                    {activeTab==='settings' && <SettingsManager />}
                                                </>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                <div className={`md:hidden fixed bottom-0 w-full bg-white/90 dark:bg-slate-900/90 backdrop-blur border-t border-gray-200 dark:border-slate-800 flex justify-around p-2 pb-safe z-50 shadow-lg overflow-x-auto`}>
                                    {['dashboard','schedule','groups','students','attendance','followup','settings'].map(k => (
                                        <button key={k} onClick={()=>{setActiveTab(k); setActiveStudentId(null); setMakeupTarget(null);}} className={`flex flex-col items-center p-2 rounded-xl min-w-[3.5rem] transition-all duration-300 ${activeTab===k?`text-${theme.primary}-600 dark:text-blue-400 bg-${theme.primary}-50 dark:bg-slate-800 scale-105`:'text-gray-400 dark:text-slate-500'}`}><LucideIcon name={k==='dashboard'?'Home':k==='schedule'?'Calendar':k==='groups'?'Layers':k==='students'?'Users':k==='attendance'?'CheckSquare':k==='followup'?'PhoneCall':'Settings'} size={20}/><span className="text-[10px] mt-1 font-medium scale-90">{k==='dashboard'?'æ¦‚è§ˆ':k==='schedule'?'æ’è¯¾':k==='groups'?'ç­çº§':k==='students'?'å­¦å‘˜':k==='attendance'?'è€ƒå‹¤':k==='followup'?'å›è®¿':'è®¾ç½®'}</span></button>
                                    ))}
                                </div>
                                <Modal isOpen={isThemeModalOpen} onClose={()=>setIsThemeModalOpen(false)} title="ä¸»é¢˜é£æ ¼"><div className="grid grid-cols-2 gap-3">{THEMES.map(t=>(<button key={t.id} onClick={(e) => handleThemeChange(t, e)} className={`p-3 border rounded-xl flex gap-3 items-center text-sm font-medium transition-all ${theme.id===t.id?`bg-${t.primary}-50/80 dark:bg-slate-700 border-${t.primary}-500/80 text-${t.primary}-700 dark:text-white ring-2 ring-${t.primary}-200 dark:ring-slate-600 shadow-md`:'hover:bg-gray-50 dark:hover:bg-slate-700/50 hover:border-gray-300 dark:border-slate-700 text-slate-700 dark:text-slate-300'}`}><div className={`w-6 h-6 rounded-full bg-${t.primary}-500 shadow-sm ring-2 ring-white dark:ring-slate-800`}></div>{t.name}</button>))}</div></Modal>
                                <ThemeTransitionRipple effect={rippleEffect} duration={600} />
                            </div>
                        </AppDataContext.Provider>
                    );
                }
        const App = () => { return <ToastProvider><SchoolSystem /></ToastProvider>; };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
	</body>
</html>