<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœ¬åœ°æ•™åŠ¡ç®¡ç†ç³»ç»Ÿ (ç¨³å®šç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        /* é€‚é… iPhone åº•éƒ¨å®‰å…¨åŒº */
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        @keyframes slide-down {
            from { transform: translateY(-100%) translateX(-50%); opacity: 0; }
            to { transform: translateY(0) translateX(-50%); opacity: 1; }
        }
        .toast-enter { animation: slide-down 0.3s ease-out forwards; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scale-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-overlay { animation: fade-in 0.2s ease-out forwards; }
        .modal-content { animation: scale-in 0.2s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 text-sm md:text-base text-gray-800 select-none md:select-text">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useContext, createContext, useCallback } = React;

        // --- å…¨å±€å¸¸é‡: ä¸»é¢˜é…ç½® ---
        const THEMES = [
            { id: 'blue', name: 'ç»å…¸è“', primary: 'blue', sidebar: 'slate' },
            { id: 'emerald', name: 'æ£®ç³»ç»¿', primary: 'emerald', sidebar: 'zinc' },
            { id: 'violet', name: 'ç½—å…°ç´«', primary: 'violet', sidebar: 'neutral' },
            { id: 'rose', name: 'ç«ç‘°çº¢', primary: 'rose', sidebar: 'stone' },
            { id: 'amber', name: 'æ´»åŠ›æ©™', primary: 'orange', sidebar: 'stone' },
            { id: 'cyan', name: 'ç¢§æµ·è“', primary: 'cyan', sidebar: 'slate' },
            { id: 'fuchsia', name: 'å¹»å½±ç´«', primary: 'fuchsia', sidebar: 'neutral' },
            { id: 'teal', name: 'æ¾çŸ³ç»¿', primary: 'teal', sidebar: 'zinc' },
            { id: 'indigo', name: 'æ˜Ÿç©ºè“', primary: 'indigo', sidebar: 'slate' },
        ];

        // --- åŸºç¡€è®¾æ–½ç»„ä»¶ ---

        // 1. Toast æç¤ºä¸Šä¸‹æ–‡
        const ToastContext = createContext(null);
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            
            const addToast = useCallback((msg, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => removeToast(id), 3000);
            }, []);

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            return (
                <ToastContext.Provider value={addToast}>
                    {children}
                    <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col gap-2 w-full max-w-xs pointer-events-none">
                        {toasts.map(t => (
                            <div key={t.id} className={`toast-enter pointer-events-auto px-4 py-3 rounded-lg shadow-lg text-white text-sm font-medium flex items-center justify-between ${t.type === 'error' ? 'bg-red-500' : t.type === 'success' ? 'bg-green-600' : 'bg-gray-800'}`}>
                                <span>{t.msg}</span>
                                <button onClick={() => removeToast(t.id)} className="ml-4 opacity-75 hover:opacity-100">âœ•</button>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };
        const useToast = () => {
            const context = useContext(ToastContext);
            if (!context) return () => {}; 
            return context;
        };

        // 2. å›¾æ ‡ç»„ä»¶
        const Icon = ({ path, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        
        const icons = {
            Users: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
            Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
            PhoneCall: <><path d="M15.05 5A5 5 0 0 1 19 8.95M15.05 1A9 9 0 0 1 23 8.94m-1 7.98v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></>,
            CheckSquare: <><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>,
            ClipboardList: <><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></>,
            Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
            Trash2: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>,
            Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
            X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
            ChevronLeft: <><polyline points="15 18 9 12 15 6"/></>,
            ChevronRight: <><polyline points="9 18 15 12 9 6"/></>,
            Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
            UserCheck: <><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></>,
            UserX: <><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></>,
            AlertCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
            Layers: <><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>,
            Palette: <><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.01 17.461 2 12 2z"/></>,
            TrendingUp: <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>,
            TrendingDown: <><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></>,
            Sliders: <><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></>,
            Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>,
            Search: <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
        };

        const LucideIcon = ({ name, size = 20, className }) => {
            const path = icons[name];
            return <Icon path={path || icons.Users} size={size} className={className} />;
        };

        // 3. æ¨¡æ€æ¡†ç»„ä»¶ (ç‚¹å‡»é®ç½©å…³é—­)
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4 safe-area-pb modal-overlay"
                    onClick={onClose} 
                >
                    <div 
                        className="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[85vh] overflow-y-auto modal-content flex flex-col"
                        onClick={(e) => e.stopPropagation()} 
                    >
                        <div className="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-10 shrink-0">
                            <h3 className="text-lg font-bold text-gray-800 truncate pr-4">{title}</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition-colors">
                                <LucideIcon name="X" size={24} />
                            </button>
                        </div>
                        <div className="p-4">{children}</div>
                    </div>
                </div>
            );
        };

        // --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ç»„ä»¶ ---
        function SchoolSystem() {
            const addToast = useToast(); 
            const [activeTab, setActiveTab] = useState('schedule');
            const [theme, setTheme] = useState(THEMES[0]);
            const [isThemeModalOpen, setIsThemeModalOpen] = useState(false);
            const [attendanceMode, setAttendanceMode] = useState('scheduled');
            
            // æ•°æ®çŠ¶æ€
            const [students, setStudents] = useState([]);
            const [courses, setCourses] = useState([]);
            const [followUps, setFollowUps] = useState([]);
            const [classGroups, setClassGroups] = useState([]);
            
            // IDç”Ÿæˆå™¨
            const generateId = () => Math.random().toString(36).substr(2, 9);
            
            // æ—¥æœŸæ ¼å¼åŒ– (ä¿®å¤æ—¶åŒºé—®é¢˜: ä½¿ç”¨æœ¬åœ°æ—¶é—´)
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            // åˆå§‹åŒ–åŠ è½½ (å¸¦å¼‚å¸¸å¤„ç†)
            useEffect(() => {
                const safeParse = (key) => { try { return JSON.parse(localStorage.getItem(key)) || []; } catch (e) { return []; } };
                setStudents(safeParse('lms_students'));
                setCourses(safeParse('lms_courses'));
                setFollowUps(safeParse('lms_followups'));
                setClassGroups(safeParse('lms_class_groups'));
                
                const lsTheme = localStorage.getItem('lms_theme_id');
                if (lsTheme) setTheme(THEMES.find(t => t.id === lsTheme) || THEMES[0]);
                
                const lsMode = localStorage.getItem('lms_attendance_mode');
                if (lsMode) setAttendanceMode(lsMode);
            }, []);

            // æ•°æ®æŒä¹…åŒ– (è‡ªåŠ¨ä¿å­˜åˆ° LocalStorage)
            useEffect(() => { localStorage.setItem('lms_students', JSON.stringify(students)); }, [students]);
            useEffect(() => { localStorage.setItem('lms_courses', JSON.stringify(courses)); }, [courses]);
            useEffect(() => { localStorage.setItem('lms_followups', JSON.stringify(followUps)); }, [followUps]);
            useEffect(() => { localStorage.setItem('lms_class_groups', JSON.stringify(classGroups)); }, [classGroups]);

            const handleThemeChange = (t) => { setTheme(t); localStorage.setItem('lms_theme_id', t.id); setIsThemeModalOpen(false); };
            const handleAttendanceModeChange = (m) => { setAttendanceMode(m); localStorage.setItem('lms_attendance_mode', m); };

            // å‘¨å†çŠ¶æ€
            const [currentWeekStart, setCurrentWeekStart] = useState(new Date());
            const weekDays = useMemo(() => {
                const days = [];
                let start = new Date(currentWeekStart);
                const day = start.getDay();
                // è°ƒæ•´ä¸ºå‘¨ä¸€ä½œä¸ºå¼€å§‹ (0=å‘¨æ—¥, 1=å‘¨ä¸€...)
                const diff = start.getDate() - day + (day === 0 ? -6 : 1);
                start.setDate(diff);
                for(let i=0; i<7; i++){ 
                    days.push(new Date(start)); 
                    start.setDate(start.getDate()+1); 
                }
                return days;
            }, [currentWeekStart]);

            const changeWeek = (offset) => {
                const newDate = new Date(currentWeekStart);
                newDate.setDate(newDate.getDate() + offset * 7);
                setCurrentWeekStart(newDate);
            };

            // å¯¼å‡º CSV è¾…åŠ©å‡½æ•°
            const exportToCSV = (filename, rows) => {
                try {
                    const processRow = (row) => row.map(val => `"${String(val).replace(/"/g, '""')}"`).join(",");
                    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + rows.map(processRow).join("\n");
                    const link = document.createElement("a");
                    link.href = encodeURI(csvContent);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    addToast("å¯¼å‡ºæˆåŠŸ", "success");
                } catch (e) {
                    addToast("å¯¼å‡ºå¤±è´¥", "error");
                }
            };

            // --- æ¨¡å— 1: å­¦å‘˜ç®¡ç† ---
            const StudentManager = () => {
                const [isAddOpen, setIsAddOpen] = useState(false);
                const [newStudent, setNewStudent] = useState({ gender: 'ç”·' });
                const [searchTerm, setSearchTerm] = useState('');
                
                const handleSave = () => {
                    if (!newStudent.name) return addToast("è¯·å¡«å†™å§“å", "error");
                    if (newStudent.id) {
                        setStudents(prev => prev.map(s => s.id === newStudent.id ? newStudent : s));
                    } else {
                        setStudents(prev => [...prev, { ...newStudent, id: generateId() }]);
                    }
                    setIsAddOpen(false); setNewStudent({ gender: 'ç”·' });
                    addToast("ä¿å­˜æˆåŠŸ", "success");
                };
                const handleDelete = (id) => { if(confirm('ç¡®è®¤åˆ é™¤è¯¥å­¦å‘˜?')) { setStudents(prev => prev.filter(s => s.id !== id)); addToast("å·²åˆ é™¤", "info"); }};
                
                const filteredStudents = (students || []).filter(s => s.name && s.name.toLowerCase().includes(searchTerm.toLowerCase()));

                return (
                    <div className="p-4 space-y-4 pb-24 md:pb-4 pt-16 md:pt-4">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-3">
                            <h2 className="text-xl font-bold text-gray-800">å­¦å‘˜ç®¡ç†</h2>
                            <div className="flex gap-2 w-full md:w-auto">
                                <div className="relative flex-1 md:w-64">
                                    <input className="w-full pl-9 pr-4 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" placeholder="æœç´¢å§“å..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                    <div className="absolute left-3 top-2.5 text-gray-400"><LucideIcon name="Search" size={16} /></div>
                                </div>
                                <button onClick={() => { setNewStudent({gender:'ç”·'}); setIsAddOpen(true); }} className={`bg-${theme.primary}-600 text-white px-3 py-2 rounded-lg flex items-center gap-2 text-sm shadow hover:bg-${theme.primary}-700 active:scale-95 transition-all`}>
                                    <LucideIcon name="Plus" size={16} /> æ·»åŠ 
                                </button>
                            </div>
                        </div>
                        <div className="bg-white rounded-lg shadow-sm overflow-x-auto border border-gray-200">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-medium text-gray-500">å§“å</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500">æ€§åˆ«</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500">å¹´é¾„</th><th className="px-6 py-3 text-right text-xs font-medium text-gray-500">æ“ä½œ</th></tr></thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredStudents.length > 0 ? filteredStudents.map(s => (
                                        <tr key={s.id} className="hover:bg-gray-50 transition-colors">
                                            <td className="px-6 py-4 font-medium text-gray-900">{s.name}</td><td className="px-6 py-4 text-gray-600">{s.gender}</td><td className="px-6 py-4 text-gray-600">{s.age}</td>
                                            <td className="px-6 py-4 text-right"><button onClick={() => {setNewStudent(s); setIsAddOpen(true)}} className={`text-${theme.primary}-600 mr-3 text-sm hover:underline`}>ç¼–è¾‘</button><button onClick={() => handleDelete(s.id)} className="text-red-500 text-sm hover:underline">åˆ é™¤</button></td>
                                        </tr>
                                    )) : <tr><td colSpan="4" className="px-6 py-8 text-center text-gray-400">æœªæ‰¾åˆ°ç›¸å…³å­¦å‘˜</td></tr>}
                                </tbody>
                            </table>
                        </div>
                        <Modal isOpen={isAddOpen} onClose={() => setIsAddOpen(false)} title={newStudent.id ? "ç¼–è¾‘å­¦å‘˜" : "æ·»åŠ å­¦å‘˜"}>
                            <div className="space-y-4">
                                <div><label className="text-xs font-bold text-gray-500">å§“å</label><input className="w-full border p-2 rounded mt-1" placeholder="è¾“å…¥å§“å" value={newStudent.name||''} onChange={e=>setNewStudent({...newStudent, name:e.target.value})} /></div>
                                <div className="flex gap-4">
                                    <div className="flex-1"><label className="text-xs font-bold text-gray-500">æ€§åˆ«</label><select className="w-full border p-2 rounded mt-1 bg-white" value={newStudent.gender||'ç”·'} onChange={e=>setNewStudent({...newStudent, gender:e.target.value})}><option>ç”·</option><option>å¥³</option></select></div>
                                    <div className="flex-1"><label className="text-xs font-bold text-gray-500">å¹´é¾„</label><input className="w-full border p-2 rounded mt-1" type="number" placeholder="0" value={newStudent.age||''} onChange={e=>setNewStudent({...newStudent, age:e.target.value})} /></div>
                                </div>
                                <div>
                                    <div className="flex justify-between mb-1"><label className="text-xs font-bold text-gray-500">å¤‡æ³¨ä¿¡æ¯</label></div>
                                    <textarea className="w-full border p-2 rounded h-24 text-sm" placeholder="è¾“å…¥å­¦å‘˜æƒ…å†µ..." value={newStudent.notes||''} onChange={e=>setNewStudent({...newStudent, notes:e.target.value})}></textarea>
                                </div>
                                <button onClick={handleSave} className={`w-full bg-${theme.primary}-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-${theme.primary}-700 transition-colors shadow-md`}>ä¿å­˜å­¦å‘˜ä¿¡æ¯</button>
                            </div>
                        </Modal>
                    </div>
                )
            };

            // --- æ¨¡å— 2: è¯¾ç¨‹ç®¡ç† ---
            const CourseSchedule = () => {
                const [selectedCourse, setSelectedCourse] = useState(null);
                const [isEditOpen, setIsEditOpen] = useState(false);
                const [newCourse, setNewCourse] = useState({});

                const handleCellClick = (dStr, dayIndex) => {
                    setNewCourse({ dateStr: dStr, dayOfWeek: dayIndex, startTime: '09:00', endTime: '10:00', studentIds: [], tasks: {}, attendance: {} });
                    setSelectedCourse(null); setIsEditOpen(true);
                };
                const saveCourse = () => {
                    if (!newCourse.className) return addToast("è¯·å¡«å†™è¯¾ç¨‹åç§°", "error");
                    if (selectedCourse) {
                         setCourses(prev => prev.map(c => c.id === selectedCourse.id ? newCourse : c));
                    } else {
                         setCourses(prev => [...prev, { ...newCourse, id: generateId() }]);
                    }
                    setIsEditOpen(false);
                    addToast("æ’è¯¾æˆåŠŸ", "success");
                };
                const deleteCourse = () => { if(confirm("åˆ é™¤è¯¾ç¨‹?")) { setCourses(prev => prev.filter(c => c.id !== selectedCourse.id)); setIsEditOpen(false); addToast("è¯¾ç¨‹å·²åˆ é™¤", "info"); }};
                
                const toggleAtt = (sid, status) => {
                    setNewCourse(prev => {
                        const att = prev.attendance || {};
                        const cur = att[sid] || {};
                        return {...prev, attendance: {...att, [sid]: {...cur, studentId: sid, status, isMadeUp: false}}};
                    });
                };
                const toggleTask = (t) => {
                    setNewCourse(prev => {
                        const tasks = prev.tasks || {};
                        return {...prev, tasks: {...tasks, [t]: !tasks[t]}};
                    });
                };
                
                const handleStudentSelect = (e) => {
                    const sid = e.target.value;
                    if(sid && !newCourse.studentIds?.includes(sid)) {
                        setNewCourse(prev => ({...prev, studentIds: [...(prev.studentIds||[]), sid]}));
                    }
                    e.target.value = "";
                };

                const handleClassGroupSelect = (e) => {
                    const gid = e.target.value;
                    const g = classGroups.find(x => x.id === gid);
                    if(g) {
                        setNewCourse(prev => {
                            const currentIds = prev.studentIds || [];
                            const newIds = [...new Set([...currentIds, ...(g.studentIds||[])])];
                            return {...prev, studentIds: newIds};
                        });
                        addToast(`å·²å¯¼å…¥ ${g.name}`, "success");
                    }
                    e.target.value = "";
                };

                const weekCourses = courses.filter(c => c.dateStr >= formatDate(weekDays[0]) && c.dateStr <= formatDate(weekDays[6]));

                return (
                    <div className="flex flex-col h-full overflow-hidden">
                        <div className="flex justify-between items-center p-4 bg-white border-b shadow-sm z-10 pt-16 md:pt-4">
                            <h2 className="text-lg font-bold text-gray-800">è¯¾ç¨‹è¡¨</h2>
                            <div className="flex items-center gap-2 bg-gray-100 rounded-lg p-1 border border-gray-200">
                                <button onClick={()=>changeWeek(-1)} className="p-1 rounded hover:bg-white hover:shadow-sm transition-all"><LucideIcon name="ChevronLeft" size={20}/></button>
                                <span className="text-xs px-2 font-medium text-gray-600">{formatDate(weekDays[0]).slice(5)} - {formatDate(weekDays[6]).slice(5)}</span>
                                <button onClick={()=>changeWeek(1)} className="p-1 rounded hover:bg-white hover:shadow-sm transition-all"><LucideIcon name="ChevronRight" size={20}/></button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-auto bg-gray-50 p-2 pb-24 md:pb-4">
                            <div className="grid grid-cols-1 md:grid-cols-7 gap-3">
                                {weekDays.map((d, i) => {
                                    const dStr = formatDate(d);
                                    const dayCourses = weekCourses.filter(c => c.dateStr === dStr).sort((a,b)=>a.startTime.localeCompare(b.startTime));
                                    const isToday = dStr === formatDate(new Date());
                                    return (
                                        <div key={dStr} onClick={()=>handleCellClick(dStr, i)} className={`min-h-[120px] md:min-h-[400px] border rounded-xl p-2 transition-all cursor-pointer hover:border-${theme.primary}-300 ${isToday ? `bg-${theme.primary}-50 border-${theme.primary}-200 ring-1 ring-${theme.primary}-200` : 'bg-white border-gray-200 hover:shadow-sm'}`}>
                                            <div className={`text-center py-1 border-b mb-2 text-xs font-bold ${isToday ? `text-${theme.primary}-600` : 'text-gray-500'}`}>
                                                <div className="flex justify-between md:justify-center px-1">
                                                    <span>å‘¨{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]}</span>
                                                    <span className="opacity-75">{dStr.slice(5)}</span>
                                                </div>
                                            </div>
                                            <div className="space-y-2">
                                            {dayCourses.map(c => (
                                                <div key={c.id} onClick={(e)=>{e.stopPropagation(); setSelectedCourse(c); setNewCourse(c); setIsEditOpen(true);}} className={`bg-white border-l-4 border-${theme.primary}-500 shadow-sm p-2 rounded text-xs hover:shadow-md transition-shadow group`}>
                                                    <div className="font-bold truncate text-gray-800">{c.className}</div>
                                                    <div className="text-gray-500 mt-0.5 flex items-center gap-1"><LucideIcon name="Clock" size={10}/> {c.startTime}-{c.endTime}</div>
                                                    <div className="mt-1 pt-1 border-t border-gray-100 flex items-center gap-1 text-gray-400 group-hover:text-${theme.primary}-500"><LucideIcon name="Users" size={10}/> {c.studentIds?.length||0}äºº</div>
                                                </div>
                                            ))}
                                            </div>
                                            {dayCourses.length===0 && <div className="text-center text-gray-300 mt-8 opacity-50 hover:opacity-100 transition-opacity"><LucideIcon name="Plus" size={24} className="mx-auto"/></div>}
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                        <Modal isOpen={isEditOpen} onClose={()=>setIsEditOpen(false)} title={selectedCourse ? "è¯¾ç¨‹è¯¦æƒ…" : "æ–°è¯¾ç¨‹æ’è¯¾"}>
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="col-span-2 md:col-span-1">
                                        <label className="text-xs font-bold text-gray-500">è¯¾ç¨‹åç§°</label>
                                        <input className="w-full border p-2 rounded mt-1" value={newCourse.className||''} onChange={e=>setNewCourse({...newCourse, className:e.target.value})} />
                                    </div>
                                    <div className="col-span-2 md:col-span-1 flex flex-col">
                                         <div className="flex justify-between mb-1"><label className="text-xs font-bold text-gray-500">å†…å®¹</label></div>
                                        <input className="w-full border p-2 rounded flex-1" value={newCourse.content||''} onChange={e=>setNewCourse({...newCourse, content:e.target.value})} />
                                    </div>
                                    <div><label className="text-xs font-bold text-gray-500">å¼€å§‹</label><input type="time" className="w-full border p-2 rounded mt-1" value={newCourse.startTime||''} onChange={e=>setNewCourse({...newCourse, startTime:e.target.value})} /></div>
                                    <div><label className="text-xs font-bold text-gray-500">ç»“æŸ</label><input type="time" className="w-full border p-2 rounded mt-1" value={newCourse.endTime||''} onChange={e=>setNewCourse({...newCourse, endTime:e.target.value})} /></div>
                                </div>
                                <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                    <div className="flex gap-2 mb-3">
                                        <select className="border p-1.5 rounded text-xs flex-1 bg-white" onChange={handleClassGroupSelect}><option value="">+ å¯¼å…¥ç­çº§</option>{classGroups.map(g=><option key={g.id} value={g.id}>{g.name}</option>)}</select>
                                        <select className="border p-1.5 rounded text-xs flex-1 bg-white" onChange={handleStudentSelect}><option value="">+ æ·»åŠ å­¦å‘˜</option>{students.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}</select>
                                    </div>
                                    <div className="flex flex-wrap gap-2 min-h-[2rem]">{newCourse.studentIds?.map(sid => { const st = students.find(s=>s.id===sid); return st ? <span key={sid} className="bg-white border px-2 py-1 rounded text-xs flex items-center gap-1 shadow-sm">{st.name} <button onClick={()=>setNewCourse(prev=>({...prev, studentIds: prev.studentIds.filter(id=>id!==sid)}))} className="text-red-400 hover:text-red-600 font-bold">Ã—</button></span> : null; })}</div>
                                </div>
                                {selectedCourse && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
                                        <div className="border p-3 rounded-lg bg-orange-50 border-orange-100">
                                            <div className="font-bold mb-2 text-orange-800 flex items-center gap-1"><LucideIcon name="ClipboardList" size={14}/> æ•™å¸ˆä»»åŠ¡</div>
                                            <div className="space-y-2">
                                            {['teachingDone','interpretationSent','homeworkSent','reflectionDone'].map(k => (
                                                <label key={k} className="flex items-center gap-2 cursor-pointer hover:bg-orange-100/50 p-1 rounded"><input type="checkbox" className="rounded text-orange-500 focus:ring-orange-500" checked={newCourse.tasks?.[k]||false} onChange={()=>toggleTask(k)} /> {k==='teachingDone'?'æˆè¯¾å®Œæˆ':k==='interpretationSent'?'è§£è¯»å‘é€':k==='homeworkSent'?'ä½œä¸šå‘é€':'åæ€å®Œæˆ'}</label>
                                            ))}
                                            </div>
                                        </div>
                                        <div className="border p-3 rounded-lg bg-blue-50 border-blue-100">
                                            <div className="font-bold mb-2 text-blue-800 flex items-center gap-1"><LucideIcon name="UserCheck" size={14}/> è€ƒå‹¤æ‰“å¡</div>
                                            <div className="max-h-32 overflow-y-auto space-y-1 pr-1">
                                                {newCourse.studentIds?.map(sid => {
                                                    const st = students.find(s=>s.id===sid);
                                                    const status = newCourse.attendance?.[sid]?.status;
                                                    return st ? <div key={sid} className="flex justify-between items-center p-1 hover:bg-blue-100/50 rounded"><span>{st.name}</span> <div className="flex gap-1"><button onClick={()=>toggleAtt(sid,'present')} className={`px-2 py-0.5 rounded text-[10px] border transition-colors ${status==='present'?'bg-green-500 text-white border-green-600':'bg-white text-gray-500 hover:bg-gray-50'}`}>åˆ°</button><button onClick={()=>toggleAtt(sid,'absent')} className={`px-2 py-0.5 rounded text-[10px] border transition-colors ${status==='absent'?'bg-red-500 text-white border-red-600':'bg-white text-gray-500 hover:bg-gray-50'}`}>ç¼º</button></div></div> : null;
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <div className="flex gap-3 pt-2">
                                    {selectedCourse && <button onClick={deleteCourse} className="text-red-500 text-sm border border-red-200 px-4 rounded hover:bg-red-50">åˆ é™¤è¯¾ç¨‹</button>}
                                    <div className="flex-1"></div>
                                    <button onClick={() => setIsEditOpen(false)} className="text-gray-500 px-4 rounded">å–æ¶ˆ</button>
                                    <button onClick={saveCourse} className={`bg-${theme.primary}-600 text-white px-6 py-2 rounded-lg shadow hover:bg-${theme.primary}-700 transition-colors`}>ä¿å­˜</button>
                                </div>
                            </div>
                        </Modal>
                    </div>
                );
            };

            // --- æ¨¡å— 3: ç­çº§ç®¡ç† ---
            const ClassGroupManager = () => {
                const [isEdit, setIsEdit] = useState(false);
                const [group, setGroup] = useState({});
                const save = () => { 
                    if(group.name){ 
                        if(group.id) {
                            setClassGroups(prev => prev.map(g => g.id === group.id ? group : g));
                        } else {
                            setClassGroups(prev => [...prev, {...group, id: generateId()}]);
                        }
                        setIsEdit(false); setGroup({}); addToast("ä¿å­˜æˆåŠŸ", "success"); 
                    }
                };
                const deleteGroup = (id) => { if(confirm('åˆ é™¤?')) { setClassGroups(prev => prev.filter(g => g.id !== id)); } };

                return (
                    <div className="p-4 space-y-4 pb-24 md:pb-4 pt-16 md:pt-4">
                        <div className="flex justify-between items-center"><h2 className="text-xl font-bold text-gray-800">ç­çº§ç®¡ç†</h2><button onClick={()=>{setGroup({name:'', studentIds:[]}); setIsEdit(true)}} className={`bg-${theme.primary}-600 text-white px-3 py-2 rounded-lg flex items-center gap-2 text-sm shadow hover:bg-${theme.primary}-700`}><LucideIcon name="Plus" size={16}/> æ–°å»º</button></div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">{classGroups.map(g=><div key={g.id} className="bg-white p-4 rounded-lg shadow-sm border hover:shadow-md transition-shadow"><div className="font-bold flex justify-between text-gray-800 mb-2">{g.name} <div className="flex gap-2"><button onClick={()=>{setGroup(g); setIsEdit(true)}} className={`text-${theme.primary}-600 text-xs`}><LucideIcon name="Edit" size={14}/></button><button onClick={()=>{deleteGroup(g.id)}} className="text-red-500 text-xs"><LucideIcon name="Trash2" size={14}/></button></div></div><div className="text-xs text-gray-500 bg-gray-50 p-2 rounded">{g.studentIds?.length||0} äºº</div></div>)}</div>
                        <Modal isOpen={isEdit} onClose={()=>setIsEdit(false)} title="ç¼–è¾‘ç­çº§">
                            <div className="space-y-4">
                                <input className="border p-2 rounded w-full" placeholder="ç­çº§å" value={group.name||''} onChange={e=>setGroup({...group, name:e.target.value})} />
                                <div className="max-h-48 overflow-y-auto border p-2 rounded grid grid-cols-2 gap-2 bg-gray-50">
                                    {students.map(s=><label key={s.id} className="flex items-center gap-2 text-xs bg-white p-1 rounded border"><input type="checkbox" checked={group.studentIds?.includes(s.id)||false} onChange={()=>{
                                        const ids = group.studentIds||[];
                                        setGroup({...group, studentIds: ids.includes(s.id)?ids.filter(i=>i!==s.id):[...ids, s.id]});
                                    }}/>{s.name}</label>)}
                                </div>
                                <button onClick={save} className={`w-full bg-${theme.primary}-600 text-white py-2 rounded`}>ä¿å­˜</button>
                            </div>
                        </Modal>
                    </div>
                )
            }

            // --- æ¨¡å— 4: å›è®¿ç®¡ç† ---
            const FollowUpManager = () => {
                const currentMonth = formatDate(new Date()).slice(0,7);
                const total = students.length * 2;
                const done = followUps.filter(f => f.monthStr === currentMonth).reduce((s,r)=>s+r.count,0);
                
                const toggle = (sid, idx) => {
                    setFollowUps(prev => {
                        const ex = prev.find(f => f.studentId === sid && f.monthStr === currentMonth);
                        const count = ex ? ex.count : 0;
                        const newCount = (idx + 1 === count) ? idx : idx + 1;
                        const other = prev.filter(f => !(f.studentId === sid && f.monthStr === currentMonth));
                        return [...other, { id: ex?.id || generateId(), studentId: sid, monthStr: currentMonth, count: newCount }];
                    });
                };
                
                const exportCSV = () => {
                    const rows = students.map(s => {
                        const rec = followUps.find(f => f.studentId === s.id && f.monthStr === currentMonth);
                        return [s.name, currentMonth, rec?rec.count:0];
                    });
                    exportToCSV(`å›è®¿_${currentMonth}.csv`, [['å§“å','æœˆä»½','æ¬¡æ•°'], ...rows]);
                };

                return (
                    <div className="p-4 md:p-6 max-w-5xl mx-auto space-y-6 pb-24 md:pb-6 pt-16 md:pt-4">
                        <div className="flex justify-between items-center"><h2 className="text-xl font-bold text-gray-800">å›è®¿ç®¡ç† ({currentMonth})</h2><button onClick={exportCSV} className={`text-${theme.primary}-600 text-sm flex items-center gap-1 hover:bg-${theme.primary}-50 px-2 py-1 rounded transition-colors`}><LucideIcon name="Download" size={16}/> å¯¼å‡º</button></div>
                        <div className={`bg-gradient-to-r from-${theme.primary}-500 to-${theme.primary}-700 text-white p-5 rounded-xl shadow-lg flex justify-between text-center`}>
                            <div className="flex-1"><div className="text-xs opacity-75 mb-1">ç›®æ ‡</div><div className="text-3xl font-bold">{total}</div></div>
                            <div className="flex-1"><div className="text-xs opacity-75 mb-1">å®Œæˆ</div><div className="text-3xl font-bold">{done}</div></div>
                            <div className="flex-1"><div className="text-xs opacity-75 mb-1">è¿›åº¦</div><div className="text-3xl font-bold text-yellow-300">{total>0?Math.round(done/total*100):0}%</div></div>
                        </div>
                        <div className="bg-white rounded-lg shadow-sm overflow-x-auto border border-gray-200">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">å­¦å‘˜</th><th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">è®°å½• (2æ¬¡/äºº)</th></tr></thead>
                                <tbody className="divide-y divide-gray-100">
                                    {students.map(s => {
                                        const rec = followUps.find(f => f.studentId === s.id && f.monthStr === currentMonth);
                                        const c = rec?.count||0;
                                        return <tr key={s.id} className="hover:bg-gray-50"><td className="px-6 py-3 font-medium text-gray-700">{s.name}</td><td className="px-6 py-3 flex gap-3">{[0,1,2].map(i=><div key={i} onClick={()=>toggle(s.id, i)} className={`w-8 h-8 rounded-lg flex items-center justify-center cursor-pointer transition-all ${i<c?`bg-green-500 text-white shadow-md scale-105`:'bg-gray-100 text-gray-300 hover:bg-gray-200'}`}><LucideIcon name="CheckSquare" size={16}/></div>)}</td></tr>
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )
            }

            // --- æ¨¡å— 5: è€ƒå‹¤ç®¡ç† ---
            const AttendanceManager = () => {
                const currentMonth = formatDate(new Date()).slice(0,7);
                const week = Math.ceil(new Date().getDate()/7);
                
                let target = 0;
                if(attendanceMode === 'estimated') target = students.length * week;
                else courses.forEach(c => { if(c.dateStr.startsWith(currentMonth)) target += (c.studentIds?.length||0); });

                let actual = 0;
                const absents = [];
                courses.forEach(c => {
                    if(c.dateStr.startsWith(currentMonth)) {
                        Object.values(c.attendance||{}).forEach(a => {
                            if(a.status==='present' || (a.status==='absent' && a.isMadeUp)) actual++;
                            if(a.status==='absent' && !a.isMadeUp) absents.push({cname: c.className, date: c.dateStr, sid: a.studentId, cid: c.id});
                        });
                    }
                });
                const rate = target>0 ? (actual/target)*100 : 0;
                
                const makeup = (cid, sid) => {
                    if(confirm("ç¡®è®¤è¡¥è¯¾?")) {
                        setCourses(prev => prev.map(c => {
                            if (c.id === cid) {
                                const att = c.attendance[sid];
                                return {...c, attendance: {...c.attendance, [sid]: {...att, isMadeUp: true}}};
                            }
                            return c;
                        }));
                        addToast("è¡¥è¯¾å·²è®°å½•", "success");
                    }
                }

                const exportAtt = () => {
                    const rows = [];
                    courses.forEach(c=>{
                        if(c.dateStr.startsWith(currentMonth)) {
                            (c.studentIds||[]).forEach(sid=>{
                                const s = students.find(x=>x.id===sid);
                                const a = c.attendance?.[sid];
                                rows.push([c.dateStr, c.className, s?.name||'æœªçŸ¥', a?.status==='present'?'åˆ°':a?.status==='absent'?'ç¼º':'æœªè®°', a?.isMadeUp?'æ˜¯':'å¦']);
                            })
                        }
                    });
                    exportToCSV(`è€ƒå‹¤_${currentMonth}.csv`, [['æ—¥æœŸ','è¯¾ç¨‹','å§“å','çŠ¶æ€','å·²è¡¥è¯¾'],...rows]);
                };

                return (
                    <div className="p-4 md:p-6 max-w-4xl mx-auto space-y-6 md:space-y-8 pb-24 md:pb-6 pt-16 md:pt-4">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-3">
                            <h2 className="text-xl font-bold text-gray-800">è€ƒå‹¤çœ‹æ¿ ({currentMonth})</h2>
                            <div className="flex gap-2 bg-white p-1 rounded-lg shadow-sm border border-gray-200">
                                <button onClick={()=>{handleAttendanceModeChange('estimated'); addToast("å·²åˆ‡æ¢è‡³é¢„ä¼°æ¨¡å¼")}} className={`px-3 py-1.5 text-xs rounded-md transition-all ${attendanceMode==='estimated'?`bg-${theme.primary}-100 text-${theme.primary}-700 font-bold shadow-sm`:'text-gray-500 hover:bg-gray-50'}`}>é¢„ä¼°æ¨¡å¼</button>
                                <button onClick={()=>{handleAttendanceModeChange('scheduled'); addToast("å·²åˆ‡æ¢è‡³ç²¾å‡†æ¨¡å¼")}} className={`px-3 py-1.5 text-xs rounded-md transition-all ${attendanceMode==='scheduled'?`bg-${theme.primary}-100 text-${theme.primary}-700 font-bold shadow-sm`:'text-gray-500 hover:bg-gray-50'}`}>ç²¾å‡†æ¨¡å¼</button>
                                <div className="w-px bg-gray-200 mx-1"></div>
                                <button onClick={exportAtt} className="px-2 text-gray-500 hover:text-gray-700"><LucideIcon name="Download" size={16}/></button>
                            </div>
                        </div>
                        <div className={`p-6 rounded-xl shadow-lg text-white grid grid-cols-3 gap-4 text-center relative overflow-hidden ${rate>=94?'bg-gradient-to-br from-green-500 to-green-700':'bg-gradient-to-br from-red-500 to-red-700'}`}>
                            <div className="absolute right-0 top-0 p-4 opacity-10"><LucideIcon name={rate>=94?"TrendingUp":"AlertCircle"} size={100}/></div>
                            <div className="z-10"><div className="text-xs opacity-80 mb-1 uppercase tracking-wide">æœ¬æœˆç›®æ ‡</div><div className="text-3xl font-bold">{target}</div></div>
                            <div className="z-10"><div className="text-xs opacity-80 mb-1 uppercase tracking-wide">å®é™…å‡ºå‹¤</div><div className="text-3xl font-bold">{actual}</div></div>
                            <div className="z-10"><div className="text-xs opacity-80 mb-1 uppercase tracking-wide">è¾¾æ ‡ç‡ (94%)</div><div className="text-3xl font-bold flex items-center justify-center gap-1">{rate.toFixed(1)}%</div></div>
                        </div>
                        <div className="bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200">
                            <div className="p-3 font-bold text-gray-600 text-xs bg-gray-50 border-b border-gray-200 flex items-center gap-2"><LucideIcon name="AlertCircle" size={14} className="text-red-500"/> ç¼ºå‹¤å¾…è¡¥è¯¾åˆ—è¡¨</div>
                            <table className="min-w-full divide-y divide-gray-100">
                                <tbody className="text-sm">
                                    {absents.map((r,i) => {
                                        const s = students.find(x=>x.id===r.sid);
                                        return <tr key={i} className="hover:bg-gray-50 transition-colors"><td className="px-4 py-3 font-medium text-gray-800">{s?.name}</td><td className="px-4 py-3 text-gray-500">{r.cname}</td><td className="px-4 py-3 text-gray-400 text-xs">{r.date}</td><td className="px-4 py-3 text-right"><button onClick={()=>makeup(r.cid, r.sid)} className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-green-200 transition-colors shadow-sm border border-green-200">è¡¥è¯¾</button></td></tr>
                                    })}
                                    {absents.length===0 && <tr><td colSpan="4" className="p-8 text-center text-gray-400 italic">ğŸ‰ å¤ªæ£’äº†ï¼æœ¬æœˆæ‰€æœ‰ç¼ºå‹¤å·²å¤„ç†å®Œæ¯•ã€‚</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )
            }

            // --- Layout ---
            return (
                <div className="flex h-screen bg-gray-100 flex-col md:flex-row overflow-hidden font-sans">
                    <div className={`hidden md:flex w-64 bg-gradient-to-b from-${theme.sidebar}-800 to-${theme.sidebar}-950 text-white flex-col shadow-2xl flex-shrink-0 z-20`}>
                        <div className="p-6 text-2xl font-bold border-b border-white/10 flex items-center gap-3 tracking-tight"><div className={`w-8 h-8 rounded-lg bg-${theme.primary}-500 flex items-center justify-center shadow-lg text-white`}>L</div> äº‘ç«¯æ•™åŠ¡</div>
                        <nav className="flex-1 py-6 space-y-1 overflow-y-auto px-3">{['schedule','groups','students','followup','attendance'].map(k=><button key={k} onClick={()=>setActiveTab(k)} className={`w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition-all duration-200 ${activeTab===k?`bg-white/15 text-white shadow-lg backdrop-blur-sm font-medium`:'text-gray-400 hover:bg-white/5 hover:text-white'}`}><LucideIcon name={k==='schedule'?'Calendar':k==='groups'?'Layers':k==='students'?'Users':k==='followup'?'PhoneCall':'CheckSquare'} size={18} /> {k==='schedule'?'è¯¾ç¨‹ç®¡ç†':k==='groups'?'ç­çº§ç®¡ç†':k==='students'?'å­¦å‘˜ç®¡ç†':k==='followup'?'å›è®¿ç®¡ç†':'è€ƒå‹¤ç®¡ç†'}</button>)}</nav>
                        <div className="p-4 border-t border-white/10"><div className="mt-3 text-[10px] text-center text-gray-500 font-mono flex justify-center items-center gap-1.5"><span className={`w-2 h-2 rounded-full bg-green-500`}></span> æœ¬åœ°è¿è¡Œä¸­</div></div>
                    </div>
                    <div className="flex-1 flex flex-col overflow-hidden relative bg-gray-50/50">
                        <div className="absolute top-2 right-2 z-10 flex gap-2 md:hidden"><button onClick={()=>setIsThemeModalOpen(true)} className="bg-white p-2 rounded-full shadow-md border border-gray-100 text-gray-600"><LucideIcon name="Palette" size={18}/></button></div>
                        <div className="hidden md:block absolute bottom-8 right-8 z-50"><button onClick={()=>setIsThemeModalOpen(true)} className="bg-white p-3 rounded-full shadow-lg border text-gray-600 hover:scale-110 transition-transform flex items-center gap-2"><LucideIcon name="Palette" size={20}/><span className="font-medium text-sm">ä¸»é¢˜é£æ ¼</span></button></div>
                        <div className="flex-1 overflow-auto scroll-smooth"><div className="max-w-7xl mx-auto w-full h-full">{activeTab==='schedule' && <CourseSchedule />}{activeTab==='groups' && <ClassGroupManager />}{activeTab==='students' && <StudentManager />}{activeTab==='followup' && <FollowUpManager />}{activeTab==='attendance' && <AttendanceManager />}</div></div>
                    </div>
                    <div className={`md:hidden fixed bottom-0 w-full bg-gradient-to-r from-${theme.sidebar}-900 to-${theme.sidebar}-950 text-white flex justify-around p-2 pb-safe z-50 shadow-lg border-t border-white/5`}>{['schedule','groups','students','followup','attendance'].map(k=><button key={k} onClick={()=>setActiveTab(k)} className={`flex flex-col items-center p-2 rounded-xl transition-all duration-300 ${activeTab===k?`text-${theme.primary}-300 bg-white/10 scale-105`:'text-gray-500'}`}><LucideIcon name={k==='schedule'?'Calendar':k==='groups'?'Layers':k==='students'?'Users':k==='followup'?'PhoneCall':'CheckSquare'} size={20}/><span className="text-[10px] mt-1 font-medium">{k==='schedule'?'æ’è¯¾':k==='groups'?'ç­çº§':k==='students'?'å­¦å‘˜':k==='followup'?'å›è®¿':'è€ƒå‹¤'}</span></button>)}</div>
                    <Modal isOpen={isThemeModalOpen} onClose={()=>setIsThemeModalOpen(false)} title="ä¸»é¢˜"><div className="grid grid-cols-2 gap-3">{THEMES.map(t=><button key={t.id} onClick={()=>handleThemeChange(t)} className={`p-3 border rounded-xl flex gap-3 items-center ${theme.id===t.id?`bg-${t.primary}-50 border-${t.primary}-500 text-${t.primary}-700 ring-1 ring-${t.primary}-500 shadow-sm`:'hover:bg-gray-50 hover:border-gray-300'}`}><div className={`w-6 h-6 rounded-full bg-${t.primary}-500 shadow-sm ring-2 ring-white`}></div>{t.name}</button>)}</div></Modal>
                </div>
            );
        }

        const App = () => {
            return (
                <ToastProvider>
                    <SchoolSystem />
                </ToastProvider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>