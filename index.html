<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Veape Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            text: '#f8fafc',
                            muted: '#94a3b8'
                        }
                    }
                }
            }
        }
    </script>
    <!-- æ ¸å¿ƒåº“ï¼šä½¿ç”¨ Cloudflare CDN ç¡®ä¿ç¨³å®šæ€§ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin="anonymous"></script>
    
    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>

    <script>
        // --- [é…ç½®åŒºåŸŸ] ---
        const LC_CONFIG = {
            appId: "yiH4miM1mv1Wd3gR5qknSDLQ-gzGzoHsz",
            appKey: "S1hUg6WIYZqWNSf10el4ECzd",
            serverURL: "https://yih4mim1.lc-cn-n1-shared.com" 
        };
        
        // åˆå§‹åŒ– LeanCloud
        window.initLeanCloud = function() {
            if (typeof AV === 'undefined') return false;
            if (LC_CONFIG.appId === "è¯·æ›¿æ¢ä¸ºæ‚¨çš„AppID") return false;
            
            let safeURL = LC_CONFIG.serverURL.trim();
            safeURL = safeURL.replace(/https?:\/\//g, "").replace(/\/+$/, "");
            safeURL = "https://" + safeURL;

            try {
                AV.init({ appId: LC_CONFIG.appId, appKey: LC_CONFIG.appKey, serverURL: safeURL });
                console.log("LeanCloud initialized");
                return true;
            } catch (e) {
                console.error("LeanCloud init error:", e);
                return false;
            }
        };

        window.isLCReady = false;
        window.addEventListener('load', () => { window.isLCReady = window.initLeanCloud(); });
    </script>

    <style>
        body { 
            font-family: 'Nunito', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #334155;
            overflow: hidden;
        }
        
        html.dark body {
            background: linear-gradient(-45deg, #020617, #1e1b4b, #312e81, #0f172a);
            background-size: 400% 400%;
            color: #e2e8f0;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* åŠ¨æ€æµä½“èƒŒæ™¯ */
        .blob-cont {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none;
        }
        .blob {
            position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4;
            animation: floatBlob 20s infinite ease-in-out alternate;
        }
        html.dark .blob { opacity: 0.2; }
        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #bfdbfe; animation-delay: 0s; }
        .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #e9d5ff; animation-delay: -5s; }
        html.dark .blob-1 { background: #1e3a8a; }
        html.dark .blob-2 { background: #581c87; }
        html.dark .blob-3 { background: #7c2d12; }

        @keyframes floatBlob {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, 50px) scale(1.1); }
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }
        html.dark ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        html.dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); }
        
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        /* åŠ¨ç”» */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 70% { transform: scale(1.02); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        
        .animate-enter { animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .animate-pop { animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; opacity: 0; }
        
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 0.5rem;
        }
        html.dark .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
        }
        
        .hover-lift { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .hover-lift:hover { transform: translateY(-4px); }
        
        /* ç£¨ç ‚ç»ç’ƒ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
        }
        html.dark .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
        }
        
        .glass-sidebar {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.6);
        }
        html.dark .glass-sidebar {
            background: rgba(15, 23, 42, 0.8);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .tilt-card { transition: transform 0.1s ease-out; transform-style: preserve-3d; }
        .logo-glow { animation: breathe-glow 3s infinite ease-in-out; }
        @keyframes breathe-glow { 0%, 100% { box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); } 50% { box-shadow: 0 0 25px rgba(59, 130, 246, 0.8); } }

        .spinner { border: 3px solid rgba(59, 130, 246, 0.3); border-radius: 50%; border-top: 3px solid #3b82f6; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { animation: fadeInUp 0.2s ease-out forwards; backdrop-filter: blur(4px); background: rgba(0,0,0,0.2); }

        /* Custom Toggle Switch Style */
        .toggle-switch input[type="checkbox"] {
            display: none;
        }
        .toggle-switch label {
            display: block;
            width: 48px;
            height: 24px;
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 9999px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .toggle-switch label::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle-switch input[type="checkbox"]:checked + label {
            background-color: var(--primary-color, #3b82f6); /* blue-500 default */
        }
        .toggle-switch input[type="checkbox"]:checked + label::after {
            transform: translateX(24px);
        }
        /* Dark mode compatibility */
        html.dark .toggle-switch label {
            background-color: #475569; /* slate-600 */
        }

        /* --- ä¸»é¢˜æ‰©æ•£è¿‡æ¸¡æ ·å¼ (æ–°å¢) --- */
        .theme-transition-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000; /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ */
            pointer-events: none; /* é»˜è®¤ä¸å¯äº¤äº’ */
        }

        /* æ‰©æ•£æ•ˆæœçš„åœ†å½¢å…ƒç´  */
        .ripple-circle {
            position: absolute;
            width: 0px;
            height: 0px;
            border-radius: 50%;
            transform: translate(-50%, -50%); /* å±…ä¸­äºå®šä½ç‚¹ */
            pointer-events: all; /* åŠ¨ç”»æ—¶å¯äº¤äº’ï¼Œé˜²æ­¢ç”¨æˆ·å¿«é€Ÿé‡å¤ç‚¹å‡» */
            opacity: 0; /* é»˜è®¤éšè— */
        }

        /* æ‰©æ•£åŠ¨ç”» */
        @keyframes ripple-expand {
            0% {
                width: 0px;
                height: 0px;
                opacity: 1; /* åŠ¨ç”»å¼€å§‹æ—¶æ˜¾ç¤º */
            }
            100% {
                /* ç¡®ä¿åœ†å½¢è¶³å¤Ÿå¤§ä»¥è¦†ç›–ä»»ä½•å±å¹• (å¯¹è§’çº¿é•¿åº¦çš„ 2-3 å€) */
                width: 300vmax;
                height: 300vmax;
                opacity: 1;
            }
        }
        /* --- ä¸»é¢˜æ‰©æ•£è¿‡æ¸¡æ ·å¼ (ç»“æŸ) --- */
    </style>
</head>
<body class="h-screen overflow-hidden selection:bg-indigo-200 selection:text-indigo-900 dark:selection:bg-indigo-500 dark:selection:text-white">
    <div class="blob-cont"><div class="blob blob-1"></div><div class="blob blob-2"></div><div class="blob blob-3"></div></div>
    <div id="root" class="h-full relative z-10"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useContext, createContext, useCallback } = React;

        // --- å…¨å±€å˜é‡å®šä¹‰ (å¿…é¡»æ”¾åœ¨æœ€å‰) ---
        const THEMES = [
            { id: 'blue', name: 'æå…‰è“', primary: 'blue', accent: 'cyan' },
            { id: 'rose', name: 'æ¨±èŠ±ç²‰', primary: 'rose', accent: 'pink' },
            { id: 'violet', name: 'æ˜Ÿäº‘ç´«', primary: 'violet', accent: 'fuchsia' },
            { id: 'emerald', name: 'æ£®æ—ç»¿', primary: 'emerald', accent: 'lime' },
            // æ–°å¢æ¸å˜è‰²ä¸»é¢˜
            { id: 'orange', name: 'æ´»åŠ›æ©™', primary: 'orange', accent: 'amber' },
            { id: 'teal', name: 'æµ·æ´‹é’', primary: 'teal', accent: 'cyan' },
            { id: 'indigo', name: 'æ·±æµ·è“', primary: 'indigo', accent: 'violet' },
        ];
        // ç§»é™¤äº† AVATARS æ•°ç»„
        const DEFAULT_QUOTES = ["ä»Šå¤©ä¹Ÿæ˜¯å…ƒæ°”æ»¡æ»¡çš„ä¸€å¤©ï¼âœ¨", "æ•™è‚²çš„æœ¬è´¨æ˜¯å”¤é†’ã€‚ğŸŒ±", "ç§ä¸€æ£µæ ‘æœ€å¥½çš„æ—¶é—´æ˜¯åå¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨ã€‚ğŸŒ²", "æ˜Ÿå…‰ä¸é—®èµ¶è·¯äººã€‚â­"];

        // --- Context ---
        const AppDataContext = createContext(null);
        const ToastContext = createContext(null);

        // --- åŸºç¡€è®¾æ–½ç»„ä»¶ ---
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            // ä¿®æ”¹ï¼šå°†æé†’æ—¶é—´ä» 3000ms å»¶é•¿åˆ° 5000ms
            const TOAST_DURATION = 5000; 
            const addToast = useCallback((msg, type = 'info') => { const id = Date.now(); setToasts(p => [...p, { id, msg, type }]); setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), TOAST_DURATION); }, []);
            return (<ToastContext.Provider value={addToast}>{children}<div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col gap-2 w-auto min-w-[300px]">{toasts.map(t => (<div key={t.id} className={`animate-enter px-6 py-3 rounded-2xl shadow-2xl flex items-center justify-between backdrop-blur-xl border border-white/20 dark:border-white/10 text-sm font-bold ${t.type === 'error' ? 'bg-red-500/80 text-white' : t.type === 'success' ? 'bg-emerald-500/80 text-white' : 'bg-white/80 dark:bg-slate-800/90 text-slate-800 dark:text-slate-100'}`}><span>{t.type==='success'?'ğŸ‰ ':t.type==='error'?'âš ï¸ ':'ğŸ’¡ '} {t.msg}</span></div>))}</div></ToastContext.Provider>);
        };
        const useToast = () => useContext(ToastContext) || (() => {});
        const useAppData = () => useContext(AppDataContext);

        // Icons
        const Icon = ({ path, size = 20, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>);
        const icons = {
            Home: <><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>,
            Users: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
            Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
            PhoneCall: <><path d="M15.05 5A5 5 0 0 1 19 8.95M15.05 1A9 9 0 0 1 23 8.94m-1 7.98v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></>,
            CheckSquare: <><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>,
            ClipboardList: <><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></>,
            Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
            Trash2: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>,
            Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
            X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
            ChevronLeft: <><polyline points="15 18 9 12 15 6"/></>,
            ChevronRight: <><polyline points="9 18 15 12 9 6"/></>,
            Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
            UserCheck: <><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></>,
            AlertCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
            Layers: <><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>,
            Palette: <><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.01 17.461 2 12 2z"/></>,
            TrendingUp: <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>,
            Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>,
            Search: <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
            Cloud: <><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></>,
            RefreshCw: <><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"/><path d="M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></>,
            Database: <><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>,
            UploadCloud: <><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/><polyline points="16 16 12 12 8 16"/></>,
            UserX: <><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></>,
            PieChart: <><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></>,
            Activity: <><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></>,
            Award: <><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></>,
            Coins: <><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="M17 17v.01"/></>,
            Wallet: <><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"/><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"/></>,
            Settings: <><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>,
            Sparkles: <><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></>,
            Sun: <><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></>,
            Moon: <><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></>,
            CloudSun: <><path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M20 12h2"/><path d="m19.07 4.93-1.41 1.41"/><path d="M15.947 12.65a4 4 0 0 0-5.925-4.128"/><path d="M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z"/></>,
            Coffee: <><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></>,
            Quote: <><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/></>
        };
        const LucideIcon = ({ name, size = 20, className = "" }) => <Icon path={icons[name] || icons.Users} size={size} className={className} />;
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-[60] p-4 safe-area-pb modal-overlay" onClick={onClose}>
                    <div className="bg-white/90 dark:bg-slate-800/95 backdrop-blur-md rounded-3xl shadow-2xl w-full max-w-lg max-h-[85vh] overflow-y-auto modal-content flex flex-col transform transition-all border border-white/50 dark:border-white/10" onClick={(e) => e.stopPropagation()}>
                        <div className="flex justify-between items-center p-5 border-b border-gray-100/50 dark:border-slate-700 sticky top-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur z-10 shrink-0">
                            <h3 className="text-xl font-bold text-slate-800 dark:text-white truncate pr-4 tracking-tight flex items-center gap-2">
                                <span className="w-1 h-6 bg-blue-500 rounded-full"></span>{title}
                            </h3>
                            <button onClick={onClose} className="text-slate-400 dark:text-slate-500 hover:text-slate-700 dark:hover:text-white p-2 rounded-full hover:bg-white/50 dark:hover:bg-slate-700 transition-colors"><LucideIcon name="X" size={24} /></button>
                        </div>
                        <div className="p-6 dark:text-slate-200">{children}</div>
                    </div>
                </div>
            );
        };

        // 3D Tilt Card Component
        const TiltCard = ({ children, className = "" }) => {
            const ref = useRef(null);
            const [transform, setTransform] = useState("perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)");
            const handleMouseMove = (e) => {
                if (!ref.current) return;
                const { left, top, width, height } = ref.current.getBoundingClientRect();
                const x = (e.clientX - left) / width;
                const y = (e.clientY - top) / height;
                const tiltX = (0.5 - y) * 5; 
                const tiltY = (x - 0.5) * 5;
                setTransform(`perspective(1000px) rotateX(${tiltX}deg) rotateY(${tiltY}deg) scale(1.01)`);
            };
            const handleMouseLeave = () => setTransform("perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)");
            return <div ref={ref} className={`tilt-card ${className}`} style={{ transform }} onMouseMove={handleMouseMove} onMouseLeave={handleMouseLeave}>{children}</div>;
        };

        const Skeleton = ({ className }) => <div className={`skeleton ${className}`}></div>;

        // --- ä¸šåŠ¡ç»„ä»¶ ---
        
        const SettingsManager = () => {
            const { 
                teacherLevel, setTeacherLevel, classFeeBase, setClassFeeBase, theme, 
                students, courses, classGroups, followUps, formatDate, fetchAll,
                quotes, setQuotes, // è·å–è¯­å½•ç›¸å…³çŠ¶æ€
                showTodayIncome, setShowTodayIncome // æ–°å¢ï¼šä»Šæ—¥æ”¶å…¥å¼€å…³çŠ¶æ€
            } = useAppData();
            // FIX: ç¡®ä¿ addToast ä½¿ç”¨ useToast() è€Œä¸æ˜¯ä» useAppData è§£æ„
            const addToast = useToast(); 
            const [importing, setImporting] = useState(false);
            const [newQuote, setNewQuote] = useState(""); // æ–°è¯­å½•è¾“å…¥çŠ¶æ€

            // æ–°å¢: ç³»ç»Ÿæ›´æ–°æ—¥å¿—æ•°æ®
            const UPDATE_HISTORY = [
                { version: "V1.0.5", date: "2025-12-05", changes: ["æ–°å¢ï¼šä¸»é¢˜åˆ‡æ¢åŠ¨ç”»æ•ˆæœã€‚","ä¼˜åŒ–ï¼šè°ƒæ•´ä¸»é¢˜é¢œè‰²ï¼Œç§»é™¤é»‘è‰²ä¸»é¢˜ï¼Œæ–°å¢æ´»åŠ›æ©™ã€æµ·æ´‹é’å’Œæ·±æµ·è“ä¸»é¢˜ã€‚"] },
                { version: "V1.0.4", date: "2025-12-04", changes: ["æ–°å¢ï¼šæ’è¯¾åŠç­çº§ç®¡ç†ï¼Œæ·»åŠ å­¦ç”Ÿæœç´¢åŠŸèƒ½ã€‚", "ä¼˜åŒ–ï¼šè€ƒå‹¤ç›®æ ‡è®¡ç®—é€»è¾‘ï¼ˆé¢„ä¼°æ¨¡å¼æ”¹ä¸ºå­¦ç”Ÿé‡*4ï¼‰ã€‚", "ä¿®å¤ï¼šè€ƒå‹¤ç®¡ç†ä¸­è¡¥è¯¾åè¯¾æ—¶æ‰£é™¤é€»è¾‘ã€‚"] },
            	{ version: "V1.0.3", date: "2025-12-02", changes: ["æ–°å¢ï¼šç³»ç»Ÿä¸»é¢˜æ¢è‰²åŠŸèƒ½ï¼Œç³»ç»Ÿç‰ˆæœ¬æ›´æ–°è®°å½•å¡ç‰‡ ","ä¼˜åŒ–ï¼šç³»ç»Ÿæ•´ä½“ç•Œé¢è®¾è®¡ã€‚"] },
                { version: "V1.0.2", date: "2025-12-01", changes: ["æ–°å¢ï¼šæ¦‚è§ˆé¡µæ”¯æŒéšè—ä»Šæ—¥æ”¶å…¥ã€‚", "ä¼˜åŒ–ï¼šå­¦å‘˜ç®¡ç†åˆ—è¡¨æŒ‰å‰©ä½™è¯¾æ—¶å‡åºæ’åºã€‚"] },
                { version: "V1.0.1", date: "2025-11-29", changes: ["æ–°å¢ï¼šä¸ªæ€§åŒ–è¯­å½•ç®¡ç†åŠŸèƒ½ï¼Œæ”¶å…¥è®¡ç®—åŠŸèƒ½ã€‚", "ä¿®å¤ï¼šå‘¨å¯¼èˆªå™¨åœ¨æœˆè§†å›¾ä¸‹è·³è½¬é”™è¯¯ã€‚"] },
                { version: "V1.0.0", date: "2025-11-29", changes: ["ç³»ç»Ÿåˆå§‹åŒ–ï¼ŒåŒ…å«æ¦‚è§ˆã€è¯¾ç¨‹ã€å­¦å‘˜ã€ç­çº§ã€å›è®¿ã€è€ƒå‹¤ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚"] },
            ];
			

            // ç›‘å¬ä¸»é¢˜å˜åŒ–ä»¥æ›´æ–°CSSå˜é‡ï¼Œç¡®ä¿å¼€å…³é¢œè‰²æ­£ç¡®
            useEffect(() => {
                document.documentElement.style.setProperty('--primary-color', tailwind.config.theme.extend.colors[theme.primary]?.[600] || '#3b82f6');
            }, [theme]);

            const handleSave = () => {
                // ä¿å­˜è¯­å½•å’Œæ–°è®¾ç½®åˆ° localStorage 
                localStorage.setItem('lms_quotes', JSON.stringify(quotes));
                localStorage.setItem('lms_show_today_income', showTodayIncome);
                addToast("è®¾ç½®å·²ä¿å­˜", "success");
            }
            
            // æ·»åŠ æ–°è¯­å½•
            const handleAddQuote = () => {
                if (!newQuote.trim()) return addToast("å†…å®¹ä¸èƒ½ä¸ºç©º", "error");
                setQuotes([...quotes, newQuote.trim()]);
                setNewQuote("");
                addToast("è¯­å½•å·²æ·»åŠ ", "success");
            };

            // åˆ é™¤è¯­å½•
            const handleDeleteQuote = (index) => {
                // IMPORTANT: Use custom modal instead of confirm()
                if(window.confirm("ç¡®å®šåˆ é™¤è¿™æ¡è¯­å½•å—ï¼Ÿ")) {
                    const newQuotes = [...quotes];
                    newQuotes.splice(index, 1);
                    setQuotes(newQuotes);
                }
            };

            // å¤‡ä»½é€»è¾‘
            const handleExport = () => {
                const backupData = {
                    version: "1.0",
                    timestamp: new Date().toISOString(),
                    students, courses, classGroups, followUps, quotes // å¯¼å‡ºæ—¶åŒ…å«è¯­å½•
                };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `veape_backup_${formatDate(new Date())}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                addToast("å¤‡ä»½æ–‡ä»¶å·²ä¸‹è½½", "success");
            };

            const handleImport = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if(!data.students || !data.classGroups) throw new Error("æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶");
                        
                        addToast("å¼€å§‹æ¢å¤æ•°æ®...", "info");
                        
                        // è¾…åŠ©æ¢å¤å‡½æ•° (åŒä¹‹å‰)
                        const restoreItem = async (className, item) => {
                            const { id, createdAt, updatedAt, objectId, ...payload } = item;
                            try {
                                const obj = AV.Object.createWithoutData(className, id);
                                Object.keys(payload).forEach(k => { if (['id', 'objectId', 'createdAt', 'updatedAt'].includes(k)) return; obj.set(k, payload[k]); });
                                await obj.save();
                            } catch (err) {
                                const NewObj = AV.Object.extend(className);
                                const newObj = new NewObj();
                                Object.keys(payload).forEach(k => { if (['id', 'objectId', 'createdAt', 'updatedAt'].includes(k)) return; newObj.set(k, payload[k]); });
                                await newObj.save();
                            }
                        };

                        // ä¸²è¡Œæ¢å¤é˜²æ­¢å¹¶å‘è¿‡é«˜
                        for (const s of data.students) await restoreItem('Student', s);
                        for (const g of data.classGroups) await restoreItem('ClassGroup', g);
                        for (const c of data.courses) await restoreItem('Course', c);
                        for (const f of data.followUps) await restoreItem('FollowUp', f);
                        
                        // æ¢å¤è¯­å½•
                        if (data.quotes && Array.isArray(data.quotes)) {
                            setQuotes(data.quotes);
                        }

                        await fetchAll();
                        addToast("æ•°æ®æ¢å¤å®Œæˆï¼", "success");
                    } catch (err) {
                        console.error(err);
                        addToast("æ¢å¤å¤±è´¥: " + err.message, "error");
                    } finally {
                        e.target.value = ''; 
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="p-6 md:p-10 space-y-8 pb-24 md:pb-10 pt-20 md:pt-10 animate-enter max-w-6xl mx-auto">
                    <div className="flex justify-between items-end mb-2">
                        <div>
                            <h2 className="text-3xl font-bold text-slate-800 dark:text-white tracking-tight flex items-center gap-3">
                                <LucideIcon name="Settings" size={32} className={`text-${theme.primary}-500 animate-spin-slow`}/> 
                                ç³»ç»Ÿè®¾ç½®
                            </h2>
                            <p className="text-slate-500 dark:text-slate-400 mt-2 font-medium">ä¸ªæ€§åŒ–é…ç½®æ‚¨çš„å·¥ä½œå°</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8">
                        {/* å¡ç‰‡ 1: åŸºç¡€è®¾ç½® */}
                        <TiltCard className="glass-panel p-8 rounded-3xl h-full flex flex-col hover-lift">
                            <h3 className="font-bold text-xl text-slate-800 dark:text-white mb-8 flex items-center gap-3">
                                <div className={`w-10 h-10 rounded-2xl bg-${theme.primary}-100 text-${theme.primary}-600 dark:bg-slate-700 dark:text-white flex items-center justify-center shadow-inner`}><LucideIcon name="Settings" size={22}/></div>
                                å¸¸è§„é€‰é¡¹
                            </h3>
                            <div className="space-y-8 flex-1">
                                
                                {/* ç§»é™¤äº†é€‰æ‹©å¤´åƒåŠŸèƒ½ */}
                                
                                {/* æ–°å¢ï¼šæ¦‚è§ˆé¡µé¢æ”¶å…¥å¼€å…³ */}
                                <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-2xl bg-white/50 dark:bg-slate-800/50 flex justify-between items-center shadow-sm">
                                    <div>
                                        <label className="block text-sm font-bold text-slate-600 dark:text-slate-300 mb-1">
                                            æ˜¾ç¤ºä»Šæ—¥æ”¶å…¥
                                        </label>
                                        <p className="text-xs text-slate-400">åœ¨æ¦‚è§ˆé¡µå¡ç‰‡ä¸­æ˜¾ç¤ºæ•æ„Ÿçš„è–ªèµ„æ•°æ®</p>
                                    </div>
                                    <div className="toggle-switch">
                                        <input 
                                            type="checkbox" 
                                            id="showIncomeToggle" 
                                            checked={showTodayIncome} 
                                            onChange={() => setShowTodayIncome(!showTodayIncome)} 
                                        />
                                        <label htmlFor="showIncomeToggle"></label>
                                    </div>
                                </div>


                                <div>
                                    <label className="block text-sm font-bold text-slate-600 dark:text-slate-300 mb-2 uppercase tracking-wider">æ•™å¸ˆè¯„çº§</label>
                                    <input className="w-full border border-slate-200 dark:border-slate-600 p-4 rounded-2xl focus:ring-4 focus:ring-blue-100 dark:focus:ring-slate-700 focus:border-blue-400 dark:focus:border-slate-500 outline-none transition-all text-slate-700 dark:text-white bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm" value={teacherLevel} onChange={e=>setTeacherLevel(e.target.value)} placeholder="ä¾‹å¦‚ï¼šåˆçº§ 2 çº§" />
                                    <p className="text-xs text-slate-400 mt-2 flex items-center gap-1"><LucideIcon name="Award" size={12}/> æ˜¾ç¤ºåœ¨ä»ªè¡¨ç›˜ä¸Šçš„èŒçº§ä¿¡æ¯</p>
                                </div>
                                <div className="pt-6 border-t border-slate-100 dark:border-slate-700">
                                    <label className="block text-sm font-bold text-slate-600 dark:text-slate-300 mb-3 uppercase tracking-wider">è¯¾æ—¶è´¹åŸºæ•° (å…ƒ/è¯¾æ—¶)</label>
                                    <div className="flex items-center gap-4">
                                        <div className="w-14 h-14 bg-white dark:bg-slate-700 rounded-2xl flex items-center justify-center text-slate-400 dark:text-slate-200 font-bold text-2xl shadow-sm border border-slate-100 dark:border-slate-600">Â¥</div>
                                        <input type="number" className="flex-1 border border-slate-200 dark:border-slate-600 p-4 rounded-2xl focus:ring-4 focus:ring-blue-100 dark:focus:ring-slate-700 focus:border-blue-400 dark:focus:border-slate-500 outline-none transition-all font-mono font-bold text-2xl text-slate-800 dark:text-white bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm" value={classFeeBase} onChange={e=>setClassFeeBase(Number(e.target.value))} />
                                    </div>
                                    <div className="bg-orange-50/80 dark:bg-orange-900/20 p-4 rounded-2xl mt-4 text-xs text-orange-700/90 dark:text-orange-300 leading-relaxed border border-orange-100/50 dark:border-orange-800/30 flex gap-3">
                                        <LucideIcon name="Activity" size={16} className="shrink-0 mt-0.5"/>
                                        <div>
                                            <span className="font-bold block mb-1">å½“å‰è®¡ç®—å…¬å¼:</span>
                                            (ç´¯è®¡è¯¾æ—¶ Ã· 2) Ã— 1.5 Ã— <span className="font-bold text-orange-600 dark:text-orange-400 bg-white dark:bg-slate-800 px-1.5 py-0.5 rounded border border-orange-200 dark:border-orange-800 mx-1 shadow-sm">{classFeeBase}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="pt-8 mt-auto">
                                <button onClick={handleSave} className={`w-full bg-${theme.primary}-500 text-white py-4 rounded-2xl font-bold text-lg shadow-xl shadow-${theme.primary}-500/30 hover:bg-${theme.primary}-600 hover:scale-[1.02] active:scale-95 transition-all hover-jelly`}>ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
                            </div>
                        </TiltCard>

                        {/* å¡ç‰‡ 2: ä¸ªæ€§åŒ–è¯­å½•ç®¡ç† */}
                        <TiltCard className="glass-panel p-8 rounded-3xl h-full flex flex-col hover-lift">
                            <h3 className="font-bold text-xl text-slate-800 dark:text-white mb-8 flex items-center gap-3">
                                <div className="w-10 h-10 rounded-2xl bg-pink-100 text-pink-600 flex items-center justify-center shadow-inner"><LucideIcon name="Quote" size={22}/></div>
                                ä¸ªæ€§åŒ–è¯­å½•
                            </h3>
                            <div className="space-y-4 flex-1 overflow-y-auto max-h-[400px] custom-scrollbar pr-2">
                                {quotes.map((q, idx) => (
                                    <div key={idx} className="flex items-center gap-2 group">
                                        <div className="flex-1 bg-white/50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700 text-sm text-slate-700 dark:text-slate-200 shadow-sm">
                                            {q}
                                        </div>
                                        <button onClick={() => handleDeleteQuote(idx)} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all opacity-0 group-hover:opacity-100">
                                            <LucideIcon name="Trash2" size={16}/>
                                        </button>
                                    </div>
                                ))}
                                {quotes.length === 0 && <div className="text-center text-slate-400 text-sm py-4">æš‚æ— è¯­å½•ï¼Œè¯·æ·»åŠ ä¸€æ¡å§~</div>}
                            </div>
                            <div className="pt-6 mt-auto border-t border-slate-100 dark:border-slate-700">
                                <div className="flex gap-2">
                                    <input 
                                        className="flex-1 border border-slate-200 dark:border-slate-600 p-3 rounded-xl focus:ring-2 focus:ring-pink-200 outline-none transition-all text-sm dark:bg-slate-800 dark:text-white" 
                                        placeholder="è¾“å…¥ä¸€å¥æ¿€åŠ±è‡ªå·±çš„è¯..." 
                                        value={newQuote}
                                        onChange={e => setNewQuote(e.target.value)}
                                        onKeyPress={e => e.key === 'Enter' && handleAddQuote()}
                                    />
                                    <button onClick={handleAddQuote} className="bg-pink-500 text-white p-3 rounded-xl hover:bg-pink-600 active:scale-95 transition-all shadow-lg shadow-pink-200 dark:shadow-none">
                                        <LucideIcon name="Plus" size={20}/>
                                    </button>
                                </div>
                            </div>
                        </TiltCard>
                        
                        {/* æ–°å¢å¡ç‰‡ 3: ç‰ˆæœ¬æ›´æ–°è®°å½• */}
                        <TiltCard className="glass-panel p-8 rounded-3xl h-full flex flex-col hover-lift lg:col-span-1">
                            <h3 className="font-bold text-xl text-slate-800 dark:text-white mb-8 flex items-center gap-3">
                                <div className="w-10 h-10 rounded-2xl bg-indigo-100 text-indigo-600 flex items-center justify-center shadow-inner"><LucideIcon name="Cloud" size={22}/></div>
                                ç³»ç»Ÿæ›´æ–°æ—¥å¿—
                            </h3>
                            <div className="space-y-6 flex-1 overflow-y-auto max-h-[400px] custom-scrollbar pr-2">
                                {UPDATE_HISTORY.map((item, index) => (
                                    <div key={item.version} className={`pb-4 ${index < UPDATE_HISTORY.length - 1 ? 'border-b border-slate-100 dark:border-slate-700' : ''}`}>
                                        <div className="flex items-center justify-between text-sm font-bold mb-1">
                                            <span className={`text-slate-800 dark:text-white flex items-center gap-2 ${index === 0 ? 'text-lg text-emerald-600 dark:text-emerald-400' : ''}`}>{item.version}</span>
                                            <span className="text-xs text-slate-400">{item.date}</span>
                                        </div>
                                        <ul className="text-xs text-slate-600 dark:text-slate-300 space-y-1 list-disc list-inside ml-2">
                                            {item.changes.map((change, i) => (
                                                <li key={i}>{change}</li>
                                            ))}
                                        </ul>
                                    </div>
                                ))}
                            </div>
                        </TiltCard>

                        {/* å¡ç‰‡ 4: æ•°æ®å¤‡ä»½ (ä¿æŒè·¨ 2 åˆ—) */}
                        <TiltCard className="glass-panel p-8 rounded-3xl h-full flex flex-col hover-lift lg:col-span-2 xl:col-span-3">
                            <h3 className="font-bold text-xl text-slate-800 dark:text-white mb-8 flex items-center gap-3">
                                <div className="w-10 h-10 rounded-2xl bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300 flex items-center justify-center shadow-inner"><LucideIcon name="Database" size={22}/></div>
                                æ•°æ®å®‰å…¨ä¸­å¿ƒ
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-white/60 dark:bg-slate-800/60 rounded-2xl p-6 border border-slate-100 dark:border-slate-700 hover:border-blue-300 dark:hover:border-blue-500 transition-all group cursor-pointer shadow-sm hover:shadow-md" onClick={handleExport}>
                                    <div className="flex items-center gap-5 mb-4">
                                        <div className="w-12 h-12 bg-blue-500 text-white rounded-full shadow-lg shadow-blue-500/30 flex items-center justify-center group-hover:scale-110 transition-transform"><LucideIcon name="Download" size={24}/></div>
                                        <div>
                                            <div className="font-bold text-slate-800 dark:text-white text-lg">å¯¼å‡ºå…¨ç«™å¤‡ä»½</div>
                                            <div className="text-xs text-slate-500 dark:text-slate-400 mt-1">ç”ŸæˆåŒ…å«æ‰€æœ‰å­¦å‘˜ã€è¯¾ç¨‹è®°å½•çš„ JSON æ–‡ä»¶</div>
                                        </div>
                                    </div>
                                    <div className="flex justify-end">
                                        <span className="text-xs font-bold text-blue-500 bg-blue-50 dark:bg-blue-900 dark:text-blue-300 px-3 py-1.5 rounded-full group-hover:bg-blue-100 dark:group-hover:bg-blue-800 transition-colors">ç«‹å³ä¸‹è½½</span>
                                    </div>
                                </div>

                                <div className="bg-white/60 dark:bg-slate-800/60 rounded-2xl p-6 border border-slate-100 dark:border-slate-700 hover:border-green-300 dark:hover:border-green-500 transition-all group relative shadow-sm hover:shadow-md">
                                    <div className="flex items-center gap-5 mb-4">
                                        <div className="w-12 h-12 bg-green-500 text-white rounded-full shadow-lg shadow-green-500/30 flex items-center justify-center group-hover:scale-110 transition-transform"><LucideIcon name="UploadCloud" size={24}/></div>
                                        <div>
                                            <div className="font-bold text-slate-800 dark:text-white text-lg">æ¢å¤å†å²æ•°æ®</div>
                                            <div className="text-xs text-slate-500 dark:text-slate-400 mt-1">ä¸Šä¼ å¤‡ä»½æ–‡ä»¶è¦†ç›–å½“å‰ç³»ç»Ÿæ•°æ®</div>
                                        </div>
                                    </div>
                                    <div className="relative">
                                        <input type="file" accept=".json" onChange={handleImport} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" disabled={importing} />
                                        <div className="flex justify-end">
                                            <span className="text-xs font-bold text-green-500 bg-green-50 dark:bg-green-900 dark:text-green-300 px-3 py-1.5 rounded-full group-hover:bg-green-100 dark:group-hover:bg-green-800 transition-colors flex items-center gap-2">
                                                {importing ? <><div className="spinner w-3 h-3 border-current"></div> æ¢å¤ä¸­...</> : 'ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="mt-8 text-xs text-amber-700/80 dark:text-amber-300 bg-amber-50/80 dark:bg-amber-900/20 p-4 rounded-2xl border border-amber-100/50 dark:border-amber-800/30 flex gap-3 items-start">
                                <LucideIcon name="AlertCircle" size={18} className="shrink-0 mt-0.5"/>
                                <span className="leading-relaxed">å®‰å…¨æç¤ºï¼šæ¢å¤æ“ä½œå°†æ™ºèƒ½åˆå¹¶æ•°æ®ã€‚å»ºè®®åœ¨æ‰§è¡Œæ¢å¤å‰ï¼Œå…ˆæ‰‹åŠ¨ç‚¹å‡»â€œå¯¼å‡ºå¤‡ä»½â€ä»¥é˜²ä¸‡ä¸€ã€‚</span>
                            </div>
                        </TiltCard>
                    </div>
                </div>
            )
        }

        // 0. ä»ªè¡¨ç›˜ (Dashboard)
        const Dashboard = () => {
            const { students, courses, classGroups, followUps, theme, formatDate, teacherLevel, classFeeBase, loading, quotes, showTodayIncome } = useAppData();
            const [greeting, setGreeting] = useState({ text: "æ—©å®‰", icon: "Sun" });
            const [quote, setQuote] = useState("");

            useEffect(() => {
                const h = new Date().getHours();
                if (h < 5) setGreeting({ text: "æ·±å¤œå¥½", icon: "Moon" }); else if (h < 11) setGreeting({ text: "æ—©ä¸Šå¥½", icon: "Sun" }); else if (h < 14) setGreeting({ text: "ä¸­åˆå¥½", icon: "Sun" }); else if (h < 19) setGreeting({ text: "ä¸‹åˆå¥½", icon: "Coffee" }); else setGreeting({ text: "æ™šä¸Šå¥½", icon: "Moon" });
                
                // ä»è‡ªå®šä¹‰è¯­å½•ä¸­éšæœºé€‰æ‹©
                const currentQuotes = (quotes && quotes.length > 0) ? quotes : DEFAULT_QUOTES;
                setQuote(currentQuotes[Math.floor(Math.random() * currentQuotes.length)]);
            }, [quotes]);
            
            // --- è–ªèµ„ç®—æ³•é…ç½® ---
            const SALARY = {
                base: 2000, attendance: 100, transport: 100, phone: 50, housing: 280, performance: 500, lunchPerDay: 20, lunchMax: 440,
                demoFee: 40 // Demoè¯¾å•ä»·
            };
            const FIXED_TOTAL = SALARY.base + SALARY.attendance + SALARY.transport + SALARY.phone + SALARY.housing + SALARY.performance;

            const isWorkingDay = (d) => { const day = d.getDay(); return day === 0 || (day >= 3 && day <= 6); };
            const now = new Date();
            const currentMonthStr = formatDate(now).slice(0, 7);
            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthStr = formatDate(lastMonthDate).slice(0, 7);

            // è®¡ç®—æœ¬æœˆå·¥ä½œæ—¥
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            let workingDaysCount = 0;
            for (let i = 1; i <= daysInMonth; i++) if (isWorkingDay(new Date(now.getFullYear(), now.getMonth(), i))) workingDaysCount++;
            const fixedPerDay = workingDaysCount > 0 ? FIXED_TOTAL / workingDaysCount : 0;

            // 1. ä»Šæ—¥æ”¶å…¥
            const todayStr = formatDate(now);
            const todayCourses = courses.filter(c => c.dateStr === todayStr).sort((a,b)=>a.startTime.localeCompare(b.startTime));
            
            const classFeeRate = 1.5 * classFeeBase; // åŠ¨æ€è®¡ç®—å•ä»·

            // ä»Šæ—¥è¯¾æ—¶è´¹è®¡ç®— (æ··åˆæ¨¡å¼)
            const todayRegularIncome = todayCourses
                .filter(c => c.type !== 'demo')
                .reduce((acc, c) => acc + (c.studentIds?.length || 0) * classFeeRate, 0);
            const todayDemoIncome = todayCourses
                .filter(c => c.type === 'demo') // æ’é™¤å¸¸è§„è¯¾ï¼Œåªè®¡ç®— Demo
                .reduce((acc, c) => acc + SALARY.demoFee, 0);
            const todayTotalClassFee = todayRegularIncome + todayDemoIncome;

            const isTodayWorking = isWorkingDay(now);
            const todayLunch = isTodayWorking ? SALARY.lunchPerDay : 0;
            const todayBase = isTodayWorking ? fixedPerDay : 0;
            const todayTotalIncome = todayTotalClassFee + todayLunch + todayBase;

            // 2. æœ¬æœˆè–ªèµ„é¢„ä¼°
            const monthCourses = courses.filter(c => c.dateStr.startsWith(currentMonthStr));
            const monthRegularIncome = monthCourses
                .filter(c => c.type !== 'demo')
                .reduce((acc, c) => acc + (c.studentIds?.length || 0) * classFeeRate, 0);
            const monthDemoIncome = monthCourses
                .filter(c => c.type === 'demo')
                .reduce((acc, c) => acc + SALARY.demoFee, 0);
                
            const monthClassFee = monthRegularIncome + monthDemoIncome;
            const rawMonthLunch = workingDaysCount * SALARY.lunchPerDay; 
            const monthLunch = Math.min(rawMonthLunch, SALARY.lunchMax); // é¤è¡¥ä¸Šé™å¤„ç†
            const monthTotalEstimated = FIXED_TOTAL + monthLunch + monthClassFee;
            
            // 3. æœ¬æœˆç´¯è®¡è¯¾æ—¶ (åªç»Ÿè®¡å¸¸è§„è¯¾çš„å­¦ç”Ÿäººæ¬¡ * 2ï¼ŒDemoè¯¾ä¸è®¡å…¥å¸¸è§„è¯¾æ—¶ç»Ÿè®¡ï¼Œæˆ–è€…å•åˆ—)
            const monthRegularHours = monthCourses
                .filter(c => c.type !== 'demo')
                .reduce((acc, c) => acc + ((c.studentIds?.length || 0) * 2), 0);

            // 4. è¿è¥æŒ‡æ ‡
            const getStats = (dateObj) => {
                const mStr = formatDate(dateObj).slice(0, 7);
                const followUpTarget = students.length * 2;
                const followUpDone = followUps.filter(f => f.monthStr === mStr).reduce((acc, f) => acc + (f.count || 0), 0);
                const followUpRate = followUpTarget > 0 ? (followUpDone / followUpTarget) * 100 : 0;
                
                const mCourses = courses.filter(c => c.dateStr.startsWith(mStr) && c.type !== 'demo'); // åªç»Ÿè®¡å¸¸è§„è¯¾å‡ºå‹¤
                let expectedAtt = 0, actualAtt = 0;
                mCourses.forEach(c => {
                    expectedAtt += (c.studentIds?.length || 0);
                    if (c.attendance) Object.values(c.attendance).forEach(v => { if (v.status === 'present' || v.isMadeUp) actualAtt++; });
                });
                const attendanceRate = expectedAtt > 0 ? (actualAtt / expectedAtt) * 100 : 0;
                return { followUpRate, attendanceRate };
            };
            const thisMonthStats = getStats(now);
            const lastMonthStats = getStats(lastMonthDate);

            // å­¦å‘˜å¢é•¿
            const getStudentGrowth = () => {
                const startOfThisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const currentTotal = students.length;
                const newStudentsThisMonth = students.filter(s => s.createdAt && new Date(s.createdAt) >= startOfThisMonth).length;
                return { current: currentTotal, prev: currentTotal - newStudentsThisMonth };
            };
            const studentStats = getStudentGrowth();

            // æ¶¨è·Œå¹…ç»„ä»¶
            const Trend = ({ curr, prev, isPercent }) => {
                const diff = curr - prev;
                const isUp = diff >= 0;
                let valStr = isPercent ? `${Math.abs(diff).toFixed(1)}%` : `${Math.abs(prev === 0 ? (curr > 0 ? 100 : 0) : ((diff / prev) * 100)).toFixed(1)}%`;
                const color = isUp ? "text-emerald-600 bg-emerald-100 dark:bg-emerald-900/30 dark:text-emerald-400" : "text-rose-500 bg-rose-100 dark:bg-rose-900/30 dark:text-rose-400";
                const arrow = isUp ? "â†‘" : "â†“";
                return <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ml-2 inline-flex items-center gap-0.5 ${color}`}>{arrow} {valStr}</span>;
            };

            const HiddenIncomeCard = () => (
                <TiltCard className="glass-panel p-6 rounded-3xl flex flex-col justify-center items-center h-full hover-lift group">
                    <LucideIcon name="Wallet" size={32} className={`text-${theme.primary}-500 mb-2 opacity-50`}/>
                    <div className="text-xl font-bold text-slate-800 dark:text-white">ä»Šæ—¥æ”¶å…¥å·²éšè—</div>
                    <div className="text-xs text-slate-400 mt-1">è¯·åœ¨â€œç³»ç»Ÿè®¾ç½®â€ä¸­å¼€å¯æ˜¾ç¤º</div>
                </TiltCard>
            )

            // è¿˜åŸåçš„ Income Card
            const IncomeCard = () => (
                <TiltCard className={`col-span-1 md:col-span-2 bg-gradient-to-br from-${theme.primary}-500 to-${theme.primary}-700 rounded-3xl p-6 text-white shadow-xl shadow-${theme.primary}-500/30 relative overflow-hidden group`}>
                    <div className="relative z-10 flex flex-col h-full justify-between">
                        <div className="flex justify-between items-start">
                            <div>
                                <div className="flex items-center gap-2 opacity-90 text-xs font-bold mb-1 uppercase tracking-wider">
                                    <LucideIcon name="Wallet" size={14}/> ä»Šæ—¥æ€»æ”¶å…¥
                                </div>
                                <div className="text-4xl font-extrabold tracking-tight">
                                    Â¥{todayTotalIncome.toFixed(2)}
                                </div>
                            </div>
                            <div className="text-right opacity-80">
                                <div className="text-xs font-bold">{todayStr}</div>
                                <div className="text-[10px] mt-0.5">{isTodayWorking ? 'å·¥ä½œæ—¥' : 'ä¼‘æ¯æ—¥'}</div>
                            </div>
                        </div>
                        
                        <div className="mt-8 grid grid-cols-3 gap-2 text-center border-t border-white/20 pt-4">
                            <div>
                                <div className="text-xs opacity-70 uppercase tracking-wider mb-1">è¯¾æ—¶è´¹</div>
                                <div className="text-xl font-bold">Â¥{todayTotalClassFee.toFixed(0)}</div>
                            </div>
                            <div>
                                <div className="text-xs opacity-70 uppercase tracking-wider mb-1">åº•è–ªæ‘Š</div>
                                <div className="text-xl font-bold">Â¥{todayBase.toFixed(0)}</div>
                            </div>
                            <div>
                                <div className="text-xs opacity-70 uppercase tracking-wider mb-1">é¤è¡¥</div>
                                <div className="text-xl font-bold">Â¥{todayLunch}</div>
                            </div>
                        </div>
                    </div>
                    {/* Decorative background icon */}
                    <div className="absolute -right-6 -bottom-6 opacity-10 transform group-hover:scale-110 transition-transform duration-700 rotate-12"><LucideIcon name="Coins" size={160}/></div>
                </TiltCard>
            )
            
            // è¿˜åŸ æ•™å­¦è´¨é‡ Card (ç¬¬ä¸‰æ ¼)
            const QualityCard = () => (
                 <TiltCard className="glass-panel p-6 rounded-3xl flex flex-col justify-between relative overflow-hidden hover-lift group">
                    <div className="flex justify-between items-center mb-4 border-b border-gray-100 dark:border-slate-700 pb-2">
                        <div className="flex items-center gap-2 text-sm font-bold text-slate-700 dark:text-slate-200"><LucideIcon name="Activity" size={16} className="text-indigo-500"/> æ•™å­¦è´¨é‡</div>
                    </div>
                    
                    <div className="space-y-4">
                        {/* å›è®¿ç‡ */}
                        <div>
                            <div className="flex justify-between items-center mb-1">
                                <span className="text-xs text-slate-500 dark:text-slate-400">å›è®¿ç‡</span>
                                <Trend curr={thisMonthStats.followUpRate} prev={lastMonthStats.followUpRate} isPercent={true} />
                            </div>
                            <div className="flex items-end gap-2">
                                <span className="text-lg font-bold text-slate-800 dark:text-white">{thisMonthStats.followUpRate.toFixed(0)}%</span>
                                <div className="flex-1 h-1.5 bg-gray-100 dark:bg-slate-700 rounded-full mb-1.5 overflow-hidden">
                                    <div className="h-full bg-emerald-500 rounded-full" style={{width: `${thisMonthStats.followUpRate}%`}}></div>
                                </div>
                            </div>
                        </div>

                        {/* å‡ºå‹¤ç‡ */}
                        <div>
                            <div className="flex justify-between items-center mb-1">
                                <span className="text-xs text-slate-500 dark:text-slate-400">å‡ºå‹¤ç‡</span>
                                <Trend curr={thisMonthStats.attendanceRate} prev={lastMonthStats.attendanceRate} isPercent={true} />
                            </div>
                            <div className="flex items-end gap-2">
                                <span className="text-lg font-bold text-slate-800 dark:text-white">{thisMonthStats.attendanceRate.toFixed(0)}%</span>
                                <div className="flex-1 h-1.5 bg-gray-100 dark:bg-slate-700 rounded-full mb-1.5 overflow-hidden">
                                    <div className="h-full bg-blue-500 rounded-full" style={{width: `${thisMonthStats.attendanceRate}%`}}></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </TiltCard>
            )

            // æœ¬æœˆé¢„æµ‹å¡ç‰‡ (ç°åœ¨æ˜¯ç¬¬ä¸‰ä¸ªå¡ç‰‡)
            const ForecastCard = () => (
                <TiltCard className="glass-panel rounded-3xl p-6 flex-1 flex flex-col justify-center relative overflow-hidden hover-lift group">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                            <LucideIcon name="PieChart" size={18} className="text-indigo-600"/> æœ¬æœˆé¢„æµ‹
                        </h3>
                    </div>
                    <div className="space-y-1">
                        <div className="text-sm text-slate-500 dark:text-slate-400 font-bold uppercase tracking-wider">è–ªèµ„é¢„ä¼° (ç¨å‰)</div>
                        <div className="text-3xl font-extrabold text-slate-800 dark:text-white tracking-tight">Â¥{monthTotalEstimated.toFixed(0)}</div>
                    </div>
                    <div className="w-full h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mt-3 overflow-hidden">
                        <div className="h-full bg-slate-400" style={{width: '60%'}}></div>
                    </div>
                    <div className="mt-2 text-[10px] text-slate-400">é¢„ä¼° {workingDaysCount} å·¥ä½œæ—¥</div>
                </TiltCard>
            )

            return (
                <div className="p-6 md:p-10 space-y-8 pb-24 md:pb-10 pt-20 md:pt-10 animate-enter max-w-7xl mx-auto">
                    {/* Header */}
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 mb-6">
                        <div>
                            <h1 className="text-4xl font-extrabold text-slate-800 dark:text-white tracking-tight flex items-center gap-3">
                                {greeting.text} <LucideIcon name={greeting.icon} className={`text-${theme.accent}-500 animate-float`}/>
                            </h1>
                            <p className="text-slate-500 dark:text-slate-400 mt-2 font-medium text-lg">{quote}</p>
                        </div>
                        <div className="glass-panel px-5 py-2 rounded-2xl flex items-center gap-4 shadow-sm">
                            <div className="text-right">
                                <div className="text-2xl font-bold text-slate-800 dark:text-white tracking-tighter">{new Date().getDate()}</div>
                                <div className="text-xs text-slate-400 dark:text-slate-500 font-bold uppercase tracking-wider">{new Date().toLocaleString('default', { month: 'long' })}</div>
                            </div>
                            <div className={`h-8 w-1 bg-${theme.primary}-400 rounded-full`}></div>
                            <div className="text-sm font-bold text-slate-600 dark:text-slate-300">{isTodayWorking ? 'å·¥ä½œæ—¥' : 'ä¼‘æ¯æ—¥'}</div>
                        </div>
                    </div>

                    {loading ? (
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                           {[1,2,3,4].map(i => <Skeleton key={i} className="h-40 rounded-3xl" />)}
                           <Skeleton className="md:col-span-2 h-96 rounded-3xl" />
                           <Skeleton className="h-96 rounded-3xl" />
                        </div>
                    ) : (
                    <>
                    {/* 1. æ ¸å¿ƒæŒ‡æ ‡ (Grid 4åˆ— - è§†è§‰è¿˜åŸ) */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        {/* 1. ä»Šæ—¥æ”¶å…¥/æ›¿ä»£å¡ç‰‡ - å æ®ä¸¤æ  */}
                        {showTodayIncome ? <div className="col-span-1 md:col-span-2"><IncomeCard /></div> : <div className="col-span-1 md:col-span-2"><HiddenIncomeCard /></div>}

                        {/* 2. å­¦å‘˜æ€»æ•° (å æ® 1 æ ) */}
                        <TiltCard className="glass-panel p-6 rounded-3xl flex flex-col justify-between relative overflow-hidden hover-lift group">
                            <div className="flex justify-between items-start mb-4">
                                <div className={`p-3 rounded-2xl bg-${theme.accent}-50 text-${theme.accent}-500`}><LucideIcon name="Users" size={24}/></div>
                                <Trend curr={studentStats.current} prev={studentStats.prev} />
                            </div>
                            <div>
                                <div className="text-3xl font-bold text-slate-800 dark:text-white">{studentStats.current}</div>
                                <div className="text-xs text-slate-400 font-bold mt-1 uppercase tracking-wider">åœ¨è¯»å­¦å‘˜æ€»æ•°</div>
                            </div>
                        </TiltCard>

                        {/* 3. æ•™å­¦è´¨é‡ (å æ® 1 æ ) */}
                        <QualityCard />
                        
                        {/* ç§»é™¤ç¬¬å››ä¸ªå¡ç‰‡: æœ¬æœˆé¢„æµ‹ */}
                        {/* <ForecastCard /> */}
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* å·¦ä¾§ï¼šä»Šæ—¥è¯¾ç¨‹ */}
                        <div className="lg:col-span-2 glass-panel rounded-3xl p-8 flex flex-col h-[500px]">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-bold text-xl text-slate-800 dark:text-white flex items-center gap-3">
                                    <div className={`w-8 h-8 rounded-lg bg-${theme.primary}-100 text-${theme.primary}-600 dark:bg-slate-700 dark:text-white flex items-center justify-center`}><LucideIcon name="Calendar" size={18}/></div>
                                    ä»Šæ—¥è¯¾ç¨‹
                                </h3>
                                <span className="text-xs font-bold bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 px-3 py-1 rounded-full">{todayCourses.length} èŠ‚</span>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto space-y-4 custom-scrollbar pr-2 -mr-2">
                                {todayCourses.length > 0 ? todayCourses.map(c => (
                                    <div key={c.id} className={`group flex items-center p-4 rounded-2xl border transition-all duration-300 ${c.type==='demo' ? 'bg-purple-50/50 border-purple-100 dark:bg-purple-900/20 dark:border-purple-800 hover:border-purple-200 hover:shadow-md' : 'bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700 hover:border-blue-200 hover:shadow-md'}`}>
                                        <div className={`w-14 h-14 rounded-2xl flex flex-col items-center justify-center text-sm font-bold mr-5 shrink-0 shadow-sm ${c.type==='demo' ? 'bg-white dark:bg-slate-700 text-purple-600 dark:text-purple-400' : `bg-${theme.primary}-50 dark:bg-slate-700 text-${theme.primary}-600 dark:text-white`}`}>
                                            <span>{c.startTime.split(':')[0]}</span>
                                            <span className="text-[10px] opacity-60">:{c.startTime.split(':')[1]}</span>
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className="font-bold text-slate-800 dark:text-white text-base flex items-center gap-2 truncate">
                                                {c.className}
                                                {c.type==='demo' && <span className="bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 text-[10px] px-2 py-0.5 rounded-full font-extrabold tracking-wide">DEMO</span>}
                                            </div>
                                            <div className="text-xs text-slate-500 dark:text-slate-400 mt-1 flex items-center gap-3 font-medium">
                                                <span className="flex items-center gap-1"><LucideIcon name="Clock" size={12}/> {c.startTime}-{c.endTime}</span>
                                                {c.type !== 'demo' && <span className="flex items-center gap-1"><LucideIcon name="Users" size={12}/> {c.studentIds?.length||0}äºº</span>}
                                                {c.type === 'demo' && <span className="text-purple-500 dark:text-purple-400">è¯•å¬è¯¾</span>}
                                            </div>
                                        </div>
                                        <div className="text-right pl-4 border-l border-slate-100 dark:border-slate-700 ml-4">
                                            <div className={`text-sm font-extrabold ${c.type==='demo'?'text-purple-600 dark:text-purple-400':`text-${theme.primary}-600 dark:text-blue-400`}`}>+Â¥{c.type==='demo' ? 40 : ((c.studentIds?.length||0) * classFeeRate).toFixed(1)}</div>
                                            <div className={`mt-1.5 px-2.5 py-0.5 rounded-md text-[10px] font-bold inline-block ${c.tasks?.teachingDone ? 'bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300' : 'bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300'}`}>
                                                {c.tasks?.teachingDone ? 'å·²ç»“è¯¾' : 'å¾…ä¸Šè¯¾'}
                                            </div>
                                        </div>
                                    </div>
                                )) : (
                                    <div className="h-full flex flex-col items-center justify-center text-slate-400">
                                        <div className="w-20 h-20 bg-slate-50 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4"><LucideIcon name="Coffee" size={32} className="opacity-50"/></div>
                                        <span className="font-medium">ä»Šå¤©æ²¡æœ‰è¯¾ç¨‹å®‰æ’ï¼Œå¥½å¥½ä¼‘æ¯ä¸€ä¸‹å§~</span>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* å³ä¾§ï¼šè¯¾æ—¶è¯¦æƒ… & æ•™å¸ˆè¯„çº§ */}
                        <div className="flex flex-col gap-6 h-full">
                            {/* New Card: æœ¬æœˆè¯¾æ—¶ç»Ÿè®¡ */}
                            <div className="glass-panel rounded-3xl p-8 flex-1 flex flex-col">
                                <h3 className="font-bold text-lg text-slate-800 dark:text-white mb-6 flex items-center gap-3">
                                    <div className="w-8 h-8 rounded-lg bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 flex items-center justify-center"><LucideIcon name="PieChart" size={18}/></div>
                                    æœ¬æœˆç»©æ•ˆ
                                </h3>
                                <div className="space-y-5 flex-1">
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition-shadow group">
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <div className="text-xs text-slate-400 font-bold mb-1 uppercase tracking-wider">ç´¯è®¡å¸¸è§„è¯¾æ—¶</div>
                                                <div className="text-3xl font-bold text-slate-800 dark:text-white group-hover:text-blue-600 transition-colors">{monthRegularHours} <span className="text-sm font-normal text-slate-400">h</span></div>
                                            </div>
                                            <div className="w-12 h-12 bg-blue-50 dark:bg-blue-900/20 rounded-2xl text-blue-500 flex items-center justify-center"><LucideIcon name="Clock" size={24}/></div>
                                        </div>
                                    </div>

                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition-shadow group">
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <div className="text-xs text-slate-400 font-bold mb-1 uppercase tracking-wider">ç´¯è®¡è¯¾æ—¶è´¹</div>
                                                <div className="text-3xl font-bold text-slate-800 dark:text-white group-hover:text-orange-500 transition-colors">Â¥{monthClassFee.toFixed(0)}</div>
                                            </div>
                                            <div className="w-12 h-12 bg-orange-50 dark:bg-orange-900/20 rounded-2xl text-orange-500 flex items-center justify-center"><LucideIcon name="Coins" size={24}/></div>
                                        </div>
                                    </div>

                                    {/* æœ¬æœˆæ€»é¢„æµ‹ (æ”¾åœ¨è¿™é‡Œ) */}
                                    <div className="bg-slate-50 dark:bg-slate-800/50 p-5 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-inner">
                                        <div className="flex justify-between items-center mb-2">
                                            <div className="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase tracking-wider">æœ¬æœˆè–ªèµ„é¢„æµ‹ (ç¨å‰)</div>
                                            <div className="text-xs bg-white dark:bg-slate-700 px-2 py-0.5 rounded border dark:border-slate-600 text-slate-400 font-mono">{workingDaysCount}å·¥ä½œæ—¥</div>
                                        </div>
                                        <div className="text-2xl font-extrabold text-slate-800 dark:text-white tracking-tight">Â¥{monthTotalEstimated.toFixed(0)}</div>
                                        <div className="w-full h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mt-3 overflow-hidden">
                                            <div className="h-full bg-slate-400" style={{width: '60%'}}></div> {/* è¿™é‡Œå¯ä»¥æ˜¯æ—¶é—´è¿›åº¦ */}
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-6 pt-4 border-t border-slate-200/50 dark:border-slate-700 text-[10px] text-slate-400 flex justify-between items-center">
                                    <span className="font-mono bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded">Rate: Â¥{classFeeBase}/h</span>
                                    <span>å«å¸¸è§„ + Demo</span>
                                </div>
                            </div>
                            
                             <TiltCard className="glass-panel rounded-3xl p-6 flex items-center justify-between hover-lift cursor-default">
                                <div>
                                    <div className="text-xs text-slate-400 font-bold mb-1 uppercase tracking-wider">å½“å‰èŒçº§</div>
                                    <div className="text-lg font-bold text-slate-800 dark:text-white">{teacherLevel}</div>
                                </div>
                                <div className="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-500 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-orange-500/30"><LucideIcon name="Award" size={24}/></div>
                            </TiltCard>
                        </div>
                    </div>
                    </>)}
                </div>
            )
        }

        // 1. å­¦å‘˜ç®¡ç†
        const StudentManager = () => {
            const { students, theme, lcAdd, lcUpdate, lcDelete, loading } = useAppData();
            const addToast = useToast();
            const [isAddOpen, setIsAddOpen] = useState(false);
            const [newStudent, setNewStudent] = useState({ gender: 'ç”·', remainingHours: 0 });
            const [searchTerm, setSearchTerm] = useState('');
            
            const handleSave = async () => {
                if (!newStudent.name) return addToast("è¯·å¡«å†™å§“å", "error");
                const { id, ...data } = newStudent;
                data.remainingHours = Number(data.remainingHours || 0); 
                let success = id ? await lcUpdate('Student', id, data) : await lcAdd('Student', data);
                if(success) { setIsAddOpen(false); setNewStudent({ gender: 'ç”·', remainingHours: 0 }); addToast("ä¿å­˜æˆåŠŸ", "success"); }
            };
            // IMPORTANT: Use custom modal instead of confirm()
            const handleDelete = async (id) => { if(window.confirm('ç¡®è®¤åˆ é™¤?')) await lcDelete('Student', id); };
            
            const getPredictionText = (remaining) => {
                if (remaining <= 0) return "å·²æ¬ è´¹";
                const hoursToDeplete = remaining;
                const daysToDeplete = (hoursToDeplete / 8) * 30;
                const targetDate = new Date();
                // FIX: ä¿®æ­£æ‹¼å†™é”™è¯¯ daysTo deplete -> daysToDeplete
                targetDate.setDate(targetDate.getDate() + daysToDeplete);
                const dateStr = `${targetDate.getMonth()+1}æœˆ${targetDate.getDate()}æ—¥`;
                if (remaining <= 4) return `é¢„è®¡${dateStr}ç”¨å°½ (å‰©ä½™4è¯¾æ¬¡è­¦å‘Š)`;
                if (remaining <= 8) return `é¢„è®¡${dateStr}ç”¨å°½ (å‰©ä½™8è¯¾æ¬¡æé†’)`;
                return `é¢„è®¡${dateStr}ç”¨å°½`;
            };

            const getWarningColor = (remaining) => {
                if (remaining <= 0) return "text-slate-900 bg-slate-100 border-slate-300 dark:text-slate-100 dark:bg-slate-700 dark:border-slate-600"; 
                if (remaining <= 4) return "text-red-600 bg-red-50 border-red-200 dark:bg-red-900/30 dark:border-red-800 dark:text-red-300";   
                if (remaining <= 8) return "text-yellow-600 bg-yellow-50 border-yellow-200 dark:bg-yellow-900/30 dark:border-yellow-800 dark:text-yellow-300"; 
                return "text-emerald-600 bg-emerald-50 border-emerald-200 dark:bg-emerald-900/30 dark:border-emerald-800 dark:text-emerald-400"; 
            };
            
            // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ useMemo å®ç°æŒ‰å‰©ä½™è¯¾æ—¶ä»ä½åˆ°é«˜æ’åº
            const filteredStudents = useMemo(() => {
                return students
                    .filter(s => s.name && s.name.toLowerCase().includes(searchTerm.toLowerCase()))
                    .sort((a, b) => (a.remainingHours || 0) - (b.remainingHours || 0));
            }, [students, searchTerm]);

            return (
                <div className="p-4 space-y-6 pb-24 md:pb-4 pt-16 md:pt-4 animate-enter">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4"><h2 className="text-2xl font-bold text-gray-800 dark:text-white tracking-tight">å­¦å‘˜ç®¡ç†</h2><div className="flex gap-2 w-full md:w-auto"><div className="relative flex-1 md:w-64 group"><input className="w-full pl-10 pr-4 py-2.5 border border-gray-200 dark:border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all shadow-sm group-hover:shadow-md dark:bg-slate-800 dark:text-white" placeholder="æœç´¢å§“å..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /><div className="absolute left-3 top-3 text-gray-400 group-hover:text-blue-500 transition-colors"><LucideIcon name="Search" size={18} /></div></div><button onClick={() => { setNewStudent({gender:'ç”·', remainingHours: 0}); setIsAddOpen(true); }} className={`bg-${theme.primary}-600 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 text-sm shadow-lg shadow-${theme.primary}-500/30 hover:bg-${theme.primary}-700 hover:scale-105 active:scale-95 transition-all`}><LucideIcon name="Plus" size={18} /> æ·»åŠ </button></div></div>
                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 overflow-hidden"><div className="overflow-x-auto"><table className="min-w-full divide-y divide-gray-100 dark:divide-slate-700"><thead className="bg-gray-50/50 dark:bg-slate-700/50"><tr><th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-slate-400 uppercase tracking-wider">å§“å</th><th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-slate-400 uppercase tracking-wider">å‰©ä½™è¯¾æ—¶</th><th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-slate-400 uppercase tracking-wider">é¢„æµ‹</th><th className="px-6 py-4 text-right text-xs font-semibold text-gray-500 dark:text-slate-400 uppercase tracking-wider">æ“ä½œ</th></tr></thead><tbody className="bg-white dark:bg-slate-800 divide-y divide-gray-50 dark:divide-slate-700">{filteredStudents.map((s, idx) => (<tr key={s.id} className="hover:bg-gray-50/80 dark:hover:bg-slate-700/50 transition-colors animate-pop" style={{animationDelay: `${idx * 50}ms`}}><td className="px-6 py-4 font-medium text-gray-900 dark:text-white">{s.name} <span className="text-xs text-gray-400 ml-1">({s.gender})</span></td><td className="px-6 py-4"><span className={`px-2.5 py-1 rounded-lg text-xs font-bold border ${getWarningColor(s.remainingHours || 0)}`}>{s.remainingHours || 0} è¯¾æ—¶</span></td><td className="px-6 py-4 text-xs text-gray-500 dark:text-slate-400">{getPredictionText(s.remainingHours || 0)}</td><td className="px-6 py-4 text-right"><button onClick={() => {setNewStudent(s); setIsAddOpen(true)}} className={`text-${theme.primary}-600 mr-4 text-sm font-medium hover:underline hover:scale-105 inline-block transition-transform`}>ç¼–è¾‘</button><button onClick={() => handleDelete(s.id)} className="text-red-500 text-sm font-medium hover:underline hover:scale-105 inline-block transition-transform">åˆ é™¤</button></td></tr>))}</tbody></table></div>{filteredStudents.length === 0 && <div className="p-12 text-center text-gray-400 dark:text-slate-500">æœªæ‰¾åˆ°ç›¸å…³å­¦å‘˜</div>}</div>
                    <Modal isOpen={isAddOpen} onClose={() => setIsAddOpen(false)} title={newStudent.id ? "ç¼–è¾‘å­¦å‘˜" : "æ·»åŠ å­¦å‘˜"}><div className="space-y-5"><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">å§“å</label><input className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl focus:ring-2 focus:ring-blue-500/20 outline-none transition-all dark:bg-slate-700 dark:text-white" placeholder="è¾“å…¥å§“å" value={newStudent.name||''} onChange={e=>setNewStudent({...newStudent, name:e.target.value})} /></div><div><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">å‰©ä½™è¯¾æ—¶</label><input type="number" className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl focus:ring-2 focus:ring-blue-500/20 outline-none transition-all font-mono font-bold dark:bg-slate-700 dark:text-white" value={newStudent.remainingHours||0} onChange={e=>setNewStudent({...newStudent, remainingHours:e.target.value})} /></div></div><div className="flex gap-4"><div className="flex-1"><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">æ€§åˆ«</label><select className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl bg-white dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-blue-500/20 outline-none transition-all" value={newStudent.gender||'ç”·'} onChange={e=>setNewStudent({...newStudent, gender:e.target.value})}><option>ç”·</option><option>å¥³</option></select></div><div className="flex-1"><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">å¹´é¾„</label><input className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl focus:ring-2 focus:ring-blue-500/20 outline-none transition-all dark:bg-slate-700 dark:text-white" type="number" placeholder="0" value={newStudent.age||''} onChange={e=>setNewStudent({...newStudent, age:e.target.value})} /></div></div><div><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">å¤‡æ³¨ä¿¡æ¯</label><textarea className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl h-24 text-sm focus:ring-2 focus:ring-blue-500/20 outline-none transition-all resize-none dark:bg-slate-700 dark:text-white" placeholder="è¾“å…¥å­¦å‘˜æƒ…å†µ..." value={newStudent.notes||''} onChange={e=>setNewStudent({...newStudent, notes:e.target.value})}></textarea></div><button onClick={handleSave} className={`w-full bg-${theme.primary}-600 text-white px-6 py-3.5 rounded-xl font-bold hover:bg-${theme.primary}-700 hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0 transition-all duration-200`}>ä¿å­˜å­¦å‘˜ä¿¡æ¯</button></div></Modal>
                </div>
            );
        };

        // 2. è¯¾ç¨‹è¡¨
        const CourseSchedule = () => {
            const { courses, students, classGroups, calendarDays, formatDate, theme, lcAdd, lcUpdate, lcDelete, setCourses, viewMode, setViewMode, classFeeBase, fetchAll, loading } = useAppData();
            const addToast = useToast();
            const [selectedCourse, setSelectedCourse] = useState(null);
            const [isEditOpen, setIsEditOpen] = useState(false);
            const [newCourse, setNewCourse] = useState({ type: 'regular' });
            
            // æ–°å¢ï¼šç”¨äºè¯¾ç¨‹ç®¡ç†æ·»åŠ å­¦å‘˜æ—¶çš„æœç´¢è¯
            const [studentSearchTerm, setStudentSearchTerm] = useState('');

            // è·å–åŸå§‹è¯¾ç¨‹å¯¹è±¡ï¼Œç”¨äºæ¯”è¾ƒè€ƒå‹¤çŠ¶æ€
            const originalCourse = useMemo(() => {
                return selectedCourse ? courses.find(c => c.id === selectedCourse.id) : null;
            }, [selectedCourse, courses]);

            const handleCellClick = (dStr, dayIndex) => {
                setNewCourse({ dateStr: dStr, dayOfWeek: dayIndex, startTime: '09:00', endTime: '10:00', studentIds: [], tasks: {}, attendance: {}, type: 'regular' });
                setSelectedCourse(null); setIsEditOpen(true);
                setStudentSearchTerm(''); // é‡ç½®æœç´¢è¯
            };

            // **ä¿®æ”¹åçš„ä¿å­˜å‡½æ•°ï¼šç»Ÿä¸€å¤„ç†è€ƒå‹¤å’Œè¯¾æ—¶æ‰£é™¤**
            const saveCourse = async () => {
                if (!newCourse.className) return addToast("è¯·å¡«å†™è¯¾ç¨‹åç§°", "error");
                const { id, ...data } = newCourse;
                
                let studentsToUpdate = [];
                let studentUpdates = {}; // { studentId: deltaRemainingHours }

                if (newCourse.type !== 'demo' && id && originalCourse) {
                    const newAttendance = newCourse.attendance || {};
                    const oldAttendance = originalCourse.attendance || {};

                    // éå†æ‰€æœ‰å­¦ç”Ÿï¼Œè®¡ç®—è¯¾æ—¶å˜åŒ–
                    for (const sid of newCourse.studentIds || []) {
                        const student = students.find(s => s.id === sid);
                        if (!student) continue;

                        const newStatus = newAttendance[sid]?.status;
                        const oldStatus = oldAttendance[sid]?.status;
                        const isMadeUp = oldAttendance[sid]?.isMadeUp; 

                        let delta = 0;

                        // è§„åˆ™ 1: ä»ä»æœªåˆ°/ç¼ºå‹¤/æœªè®° -> åˆ°è¯¾ (ä¸”éå·²è¡¥è¯¾çŠ¶æ€)
                        if (newStatus === 'present' && oldStatus !== 'present' && !isMadeUp) {
                            // æ‰£é™¤ 2 è¯¾æ—¶
                            delta = -2;
                            studentsToUpdate.push({ id: sid, name: student.name, delta: delta });
                        } 
                        // è§„åˆ™ 2: ä»åˆ°è¯¾ -> ç¼ºå‹¤/æœªè®° (å³å–æ¶ˆåˆ°è¯¾)
                        else if (newStatus !== 'present' && oldStatus === 'present' && !isMadeUp) {
                            // è¿”è¿˜ 2 è¯¾æ—¶
                            delta = 2;
                            studentsToUpdate.push({ id: sid, name: student.name, delta: delta });
                        }
                        // è§„åˆ™ 3: ç¼ºå‹¤ (absent) æˆ–æœªè®° (undefined/null) -> å‡ä¸æ‰£è¯¾
                        // è§„åˆ™ 4: çŠ¶æ€ä¸å˜ (present->present æˆ– absent->absent) -> delta = 0
                        // è§„åˆ™ 5: å·²è¡¥è¯¾çŠ¶æ€ (isMadeUp=true) çŠ¶æ€æ”¹å˜ï¼Œä¸åº”è¯¥å†æ¬¡è¿›è¡Œæ‰£é™¤/è¿”è¿˜ï¼Œå› ä¸ºè¡¥è¯¾æ—¶å·²ç»æ‰£é™¤äº†ã€‚

                        if (delta !== 0) {
                            studentUpdates[sid] = (studentUpdates[sid] || 0) + delta;
                        }

                        // ç¡®ä¿æ–°è¯¾ç¨‹çš„è€ƒå‹¤è®°å½•ä¿æŒ isMadeUp çŠ¶æ€ï¼ˆAttendanceManagerè´Ÿè´£æ›´æ”¹ï¼‰
                        if (isMadeUp) {
                             newCourse.attendance[sid] = { ...newCourse.attendance[sid], isMadeUp: isMadeUp };
                        }
                    }
                }
                
                // 1. æ›´æ–°è¯¾ç¨‹ä¿¡æ¯ (åŒ…æ‹¬æœ€æ–°çš„è€ƒå‹¤çŠ¶æ€)
                let success = id ? await lcUpdate('Course', id, data) : await lcAdd('Course', data);

                if (success && studentsToUpdate.length > 0) {
                    // 2. æ‰¹é‡æ›´æ–°å­¦å‘˜è¯¾æ—¶
                    for (const sid in studentUpdates) {
                        const delta = studentUpdates[sid];
                        const student = students.find(s => s.id === sid);
                        if (student) {
                            const newRemaining = (student.remainingHours || 0) + delta;
                            await lcUpdate('Student', sid, { remainingHours: newRemaining });
                            
                            const updateMsg = delta < 0 ? `å·²æ‰£é™¤ ${student.name} ${Math.abs(delta)} è¯¾æ—¶` : `å·²è¿”è¿˜ ${student.name} ${Math.abs(delta)} è¯¾æ—¶`;
                            addToast(updateMsg, delta < 0 ? "success" : "info");
                        }
                    }
                }

                if(success) { 
                    setIsEditOpen(false); 
                    addToast("æ’è¯¾ä¿¡æ¯åŠè€ƒå‹¤å·²ä¿å­˜", "success"); 
                }
            };
            // **ç»“æŸä¿®æ”¹åçš„ä¿å­˜å‡½æ•°**

            const deleteCourse = async () => { 
                // IMPORTANT: Use custom modal instead of confirm()
                if(window.confirm("åˆ é™¤è¯¾ç¨‹? (æ³¨æ„ï¼šåˆ é™¤è¯¾ç¨‹ä¸ä¼šè‡ªåŠ¨è¿”è¿˜è¯¾æ—¶ï¼Œå­¦å‘˜è¯¾æ—¶éœ€æ‰‹åŠ¨æ£€æŸ¥å¹¶è¿”è¿˜)")) { 
                    // è­¦å‘Šï¼šåˆ é™¤è¯¾ç¨‹ä¸ä¼šè‡ªåŠ¨è¿”è¿˜è¯¾æ—¶ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨å¤„ç†
                    await lcDelete('Course', selectedCourse.id); 
                    setIsEditOpen(false); 
                    addToast("è¯¾ç¨‹å·²åˆ é™¤ (è¯·æ£€æŸ¥å­¦å‘˜è¯¾æ—¶æ˜¯å¦éœ€è¦æ‰‹åŠ¨è¿”è¿˜)", "error");
                } 
            };
            
            // æ­¤å‡½æ•°ä»…ç”¨äºåœ¨ CourseSchedule å†…éƒ¨æ›´æ–° Courseï¼Œç°åœ¨ä»…ç”¨äºæ›´æ–° Tasks
            const updateDirectly = async (id, data) => {
                setCourses(prev => prev.map(c => c.id === id ? {...c, ...data} : c));
                const obj = AV.Object.createWithoutData('Course', id);
                Object.keys(data).forEach(k => {
                     if (['id', 'objectId', 'createdAt', 'updatedAt'].includes(k)) return;
                     obj.set(k, data[k]);
                });
                await obj.save();
            };

            // **ä¿®æ”¹åçš„ toggleAttï¼šåªæ›´æ–° newCourse çŠ¶æ€**
            const toggleAtt = (sid, status) => {
                if (newCourse.type === 'demo') return;

                setNewCourse(prev => { 
                    const att = prev.attendance || {};
                    const currentStatus = att[sid]?.status;
                    let newStatus = status;

                    // é€»è¾‘: å¦‚æœç‚¹å‡»çš„çŠ¶æ€ä¸å½“å‰çŠ¶æ€ç›¸åŒï¼Œåˆ™å–æ¶ˆè€ƒå‹¤ (è®¾ä¸º undefined/null)
                    if (currentStatus === status) {
                        newStatus = undefined; // å–æ¶ˆé€‰æ‹©
                    }

                    // å¤åˆ¶ç°æœ‰è€ƒå‹¤è®°å½•ï¼Œä¿ç•™ isMadeUp çŠ¶æ€
                    const existingRecord = originalCourse?.attendance?.[sid] || att[sid] || {};
                    
                    const newAtt = { ...att };
                    if (newStatus) {
                         // è®¾ç½®æ–°çŠ¶æ€ï¼Œå¹¶ç¡®ä¿ isMadeUp çŠ¶æ€è¢«ä¿ç•™
                        newAtt[sid] = { 
                            studentId: sid, 
                            status: newStatus,
                            isMadeUp: existingRecord.isMadeUp || false 
                        };
                    } else {
                        // å–æ¶ˆè€ƒå‹¤ï¼Œåˆ é™¤è®°å½•ï¼Œä½†ä¿ç•™ isMadeUp çŠ¶æ€
                         // æ³¨æ„ï¼šè¿™é‡Œåˆ é™¤ä¼šä¸¢å¤± isMadeUp çŠ¶æ€ï¼Œæˆ‘ä»¬åº”è¯¥æ”¹ä¸º set status: undefined æ¥ä¿ç•™è®°å½•
                         newAtt[sid] = { 
                            studentId: sid, 
                            status: undefined,
                            isMadeUp: existingRecord.isMadeUp || false 
                        };
                        // ä¿®æ­£ï¼šå¦‚æœå–æ¶ˆé€‰æ‹©ï¼Œç›´æ¥ä½¿ç”¨ delete newAtt[sid] å¯èƒ½ä¼šä¸¢å¤±å†å² isMadeUp æ ‡è®°ã€‚
                        // ç”±äºåç«¯é€»è¾‘å¯èƒ½ä¾èµ– status çš„å­˜åœ¨ï¼Œæˆ‘ä»¬ç®€åŒ–å¤„ç†ï¼šå¦‚æœçŠ¶æ€è¢«å–æ¶ˆï¼Œè®¾ç½®ä¸º status: undefined/null
                        // ä¸ºäº†ç¡®ä¿çŠ¶æ€èƒ½è¢«æ­£ç¡®è¯†åˆ«å’Œä¿å­˜ï¼Œæ­¤å¤„æˆ‘ä»¬ç›´æ¥ deleteï¼Œä¾èµ– saveCourse æ—¶çš„ originalCourse æ£€æŸ¥ã€‚
                        delete newAtt[sid]; 
                    }

                    return { ...prev, attendance: newAtt }; 
                });
                // æ³¨æ„ï¼šè¿™é‡Œä¸å†è°ƒç”¨ä»»ä½• lcUpdate æˆ– updateDirectly
                addToast(`è€ƒå‹¤çŠ¶æ€å·²ä¿®æ”¹ä¸ºï¼š${status === 'present' ? 'åˆ°' : status === 'absent' ? 'ç¼º' : 'æœªè®°'} (å¾…ä¿å­˜)`, "info");
            };
            // **ç»“æŸä¿®æ”¹åçš„ toggleAtt**
            
            const toggleTask = (t) => {
                // å¦‚æœæ˜¯æ–°è¯¾ç¨‹ï¼Œåˆ™ç›´æ¥ä¿®æ”¹ newCourse çŠ¶æ€
                if(!selectedCourse?.id) { 
                    setNewCourse(prev => { 
                        const tasks = prev.tasks || {}; 
                        return {...prev, tasks: {...tasks, [t]: !tasks[t]}}; 
                    }); 
                    return; 
                }
                
                // å¦‚æœæ˜¯å·²å­˜åœ¨çš„è¯¾ç¨‹ï¼Œåªæ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œç»Ÿä¸€åœ¨ä¿å­˜æ—¶æ›´æ–°æ•°æ®åº“
                setNewCourse(prev => {
                    const tasks = prev.tasks || selectedCourse.tasks || {};
                    return {...prev, tasks: {...tasks, [t]: !tasks[t]}};
                });
                
                // æš‚æ—¶æ³¨é‡Šæ‰ç›´æ¥æ›´æ–°æ•°æ®åº“çš„ä»£ç ï¼Œç»Ÿä¸€åœ¨ saveCourse ä¸­å¤„ç† tasks çš„ä¿å­˜
                // updateDirectly(selectedCourse.id, { tasks: newTasks });
            };

            const handleStudentSelect = (sid) => { 
                if(sid && !newCourse.studentIds?.includes(sid)) { 
                    setNewCourse(prev => ({...prev, studentIds: [...(prev.studentIds||[]), sid]})); 
                    setStudentSearchTerm(''); // æ·»åŠ åæ¸…ç©ºæœç´¢
                }
            };
            const handleClassGroupSelect = (e) => { 
                const gid = e.target.value; 
                const g = classGroups.find(x => x.id === gid); 
                if(g) { 
                    setNewCourse(prev => { 
                        const currentIds = prev.studentIds || []; 
                        const newIds = [...new Set([...currentIds, ...(g.studentIds||[])])]; 
                        return {...prev, studentIds: newIds}; 
                    }); 
                    addToast(`å·²å¯¼å…¥ ${g.name}`, "success"); 
                } 
                e.target.value = ""; 
            };
            
            // æœç´¢è¿‡æ»¤åçš„å­¦ç”Ÿåˆ—è¡¨
            const searchableStudents = useMemo(() => {
                if (!studentSearchTerm) return students.filter(s => !newCourse.studentIds?.includes(s.id));
                const lowerSearch = studentSearchTerm.toLowerCase();
                return students.filter(s => 
                    s.name?.toLowerCase().includes(lowerSearch) && 
                    !newCourse.studentIds?.includes(s.id)
                );
            }, [students, studentSearchTerm, newCourse.studentIds]);

            const currentViewCourses = courses.filter(c => { const start = calendarDays[0]; const end = calendarDays[calendarDays.length - 1]; return c.dateStr >= formatDate(start) && c.dateStr <= formatDate(end); });
            const currentViewHours = currentViewCourses.reduce((acc, c) => { if (c.type === 'demo') return acc; const studentCount = c.studentIds ? c.studentIds.length : 0; return acc + (studentCount * 2); }, 0);
            const classFeeRate = 1.5 * (classFeeBase || 0);
            const viewText = viewMode === 'day' ? 'æœ¬æ—¥' : viewMode === 'week' ? 'æœ¬å‘¨' : 'æœ¬æœˆ';
            const gridColsClass = viewMode === 'day' ? 'grid-cols-1' : viewMode === 'month' ? 'grid-cols-7' : 'grid-cols-1 md:grid-cols-7';

            return (
                <div className="flex flex-col h-full overflow-hidden animate-enter">
                    <div className="flex justify-between items-center p-4 bg-white dark:bg-slate-800 border-b border-gray-100 dark:border-slate-700 shadow-sm z-10 pt-16 md:pt-4"><div className="flex items-center gap-4"><h2 className="text-xl font-bold text-gray-800 dark:text-white tracking-tight">è¯¾ç¨‹è¡¨</h2><div className="hidden md:flex items-center bg-blue-50 dark:bg-blue-900/30 px-3 py-1 rounded-lg border border-blue-100 dark:border-blue-800 text-blue-700 dark:text-blue-300 text-xs font-bold gap-1"><LucideIcon name="Clock" size={14}/> {viewText}å¸¸è§„è¯¾æ—¶: {currentViewHours}</div><div className="flex bg-gray-100 dark:bg-slate-700 p-1 rounded-xl text-xs font-medium"><button onClick={()=>setViewMode('day')} className={`px-3 py-1.5 rounded-lg transition-all duration-200 ${viewMode==='day'?'bg-white dark:bg-slate-600 shadow-sm text-gray-800 dark:text-white scale-105':'text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>æ—¥</button><button onClick={()=>setViewMode('week')} className={`px-3 py-1.5 rounded-lg transition-all duration-200 ${viewMode==='week'?'bg-white dark:bg-slate-600 shadow-sm text-gray-800 dark:text-white scale-105':'text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>å‘¨</button><button onClick={()=>setViewMode('month')} className={`px-3 py-1.5 rounded-lg transition-all duration-200 ${viewMode==='month'?'bg-white dark:bg-slate-600 shadow-sm text-gray-800 dark:text-white scale-105':'text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>æœˆ</button></div></div><WeekNavigator /></div>
                    {loading ? (<div className="flex-1 p-4 grid grid-cols-1 md:grid-cols-7 gap-2">{[...Array(7)].map((_, i) => <Skeleton key={i} className="h-96 rounded-xl" />)}</div>) : (
                    <div className="flex-1 overflow-auto bg-gray-50 dark:bg-slate-900 p-2 pb-24 md:pb-4"><div className={`grid ${gridColsClass} gap-2`}>{calendarDays.map((d, i) => { const dStr = formatDate(d); const dayCourses = currentViewCourses.filter(c => c.dateStr === dStr).sort((a,b)=>a.startTime.localeCompare(b.startTime)); const isToday = dStr === formatDate(new Date()); const isMonthView = viewMode === 'month'; return (<div key={dStr} onClick={()=>handleCellClick(dStr, i)} className={`${isMonthView ? 'min-h-[100px]' : 'min-h-[120px] md:min-h-[400px]'} border rounded-xl p-2 transition-all duration-200 cursor-pointer ${isToday ? `bg-${theme.primary}-50/50 dark:bg-slate-800 border-${theme.primary}-200 dark:border-${theme.primary}-700 ring-2 ring-${theme.primary}-100 dark:ring-${theme.primary}-900` : 'bg-white dark:bg-slate-800 border-gray-200 dark:border-slate-700 hover:border-gray-300 hover:shadow-md'}`}><div className={`text-center py-1 border-b border-gray-100 dark:border-slate-700 mb-2 text-xs font-bold ${isToday ? `text-${theme.primary}-600` : 'text-gray-500 dark:text-slate-400'}`}>{isMonthView ? (<div className="flex justify-between px-1"><span className="opacity-50 text-[10px]">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]}</span><span>{d.getDate()}</span></div>) : (<div className="flex justify-between md:justify-center px-1"><span>å‘¨{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]}</span><span className="opacity-75">{dStr.slice(5)}</span></div>)}</div><div className="space-y-1.5">{dayCourses.map((c, idx) => (<div key={c.id} onClick={(e)=>{e.stopPropagation(); setSelectedCourse(c); setNewCourse(c); setIsEditOpen(true);}} className={`bg-white dark:bg-slate-700 border-l-4 border-${theme.primary}-500 shadow-sm p-2 rounded text-xs hover:shadow-md hover:-translate-y-0.5 transition-all group overflow-hidden animate-pop`} style={{animationDelay: `${idx * 50}ms`}}><div className="font-bold truncate text-gray-800 dark:text-white">{c.className}</div>{!isMonthView && <div className="text-gray-500 dark:text-slate-400 mt-1 flex items-center gap-1"><LucideIcon name="Clock" size={10}/> {c.startTime}-{c.endTime}</div>}{!isMonthView && <div className="mt-1 pt-1 border-t border-gray-100 dark:border-slate-600 flex items-center gap-1 text-gray-400 group-hover:text-${theme.primary}-500"><LucideIcon name="Users" size={10}/> {c.studentIds?.length||0}äºº</div>}{isMonthView && <div className="text-[10px] text-gray-400 truncate mt-0.5">{c.startTime}</div>}</div>))}</div></div>) })}</div></div>
                    )}
                    <Modal isOpen={isEditOpen} onClose={()=>setIsEditOpen(false)} title={selectedCourse ? "è¯¾ç¨‹è¯¦æƒ…" : "æ–°è¯¾ç¨‹æ’è¯¾"}><div className="space-y-5"><div className="flex gap-4 p-1 bg-gray-100 dark:bg-slate-700 rounded-xl"><button onClick={()=>setNewCourse({...newCourse, type:'regular'})} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${newCourse.type!=='demo' ? 'bg-white dark:bg-slate-600 shadow text-blue-600 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400'}`}>å¸¸è§„è¯¾</button><button onClick={()=>setNewCourse({...newCourse, type:'demo'})} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${newCourse.type==='demo' ? 'bg-white dark:bg-slate-600 shadow text-purple-600 dark:text-purple-400' : 'text-gray-500 dark:text-gray-400'}`}>Demoè¯•å¬è¯¾</button></div><div className="grid grid-cols-2 gap-4"><div className="col-span-2 md:col-span-1"><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">è¯¾ç¨‹åç§°</label><input className="w-full border border-gray-200 dark:border-slate-600 p-2.5 rounded-xl focus:ring-2 focus:ring-blue-500/20 outline-none dark:bg-slate-700 dark:text-white" value={newCourse.className||''} onChange={e=>setNewCourse({...newCourse, className:e.target.value})} /></div><div className="col-span-2 md:col-span-1 flex flex-col"><div className="flex justify-between mb-1"><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase">å†…å®¹/å¤‡æ³¨</label></div><input className="w-full border border-gray-200 dark:border-slate-600 p-2.5 rounded-xl focus:ring-2 focus:ring-blue-500/20 outline-none dark:bg-slate-700 dark:text-white" value={newCourse.content||''} onChange={e=>setNewCourse({...newCourse, content:e.target.value})} placeholder={newCourse.type==='demo'?"è¯·åœ¨æ­¤è®°å½•è¯•å¬å­¦ç”Ÿå§“å":"è¯¾ç¨‹å†…å®¹"} /></div><div><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">å¼€å§‹</label><input type="time" className="w-full border border-gray-200 dark:border-slate-600 p-2.5 rounded-xl focus:ring-2 focus:ring-blue-500/20 outline-none dark:bg-slate-700 dark:text-white" value={newCourse.startTime||''} onChange={e=>setNewCourse({...newCourse, startTime:e.target.value})} /></div><div><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">ç»“æŸ</label><input type="time" className="w-full border border-gray-200 dark:border-slate-600 p-2.5 rounded-xl focus:ring-2 focus:ring-blue-500/20 outline-none dark:bg-slate-700 dark:text-white" value={newCourse.endTime||''} onChange={e=>setNewCourse({...newCourse, endTime:e.target.value})} /></div></div>{newCourse.type !== 'demo' ? (<div className="bg-gray-50/80 dark:bg-slate-700/50 p-4 rounded-xl border border-gray-200 dark:border-slate-600"><div className="flex gap-3 mb-3"><select className="border border-gray-200 dark:border-slate-600 p-2 rounded-lg text-xs flex-1 bg-white dark:bg-slate-700 dark:text-white hover:border-gray-300 transition-colors" onChange={handleClassGroupSelect}><option value="">+ å¯¼å…¥ç­çº§</option>{classGroups.map(g=><option key={g.id} value={g.id}>{g.name}</option>)}</select><div className="relative flex-1"><div className="flex items-center border border-gray-200 dark:border-slate-600 p-2 rounded-lg bg-white dark:bg-slate-700 dark:text-white hover:border-gray-300 transition-colors"><LucideIcon name="Search" size={14} className="text-gray-400 mr-2"/> <input type="text" placeholder="æœç´¢å­¦å‘˜æ·»åŠ ..." className="w-full text-xs bg-transparent outline-none" value={studentSearchTerm} onChange={e => setStudentSearchTerm(e.target.value)} /></div>{studentSearchTerm && searchableStudents.length > 0 && (<div className="absolute top-full left-0 w-full mt-1 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-lg shadow-lg max-h-40 overflow-y-auto z-20">{searchableStudents.map(s => (<div key={s.id} className="p-2 text-xs text-gray-800 dark:text-white cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-600" onClick={() => handleStudentSelect(s.id)}>{s.name} ({s.remainingHours}h)</div>))}{searchableStudents.length > 5 && <div className="text-center p-2 text-xs text-gray-400 border-t border-gray-100 dark:border-slate-600">...</div>}</div>)}{studentSearchTerm && searchableStudents.length === 0 && (<div className="absolute top-full left-0 w-full mt-1 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-lg shadow-lg p-2 text-xs text-gray-400 z-20">æœªæ‰¾åˆ°å­¦å‘˜</div>)}</div></div><div className="flex flex-wrap gap-2 min-h-[2rem]">{newCourse.studentIds?.map(sid => { const st = students.find(s=>s.id===sid); return st ? <span key={sid} className="bg-white dark:bg-slate-600 border px-2.5 py-1 rounded-lg text-xs flex items-center gap-1.5 shadow-sm animate-pop dark:text-white dark:border-slate-500">{st.name} <button onClick={()=>setNewCourse(prev=>({...prev, studentIds: prev.studentIds.filter(id=>id!==sid)}))} className="text-red-400 hover:text-red-600 font-bold px-1 rounded hover:bg-red-50 dark:hover:bg-red-900/30">Ã—</button></span> : null; })}</div></div>) : (<div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-xl border border-purple-100 dark:border-purple-800 text-xs text-purple-700 dark:text-purple-300 flex items-center gap-2"><LucideIcon name="Sparkles" size={16}/><span>Demoè¯¾ä¸ºè¯•å¬æ€§è´¨ï¼Œä¸å…³è”ç³»ç»Ÿå­¦å‘˜ï¼Œè¯¾é…¬å›ºå®š Â¥40/èŠ‚ã€‚è¯·åœ¨å¤‡æ³¨æ è®°å½•å­¦ç”Ÿå§“åã€‚</span></div>)}{selectedCourse && (<div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs"><div className="border border-orange-100 dark:border-orange-900/50 p-3 rounded-xl bg-orange-50/50 dark:bg-orange-900/20"><div className="font-bold mb-3 text-orange-800 dark:text-orange-400 flex items-center gap-2"><LucideIcon name="ClipboardList" size={16}/> æ•™å¸ˆä»»åŠ¡</div><div className="space-y-2">{['teachingDone','interpretationSent','homeworkSent','reflectionDone'].map(k => (<label key={k} className="flex items-center gap-2 cursor-pointer hover:bg-orange-100/50 dark:hover:bg-orange-800/30 p-1.5 rounded-lg transition-colors" key={k}><input type="checkbox" className="rounded text-orange-500 focus:ring-orange-500" checked={newCourse.tasks?.[k]||false} onChange={()=>toggleTask(k)} /> <span className="dark:text-slate-300">{k==='teachingDone'?'æˆè¯¾å®Œæˆ':k==='interpretationSent'?'è§£è¯»å‘é€':k==='homeworkSent'?'ä½œä¸šå‘é€':'åæ€å®Œæˆ'}</span></label>))}</div></div>{newCourse.type !== 'demo' && (<div className="border border-blue-100 dark:border-blue-900/50 p-3 rounded-xl bg-blue-50/50 dark:bg-blue-900/20"><div className="font-bold mb-3 text-blue-800 dark:text-blue-400 flex items-center gap-2"><LucideIcon name="UserCheck" size={16}/> è€ƒå‹¤æ‰“å¡</div><div className="max-h-40 overflow-y-auto space-y-1 pr-1 custom-scrollbar">{newCourse.studentIds?.map(sid => { const st = students.find(s=>s.id===sid); const status = newCourse.attendance?.[sid]?.status; const isMadeUp = originalCourse?.attendance?.[sid]?.isMadeUp || false; return st ? <div key={sid} className="flex justify-between items-center p-1.5 hover:bg-blue-100/50 dark:hover:bg-blue-800/30 rounded-lg transition-colors"><span className="dark:text-slate-300">{st.name} {isMadeUp && <span className="text-[10px] text-green-500">(å·²è¡¥)</span>}</span> <div className="flex gap-1"><button onClick={()=>toggleAtt(sid,'present')} className={`px-2 py-0.5 rounded text-[10px] border transition-all ${status==='present'?'bg-green-500 text-white border-green-600 shadow-sm':'bg-white dark:bg-slate-700 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-slate-600'}`}>åˆ°</button><button onClick={()=>toggleAtt(sid,'absent')} className={`px-2 py-0.5 rounded text-[10px] border transition-all ${status==='absent'?'bg-red-500 text-white border-red-600 shadow-sm':'bg-white dark:bg-slate-700 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-slate-600'}`}>ç¼º</button></div></div> : null; })}</div></div>)}</div>)}<div className="flex gap-3 pt-2">{selectedCourse && <button onClick={deleteCourse} className="text-red-500 text-sm border border-red-200 px-5 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/30 hover:border-red-300 transition-colors">åˆ é™¤</button>}<div className="flex-1"></div><button onClick={() => setIsEditOpen(false)} className="text-gray-500 dark:text-gray-400 px-5 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">å–æ¶ˆ</button><button onClick={saveCourse} className={`bg-${theme.primary}-600 text-white px-8 py-2.5 rounded-xl shadow-lg shadow-${theme.primary}-200 dark:shadow-none font-medium hover:bg-${theme.primary}-700 hover:-translate-y-0.5 transition-all`}>ä¿å­˜</button></div></div></Modal>
                </div>
            );
        };

        const WeekNavigator = () => {
            const { changeWeek, calendarDays, formatDate, viewMode } = useAppData();
            const title = useMemo(() => {
                if (!calendarDays.length) return "";
                const start = calendarDays[0];
                if (viewMode === 'day') return formatDate(start);
                if (viewMode === 'month') return `${start.getFullYear()}å¹´ ${start.getMonth() + 1}æœˆ`;
                const end = calendarDays[calendarDays.length - 1];
                return `${formatDate(start).slice(5)} - ${formatDate(end).slice(5)}`;
            }, [calendarDays, viewMode, formatDate]);

            return (
                <div className="flex items-center gap-2 bg-gray-50 dark:bg-slate-700 rounded-xl p-1.5 border border-gray-200 dark:border-slate-600">
                    <button onClick={()=>changeWeek(-1)} className="p-1.5 rounded-lg hover:bg-white dark:hover:bg-slate-600 hover:shadow-sm text-gray-600 dark:text-gray-300 transition-all"><LucideIcon name="ChevronLeft" size={18}/></button>
                    <span className="text-xs px-3 font-bold text-gray-700 dark:text-gray-300 min-w-[90px] text-center">{title}</span>
                    <button onClick={()=>changeWeek(1)} className="p-1.5 rounded-lg hover:bg-white dark:hover:bg-slate-600 hover:shadow-sm text-gray-600 dark:text-gray-300 transition-all"><LucideIcon name="ChevronRight" size={18}/></button>
                </div>
            )
        }

        // 3. ç­çº§ç®¡ç†
        const ClassGroupManager = () => {
            const { classGroups, students, theme, lcAdd, lcUpdate, lcDelete } = useAppData();
            const addToast = useToast();
            const [isEdit, setIsEdit] = useState(false);
            const [group, setGroup] = useState({});
            
            // æ–°å¢ï¼šç”¨äºç­çº§ç®¡ç†æ·»åŠ å­¦å‘˜æ—¶çš„æœç´¢è¯
            const [studentSearchTerm, setStudentSearchTerm] = useState('');

            const save = async () => { if(group.name){ const { id, ...data } = group; let success = id ? await lcUpdate('ClassGroup', id, data) : await lcAdd('ClassGroup', data); if(success) { setIsEdit(false); setGroup({}); addToast("ä¿å­˜æˆåŠŸ", "success"); } } };
            // IMPORTANT: Use custom modal instead of confirm()
            const deleteGroup = async (id) => { if(window.confirm('åˆ é™¤?')) await lcDelete('ClassGroup', id); };
            
            // æœç´¢è¿‡æ»¤åçš„å­¦ç”Ÿåˆ—è¡¨ (ç”¨äºç­çº§æ·»åŠ  modal)
            const searchableStudents = useMemo(() => {
                if (!studentSearchTerm) return students.filter(s => !group.studentIds?.includes(s.id));
                const lowerSearch = studentSearchTerm.toLowerCase();
                return students.filter(s => 
                    s.name?.toLowerCase().includes(lowerSearch) && 
                    !group.studentIds?.includes(s.id)
                );
            }, [students, studentSearchTerm, group.studentIds]);
            
            const handleStudentToggle = (sid) => {
                setGroup(prev => {
                    const ids = prev.studentIds || [];
                    const newIds = ids.includes(sid) ? ids.filter(i => i !== sid) : [...ids, sid];
                    return { ...prev, studentIds: newIds };
                });
                setStudentSearchTerm(''); // æ·»åŠ æˆ–ç§»é™¤åæ¸…ç©ºæœç´¢
            };
            
            const handleModalOpen = (g) => {
                setGroup(g);
                setIsEdit(true);
                setStudentSearchTerm(''); // æ¯æ¬¡æ‰“å¼€é‡ç½®æœç´¢
            }

            return (
                <div className="p-4 space-y-6 pb-24 md:pb-4 pt-16 md:pt-4 animate-enter">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-gray-800 dark:text-white tracking-tight">ç­çº§ç®¡ç†</h2><button onClick={()=>{handleModalOpen({name:'', studentIds:[]});}} className={`bg-${theme.primary}-600 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 text-sm shadow-lg shadow-${theme.primary}-500/30 hover:bg-${theme.primary}-700 hover:scale-105 active:scale-95 transition-all`}><LucideIcon name="Plus" size={18}/> æ–°å»º</button></div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">{classGroups.map((g, idx) => { const groupStudents = (g.studentIds || []).map(sid => students.find(s => s.id === sid)).filter(Boolean); return (<div key={g.id} className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 hover:shadow-lg hover:border-gray-200 hover:-translate-y-1 transition-all duration-300 hover-lift animate-pop group" style={{animationDelay: `${idx * 50}ms`}}><div className="flex justify-between items-start mb-4"><h3 className="font-bold text-lg text-gray-800 dark:text-white">{g.name}</h3><div className="flex gap-1 transition-opacity"><button onClick={()=>{handleModalOpen(g)}} className={`text-${theme.primary}-600 p-1.5 hover:bg-${theme.primary}-50 dark:hover:bg-slate-700 rounded-lg transition-colors`}><LucideIcon name="Edit" size={16}/></button><button onClick={()=>{deleteGroup(g.id)}} className="text-red-500 p-1.5 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors"><LucideIcon name="Trash2" size={16}/></button></div></div><div className="bg-gray-50/80 dark:bg-slate-700/50 p-3 rounded-xl border border-gray-100 dark:border-slate-600 min-h-[80px]"><div className="text-[10px] text-gray-400 font-bold mb-2 flex justify-between uppercase tracking-wider"><span>å­¦å‘˜åå•</span><span className={`px-2 py-0.5 rounded-full text-xs ${groupStudents.length > 0 ? `bg-${theme.primary}-100 text-${theme.primary}-700 dark:bg-slate-600 dark:text-white` : 'bg-gray-200 text-gray-500'}`}>{groupStudents.length}äºº</span></div><div className="flex flex-wrap gap-1.5">{groupStudents.length > 0 ? groupStudents.map(s => <span key={s.id} className="bg-white dark:bg-slate-600 border border-gray-100 dark:border-slate-500 px-2.5 py-1 rounded-lg text-xs text-gray-600 dark:text-slate-200 shadow-sm flex items-center hover:border-gray-300 transition-colors">{s.name}</span>) : <span className="text-xs text-gray-300 italic py-1 pl-1">æš‚æ— å­¦å‘˜...</span>}</div></div></div>); })}</div>
                    <Modal isOpen={isEdit} onClose={()=>setIsEdit(false)} title="ç¼–è¾‘ç­çº§">
                        <div className="space-y-5">
                            {/* ç­çº§åç§° */}
                            <input className="w-full border border-gray-200 dark:border-slate-600 p-3 rounded-xl focus:ring-2 focus:ring-blue-500/20 outline-none transition-all dark:bg-slate-700 dark:text-white" placeholder="ç­çº§å" value={group.name||''} onChange={e=>setGroup({...group, name:e.target.value})} />
                            
                            <div className="border border-gray-200 dark:border-slate-600 p-3 rounded-xl bg-gray-50/50 dark:bg-slate-700/50">
                                <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-2">æ·»åŠ å­¦å‘˜</label>
                                {/* æœç´¢è¾“å…¥æ¡† */}
                                <div className="relative mb-3">
                                    <div className="flex items-center border border-gray-200 dark:border-slate-600 p-2 rounded-lg bg-white dark:bg-slate-700 dark:text-white transition-colors">
                                        <LucideIcon name="Search" size={16} className="text-gray-400 mr-2"/>
                                        <input 
                                            type="text" 
                                            placeholder="æœç´¢å­¦å‘˜å§“åæ·»åŠ ..." 
                                            className="w-full text-sm bg-transparent outline-none" 
                                            value={studentSearchTerm} 
                                            onChange={e => setStudentSearchTerm(e.target.value)} 
                                        />
                                    </div>
                                    {/* æœç´¢ç»“æœåˆ—è¡¨ */}
                                    {studentSearchTerm && searchableStudents.length > 0 && (
                                        <div className="absolute top-full left-0 w-full mt-1 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-lg shadow-lg max-h-40 overflow-y-auto z-20">
                                            {searchableStudents.map(s => (
                                                <div 
                                                    key={s.id} 
                                                    className="p-2 text-sm text-gray-800 dark:text-white cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-600 flex justify-between items-center" 
                                                    onClick={() => handleStudentToggle(s.id)}
                                                >
                                                    <span>{s.name}</span>
                                                    <span className="text-xs text-gray-400">({s.remainingHours}h)</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    {studentSearchTerm && searchableStudents.length === 0 && (
                                        <div className="absolute top-full left-0 w-full mt-1 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-lg shadow-lg p-2 text-sm text-gray-400 z-20">æœªæ‰¾åˆ°ç›¸å…³å­¦å‘˜</div>
                                    )}
                                </div>
                                
                                {/* å·²é€‰ä¸­å­¦å‘˜åˆ—è¡¨ */}
                                <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1 mt-4">å·²åœ¨ç­å­¦å‘˜ ({group.studentIds?.length || 0}äºº)</label>
                                <div className="max-h-40 overflow-y-auto border border-gray-200 dark:border-slate-600 p-3 rounded-xl grid grid-cols-2 gap-2 bg-white/50 dark:bg-slate-800/50 custom-scrollbar">
                                    {students.filter(s => group.studentIds?.includes(s.id)).map(s=>(
                                        <label key={s.id} className="flex items-center gap-2 text-xs bg-white dark:bg-slate-700 p-2 rounded-lg border border-gray-100 dark:border-slate-600 hover:border-red-200 cursor-pointer transition-all dark:text-slate-200" onClick={() => handleStudentToggle(s.id)}>
                                            <LucideIcon name="UserX" size={14} className="text-red-500"/>
                                            {s.name}
                                        </label>
                                    ))}
                                    {group.studentIds?.length === 0 && <div className="col-span-2 text-center text-gray-300 italic py-2">è¯·ä½¿ç”¨ä¸Šæ–¹æœç´¢æˆ–å‹¾é€‰æ·»åŠ å­¦å‘˜</div>}
                                </div>
                            </div>

                            <button onClick={save} className={`w-full bg-${theme.primary}-600 text-white py-3 rounded-xl font-bold hover:bg-${theme.primary}-700 transition-all shadow-md`}>ä¿å­˜ç­çº§</button>
                        </div>
                    </Modal>
                </div>
            )
        }

        const FollowUpManager = () => {
            const { students, classGroups, followUps, formatDate, theme, exportToCSV, lcAdd, lcUpdate } = useAppData();
            const addToast = useToast(); // FIX: ç¡®ä¿ addToast ä½¿ç”¨ useToast()
            const currentMonth = formatDate(new Date()).slice(0,7);
            const total = students.length * 2;
            const done = followUps.filter(f => f.monthStr === currentMonth).reduce((s,r)=>s+r.count,0);
            
            const groupedData = useMemo(() => {
                const groups = classGroups.map(g => { const groupStudents = (g.studentIds || []).map(sid => students.find(s => s.id === sid)).filter(Boolean); return { id: g.id, name: g.name, students: groupStudents }; });
                const assignedStudentIds = new Set(); classGroups.forEach(g => { if(g.studentIds) g.studentIds.forEach(sid => assignedStudentIds.add(sid)); });
                const unassignedStudents = students.filter(s => !assignedStudentIds.has(s.id));
                if (unassignedStudents.length > 0) { groups.push({ id: 'unassigned', name: 'æœªåˆ†é…ç­çº§', students: unassignedStudents, isUnassigned: true }); }
                return groups;
            }, [students, classGroups]);

            const toggle = async (sid, idx) => { const ex = followUps.find(f => f.studentId === sid && f.monthStr === currentMonth); const newCount = (ex && ex.count === idx + 1) ? idx : idx + 1; if (ex) await lcUpdate('FollowUp', ex.id, { count: newCount }); else await lcAdd('FollowUp', { studentId: sid, monthStr: currentMonth, count: newCount }); };
            const exportCSV = () => { const rows = []; groupedData.forEach(g => { g.students.forEach(s => { const rec = followUps.find(f => f.studentId === s.id && f.monthStr === currentMonth); rows.push([g.name, s.name, currentMonth, rec?rec.count:0]); }); }); exportToCSV(`å›è®¿_${currentMonth}.csv`, [['ç­çº§', 'å§“å','æœˆä»½','æ¬¡æ•°'], ...rows]); };

            return (
                <div className="p-4 md:p-6 max-w-5xl mx-auto space-y-6 pb-24 md:pb-6 pt-16 md:pt-4 animate-enter">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-gray-800 dark:text-white tracking-tight">å›è®¿ç®¡ç† <span className="text-sm font-normal text-gray-400 ml-2">({currentMonth})</span></h2><button onClick={exportCSV} className={`text-${theme.primary}-600 bg-${theme.primary}-50 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-${theme.primary}-100 transition-colors flex items-center gap-1`}><LucideIcon name="Download" size={14}/> å¯¼å‡ºè¡¨æ ¼</button></div>
                    <div className={`bg-gradient-to-br from-${theme.primary}-500 to-${theme.primary}-700 text-white p-6 rounded-2xl shadow-xl shadow-${theme.primary}-500/20 flex justify-between text-center relative overflow-hidden group`}><div className="absolute top-0 right-0 p-8 opacity-10 transform translate-x-4 -translate-y-4 group-hover:scale-110 transition-transform duration-700"><LucideIcon name="TrendingUp" size={100}/></div><div className="flex-1 z-10"><div className="text-xs opacity-75 mb-1 uppercase tracking-wider font-semibold">ç›®æ ‡</div><div className="text-3xl font-bold">{total}</div></div><div className="flex-1 z-10 border-l border-white/20 border-r"><div className="text-xs opacity-75 mb-1 uppercase tracking-wider font-semibold">å®Œæˆ</div><div className="text-3xl font-bold">{done}</div></div><div className="flex-1 z-10"><div className="text-xs opacity-75 mb-1 uppercase tracking-wider font-semibold">è¿›åº¦</div><div className="text-3xl font-bold text-yellow-300">{total>0?Math.round(done/total*100):0}%</div></div></div>
                    <div className="space-y-6">{groupedData.map((group, gIdx) => (<div key={group.id} className={`bg-white dark:bg-slate-800 rounded-2xl shadow-sm border overflow-hidden transition-all hover:shadow-md animate-pop ${group.isUnassigned ? 'border-dashed border-gray-300' : 'border-gray-100 dark:border-slate-700'}`} style={{animationDelay: `${gIdx * 100}ms`}}><div className={`px-6 py-4 border-b border-gray-50 dark:border-slate-700 flex justify-between items-center ${group.isUnassigned ? 'bg-gray-50/50 dark:bg-slate-700/50' : 'bg-white dark:bg-slate-800'}`}><h3 className="font-bold text-gray-700 dark:text-slate-200 flex items-center gap-2">{group.isUnassigned ? <LucideIcon name="Users" size={18} className="text-gray-400"/> : <LucideIcon name="Layers" size={18} className={`text-${theme.primary}-500`}/>}{group.name}</h3><span className="text-xs font-bold bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-slate-400 px-2.5 py-1 rounded-full">{group.students.length} äºº</span></div><div className="overflow-x-auto"><table className="min-w-full divide-y divide-gray-50 dark:divide-slate-700"><thead className="bg-gray-50/30 dark:bg-slate-700/30"><tr><th className="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase tracking-wider w-1/3">å­¦å‘˜</th><th className="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase tracking-wider">æœ¬æœˆè¿›åº¦</th></tr></thead><tbody className="divide-y divide-gray-50 dark:divide-slate-700 bg-white dark:bg-slate-800">{group.students.map(s => { const rec = followUps.find(f => f.studentId === s.id && f.monthStr === currentMonth); const c = rec?.count||0; return (<tr key={s.id} className="hover:bg-gray-50/80 dark:hover:bg-slate-700/50 transition-colors group"><td className="px-6 py-3.5 font-medium text-gray-700 dark:text-slate-300 flex items-center gap-3"><div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shadow-sm ${c===2 ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'}`}>{s.name[0]}</div>{s.name}</td><td className="px-6 py-3.5"><div className="flex items-center gap-2">{[0,1,2].map(i => (<div key={i} onClick={()=>toggle(s.id, i)} className={`w-8 h-8 rounded-lg flex items-center justify-center cursor-pointer transition-all duration-200 border ${i<c?`bg-${theme.primary}-500 text-white border-${theme.primary}-600 shadow-md scale-110`:'bg-white dark:bg-slate-700 text-gray-300 border-gray-200 dark:border-slate-600 hover:border-gray-300 hover:bg-gray-50 dark:hover:bg-slate-600'}`}><LucideIcon name="CheckSquare" size={14}/></div>))}<span className="text-xs text-gray-400 ml-2 opacity-0 group-hover:opacity-100 transition-opacity transform translate-x-2 group-hover:translate-x-0 duration-300">{c === 0 ? 'æœªå¼€å§‹' : c === 1 ? 'è·Ÿè¿›ä¸­' : c === 2 ? 'å®Œæˆ' : 'å·²å½’æ¡£'}</span></div></td></tr>) })}{group.students.length === 0 && <tr><td colSpan="2" className="p-8 text-center text-gray-400 italic text-sm">ç©ºç©ºå¦‚ä¹Ÿ ~</td></tr>}</tbody></table></div></div>))}
                        {groupedData.length === 0 && students.length === 0 && <div className="text-center py-16 bg-white dark:bg-slate-800 rounded-2xl border-2 border-dashed border-gray-200 dark:border-slate-700"><div className="text-gray-300 mb-2"><LucideIcon name="Users" size={48} className="mx-auto"/></div><p className="text-gray-400">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆå‰å¾€â€œå­¦å‘˜ç®¡ç†â€æ·»åŠ å­¦å‘˜</p></div>}
                    </div>
                </div>
            )
        }

        const AttendanceManager = () => {
            const { courses, students, attendanceMode, handleAttendanceModeChange, theme, formatDate, exportToCSV, lcUpdate } = useAppData(); 
            // FIX: ç¡®ä¿ addToast ä½¿ç”¨ useToast() è€Œä¸æ˜¯ä» useAppData è§£æ„
            const addToast = useToast(); 
            const currentMonth = formatDate(new Date()).slice(0,7);
            const week = Math.ceil(new Date().getDate()/7);
            
            let target = 0;
            if(attendanceMode === 'estimated') {
                // æ–°é€»è¾‘ï¼šé¢„ä¼°æ¨¡å¼ = å­¦ç”Ÿæ€»é‡ * 4 (å‡è®¾æ¯æœˆ 4 æ¬¡)
                target = students.length * 4;
            }
            else {
                // ç²¾å‡†æ¨¡å¼ = æœ¬æœˆæ‰€æœ‰å¸¸è§„è¯¾çš„å­¦å‘˜äººæ¬¡æ€»å’Œ
                courses.forEach(c => { 
                    if(c.dateStr.startsWith(currentMonth) && c.type !== 'demo') {
                         target += (c.studentIds?.length||0); 
                    }
                });
            }
            
            let actual = 0;
            const absents = [];
            courses.forEach(c => { if(c.dateStr.startsWith(currentMonth) && c.type !== 'demo') { Object.values(c.attendance||{}).forEach(a => { 
                // å®é™…å‡ºå‹¤ï¼šåˆ°è¯¾(present) æˆ– å·²è¡¥è¯¾(isMadeUp: true)
                if(a.status==='present' || a.isMadeUp) actual++; 
                // ç¼ºå‹¤å¾…è¡¥è¯¾ï¼šç¼ºå‹¤(absent) ä¸” æœªè¡¥è¯¾(!isMadeUp)
                if(a.status==='absent' && !a.isMadeUp) absents.push({cname: c.className, date: c.dateStr, sid: a.studentId, cid: c.id}); 
            }); } });
            
            const rate = target>0 ? (actual/target)*100 : 0;
            
            // ä¿®å¤åçš„ makeup å‡½æ•° (äºŒæ¬¡ä¿®æ­£ï¼Œç¡®ä¿ status å˜æ›´ä¸º present)
            const makeup = async (cid, sid) => { 
                // IMPORTANT: Use custom modal instead of confirm()
                if(window.confirm("ç¡®è®¤è¡¥è¯¾? (å°†ä¼šæ‰£é™¤å­¦å‘˜ 2 è¯¾æ—¶)")) {
                    const course = courses.find(c => c.id === cid); 
                    const student = students.find(s => s.id === sid); 

                    if (!course || !student) {
                        addToast("æœªæ‰¾åˆ°è¯¾ç¨‹æˆ–å­¦å‘˜ä¿¡æ¯", "error");
                        return;
                    }
                    
                    // 1. æ›´æ–°è¯¾ç¨‹è€ƒå‹¤ï¼šæ ‡è®°ä¸ºå·²è¡¥è¯¾ (isMadeUp: true) å¹¶ä¸”å°†çŠ¶æ€æ”¹ä¸º 'present'
                    const newAtt = {
                        ...course.attendance, 
                        [sid]: {
                            ...course.attendance[sid], 
                            status: 'present', // <-- å…³é”®ä¿®æ­£ï¼šå°†çŠ¶æ€æ˜ç¡®æ”¹ä¸º 'present'
                            isMadeUp: true
                        }
                    }; 
                    
                    // 2. æ‰£é™¤å­¦å‘˜è¯¾æ—¶ï¼šè¡¥è¯¾æˆåŠŸï¼Œæ‰£é™¤ 2 è¯¾æ—¶
                    const newRemaining = (student.remainingHours || 0) - 2;

                    // 1. æ›´æ–°è¯¾ç¨‹è€ƒå‹¤
                    const success1 = await lcUpdate('Course', cid, { attendance: newAtt });
                    
                    // 2. æ›´æ–°å­¦å‘˜è¯¾æ—¶ 
                    if (success1) {
                         const success2 = await lcUpdate('Student', sid, { remainingHours: newRemaining });
                         if(success2) {
                             addToast(`${student.name} è¡¥è¯¾æˆåŠŸï¼Œè¯¾æ—¶å·²æ‰£é™¤ (-2)ï¼Œè€ƒå‹¤çŠ¶æ€å·²æ›´æ–°`, "success");
                         } else {
                             addToast("å­¦å‘˜è¯¾æ—¶æ‰£é™¤å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥", "error");
                         }
                    }
                } 
            }

            const exportAtt = () => { const rows = []; courses.forEach(c=>{ if(c.dateStr.startsWith(currentMonth)) { (c.studentIds||[]).forEach(sid=>{ const s = students.find(x=>x.id===sid); const a = c.attendance?.[sid]; rows.push([c.dateStr, c.className, s?.name||'æœªçŸ¥', a?.status==='present'?'åˆ°':a?.status==='absent'?'ç¼º':'æœªè®°', a?.isMadeUp?'æ˜¯':'å¦']); }) } }); exportToCSV(`è€ƒå‹¤_${currentMonth}.csv`, [['æ—¥æœŸ','è¯¾ç¨‹','å§“å','çŠ¶æ€','å·²è¡¥è¯¾'],...rows]); };
            return (
                <div className="p-4 md:p-6 max-w-4xl mx-auto space-y-6 md:space-y-8 pb-24 md:pb-6 pt-16 md:pt-4 animate-enter">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-3"><h2 className="text-xl font-bold text-gray-800 dark:text-white">è€ƒå‹¤çœ‹æ¿ ({currentMonth})</h2><div className="flex gap-2 bg-white dark:bg-slate-700 p-1 rounded-lg shadow-sm border border-gray-200 dark:border-slate-600"><button onClick={()=>{handleAttendanceModeChange('estimated'); addToast("å·²åˆ‡æ¢è‡³é¢„ä¼°æ¨¡å¼")}} className={`px-3 py-1.5 text-xs rounded-md transition-all ${attendanceMode==='estimated'?`bg-${theme.primary}-100 text-${theme.primary}-700 font-bold shadow-sm`:'text-gray-500 dark:text-gray-400 hover:bg-gray-50'}`}>é¢„ä¼°æ¨¡å¼</button><button onClick={()=>{handleAttendanceModeChange('scheduled'); addToast("å·²åˆ‡æ¢è‡³ç²¾å‡†æ¨¡å¼")}} className={`px-3 py-1.5 text-xs rounded-md transition-all ${attendanceMode==='scheduled'?`bg-${theme.primary}-100 text-${theme.primary}-700 font-bold shadow-sm`:'text-gray-500 dark:text-gray-400 hover:bg-gray-50'}`}>ç²¾å‡†æ¨¡å¼</button><div className="w-px bg-gray-200 dark:bg-slate-600 mx-1"></div><button onClick={exportAtt} className="px-2 text-gray-500 dark:text-gray-400 hover:text-gray-700"><LucideIcon name="Download" size={16}/></button></div></div>
                    <div className={`p-6 rounded-xl shadow-lg text-white grid grid-cols-3 gap-4 text-center relative overflow-hidden ${rate>=94?'bg-gradient-to-br from-green-500 to-green-700':'bg-gradient-to-br from-red-500 to-red-700'}`}><div className="absolute right-0 top-0 p-4 opacity-10"><LucideIcon name={rate>=94?"TrendingUp":"AlertCircle"} size={100}/></div><div className="z-10"><div className="text-xs opacity-80 mb-1 uppercase tracking-wide">æœ¬æœˆç›®æ ‡</div><div className="text-3xl font-bold">{target}</div></div><div className="z-10"><div className="text-xs opacity-80 mb-1 uppercase tracking-wide">å®é™…å‡ºå‹¤</div><div className="text-3xl font-bold">{actual}</div></div><div className="z-10"><div className="text-xs opacity-80 mb-1 uppercase tracking-wide">è¾¾æ ‡ç‡ (94%)</div><div className="text-3xl font-bold flex items-center justify-center gap-1">{rate.toFixed(1)}%</div></div></div>
                    <div className="bg-white dark:bg-slate-800 rounded-lg shadow-sm overflow-hidden border border-gray-200 dark:border-slate-700"><div className="p-3 font-bold text-gray-600 dark:text-slate-300 text-xs bg-gray-50 dark:bg-slate-700 border-b border-gray-200 dark:border-slate-600 flex items-center gap-2"><LucideIcon name="AlertCircle" size={14} className="text-red-500"/> ç¼ºå‹¤å¾…è¡¥è¯¾åˆ—è¡¨</div><table className="min-w-full divide-y divide-gray-100 dark:divide-slate-700"><tbody className="text-sm">{absents.map((r,i) => { const s = students.find(x=>x.id===r.sid); return <tr key={i} className="hover:bg-gray-50 transition-colors"><td className="px-4 py-3 font-medium text-gray-800 dark:text-slate-200">{s?.name}</td><td className="px-4 py-3 text-gray-500 dark:text-slate-400">{r.cname}</td><td className="px-4 py-3 text-gray-400 dark:text-slate-500 text-xs">{r.date}</td><td className="px-4 py-3 text-right"><button onClick={()=>makeup(r.cid, r.sid)} className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-green-200 transition-colors shadow-sm border border-green-200">è¡¥è¯¾</button></td></tr>})}{absents.length===0 && <tr><td colSpan="4" className="p-8 text-center text-gray-400 italic">ğŸ‰ å¤ªæ£’äº†ï¼æœ¬æœˆæ‰€æœ‰ç¼ºå‹¤å·²å¤„ç†å®Œæ¯•ã€‚</td></tr>}</tbody></table></div>
                </div>
            )
        }

        const BackupManager = () => {
            const { students, courses, classGroups, followUps, formatDate, theme, fetchAll } = useAppData();
            const addToast = useToast();
            const [importing, setImporting] = useState(false);
            const handleExport = () => { const backupData = { version: "1.0", timestamp: new Date().toISOString(), students, courses, classGroups, followUps }; const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = `school_backup_${formatDate(new Date())}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); addToast("å¤‡ä»½æ–‡ä»¶å·²ä¸‹è½½", "success"); };
            const handleImport = async (e) => { const file = e.target.files[0]; if (!file) return; setImporting(true); const reader = new FileReader(); reader.onload = async (event) => { try { const data = JSON.parse(event.target.result); if(!data.students || !data.classGroups) throw new Error("æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶"); addToast("å¼€å§‹æ¢å¤æ•°æ®...", "info"); const restoreItem = async (className, item) => { const { id, createdAt, updatedAt, objectId, ...payload } = item; try { const obj = AV.Object.createWithoutData(className, id); Object.keys(payload).forEach(k => obj.set(k, payload[k])); await obj.save(); return { oldId: id, newId: id }; } catch (err) { const NewObj = AV.Object.extend(className); const newObj = new NewObj(); Object.keys(payload).forEach(k => newObj.set(k, payload[k])); await newObj.save(); return { oldId: id, newId: saved.id }; } }; for (const s of data.students) await restoreItem('Student', s); for (const g of data.classGroups) await restoreItem('ClassGroup', g); for (const c of data.courses) await restoreItem('Course', c); for (const f of data.followUps) await restoreItem('FollowUp', f); await fetchAll(); addToast("æ•°æ®æ¢å¤å®Œæˆï¼", "success"); } catch (err) { console.error(err); addToast("æ¢å¤å¤±è´¥: " + err.message, "error"); } finally { setImporting(false); e.target.value = ''; } }; reader.readAsText(file); };
            return (
                <div className="p-4 md:p-8 max-w-4xl mx-auto pt-16 md:pt-8"><h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-2"><LucideIcon name="Database" size={28}/> æ•°æ®å¤‡ä»½ä¸æ¢å¤</h2><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 hover:shadow-md transition-shadow"><div className="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-4"><LucideIcon name="Download" size={24}/></div><h3 className="text-lg font-bold text-gray-800 dark:text-white mb-2">å¯¼å‡ºå…¨ç«™å¤‡ä»½</h3><p className="text-sm text-gray-500 dark:text-slate-400 mb-6">ä¸‹è½½åŒ…å«æ‰€æœ‰å­¦å‘˜ã€è¯¾ç¨‹ã€ç­çº§åŠå›è®¿è®°å½•çš„ JSON æ•°æ®æ–‡ä»¶ã€‚å»ºè®®å®šæœŸå¤‡ä»½ä»¥é˜²æ•°æ®ä¸¢å¤±ã€‚</p><button onClick={handleExport} className={`w-full bg-${theme.primary}-600 text-white py-2 rounded-lg font-medium hover:bg-${theme.primary}-700 transition-colors shadow`}>ä¸‹è½½å¤‡ä»½æ–‡ä»¶</button></div><div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 hover:shadow-md transition-shadow"><div className="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-4"><LucideIcon name="UploadCloud" size={24}/></div><h3 className="text-lg font-bold text-gray-800 dark:text-white mb-2">æ¢å¤/å¯¼å…¥å¤‡ä»½</h3><p className="text-sm text-gray-500 dark:text-slate-400 mb-6">ä¸Šä¼ å¤‡ä»½æ–‡ä»¶ä»¥æ¢å¤æ•°æ®ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨æ›´æ–°ç°æœ‰æ•°æ®ï¼Œå¹¶æ™ºèƒ½ä¿®å¤è¢«è¯¯åˆ æ•°æ®çš„å…³è”å…³ç³»ã€‚</p><div className="relative"><input type="file" accept=".json" onChange={handleImport} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" disabled={importing} /><button disabled={importing} className={`w-full border-2 border-dashed border-${theme.primary}-300 text-${theme.primary}-600 py-2 rounded-lg font-medium hover:bg-${theme.primary}-50 transition-colors flex justify-center items-center gap-2`}>{importing ? <><div className="spinner w-4 h-4 border-current"></div> æ¢å¤ä¸­...</> : 'ç‚¹å‡»ä¸Šä¼ å¤‡ä»½æ–‡ä»¶'}</button></div></div></div><div className="mt-8 bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-sm text-yellow-800 flex gap-3"><LucideIcon name="AlertCircle" size={20} className="shrink-0 mt-0.5"/><div><div className="font-bold mb-1">å®‰å…¨æç¤º</div><p>ä¸ºäº†æ•°æ®å®‰å…¨ï¼Œæ¢å¤æ“ä½œä¼šå°è¯•ä¿ç•™åŸå§‹æ•°æ®çš„ IDã€‚å¦‚æœå‘ç°æ•°æ®å·²è¢«åˆ é™¤ï¼ˆä¾‹å¦‚è¯¯åˆ äº†æŸä¸ªå­¦å‘˜ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºæ–°æ•°æ®å¹¶å°è¯•ä¿®å¤è¯¥å­¦å‘˜åœ¨ç­çº§å’Œè¯¾ç¨‹è¡¨ä¸­çš„å…³è”ï¼Œä½†ä»å»ºè®®æ“ä½œå‰å…ˆè¿›è¡Œä¸€æ¬¡å¯¼å‡ºå¤‡ä»½ã€‚</p></div></div></div>
            )
        }

        // --- ä¸»ç¨‹åºå…¥å£ ---
        function SchoolSystem() {
            const addToast = useToast(); 
            const [activeTab, setActiveTab] = useState('dashboard'); // é»˜è®¤è¿›å…¥ Dashboard
            
            // éšæœºä¸»é¢˜
            const [theme, setTheme] = useState(() => {
                const randomIndex = Math.floor(Math.random() * THEMES.length);
                return THEMES[randomIndex];
            });
            
            // æ–°å¢ä¸»é¢˜è¿‡æ¸¡çŠ¶æ€
            // { x: number, y: number, colorClass: string, onEnd: function }
            const [rippleEffect, setRippleEffect] = useState(null); 
            const RIPPLE_DURATION = 600; // åŠ¨ç”»æŒç»­æ—¶é—´ (ms)

            // æœ¬åœ°æŒä¹…åŒ–å­˜å‚¨ï¼šæ•™å¸ˆç­‰çº§ã€è¯¾æ—¶è´¹åŸºæ•°
            const [teacherLevel, setTeacherLevel] = useState(localStorage.getItem('lms_teacher_level') || 'åˆçº§ 2 çº§');
            const [classFeeBase, setClassFeeBase] = useState(Number(localStorage.getItem('lms_class_fee_base')) || 8);
            
            // æ–°å¢çŠ¶æ€ï¼šæ§åˆ¶æ¦‚è§ˆé¡µä»Šæ—¥æ”¶å…¥æ˜¾ç¤º
            const [showTodayIncome, setShowTodayIncome] = useState(() => {
                const saved = localStorage.getItem('lms_show_today_income');
                return saved !== null ? JSON.parse(saved) : true; // é»˜è®¤æ˜¾ç¤º
            });

            // æ–°å¢ï¼šè¯­å½•çŠ¶æ€
            const [quotes, setQuotes] = useState(() => {
                try {
                    const saved = JSON.parse(localStorage.getItem('lms_quotes'));
                    return (saved && saved.length > 0) ? saved : DEFAULT_QUOTES;
                } catch(e) { return DEFAULT_QUOTES; }
            });

            useEffect(() => { localStorage.setItem('lms_teacher_level', teacherLevel); }, [teacherLevel]);
            useEffect(() => { localStorage.setItem('lms_class_fee_base', classFeeBase); }, [classFeeBase]);
            useEffect(() => { localStorage.setItem('lms_quotes', JSON.stringify(quotes)); }, [quotes]);
            useEffect(() => { localStorage.setItem('lms_show_today_income', showTodayIncome); }, [showTodayIncome]);

            const [isThemeModalOpen, setIsThemeModalOpen] = useState(false);
            const [attendanceMode, setAttendanceMode] = useState('scheduled');
            const [loading, setLoading] = useState(false);
            
            const [students, setStudents] = useState([]);
            const [courses, setCourses] = useState([]);
            const [followUps, setFollowUps] = useState([]);
            const [classGroups, setClassGroups] = useState([]);

            const [currentWeekStart, setCurrentWeekStart] = useState(new Date());
            const [viewMode, setViewMode] = useState('week'); // æ–°å¢è§†å›¾æ¨¡å¼

            const calendarDays = useMemo(() => {
                const days = [];
                let start = new Date(currentWeekStart);

                if (viewMode === 'day') {
                    days.push(new Date(start));
                } else if (viewMode === 'week') {
                    const day = start.getDay();
                    const diff = start.getDate() - day + (day === 0 ? -6 : 1);
                    start.setDate(diff);
                    for(let i=0; i<7; i++){ days.push(new Date(start)); start.setDate(start.getDate()+1); }
                } else if (viewMode === 'month') {
                    // æœˆè§†å›¾ï¼šå›ºå®šæ˜¾ç¤º 6 è¡Œ 7 åˆ— = 42 å¤©
                    start.setDate(1); // å½“æœˆ1å·
                    const dayOfWeek = start.getDay();
                    const offset = (dayOfWeek + 6) % 7; // è°ƒæ•´åˆ°å‘¨ä¸€å¼€å¤´
                    start.setDate(start.getDate() - offset);
                    for(let i=0; i<42; i++) { days.push(new Date(start)); start.setDate(start.getDate()+1); }
                }
                return days;
            }, [currentWeekStart, viewMode]);

            const changeWeek = (offset) => {
                const newDate = new Date(currentWeekStart);
                if (viewMode === 'day') newDate.setDate(newDate.getDate() + offset);
                else if (viewMode === 'week') newDate.setDate(newDate.getDate() + offset * 7);
                else if (viewMode === 'month') newDate.setMonth(newDate.getMonth() + offset);
                setCurrentWeekStart(newDate);
            };

            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            // CRUD Helpers
            const lcAdd = async (className, data) => {
                if (typeof AV === 'undefined' || !window.isLCReady) {
                    addToast("äº‘ç«¯æœåŠ¡æœªè¿æ¥ï¼Œè¯·åˆ·æ–°é‡è¯•", "error");
                    return false;
                }
                try {
                    const Obj = AV.Object.extend(className);
                    const obj = new Obj();
                    Object.keys(data).forEach(k => {
                        if (['id', 'objectId', 'createdAt', 'updatedAt'].includes(k)) return;
                        obj.set(k, data[k]);
                    });
                    await obj.save();
                    await fetchAll(); 
                    return true;
                } catch (e) { 
                    addToast("ä¿å­˜å¤±è´¥: " + e.message, "error"); 
                    return false; 
                }
            };
            const lcUpdate = async (className, id, data) => {
                if (typeof AV === 'undefined' || !window.isLCReady) return false;
                try {
                    const obj = AV.Object.createWithoutData(className, id);
                    Object.keys(data).forEach(k => {
                        if (['id', 'objectId', 'createdAt', 'updatedAt'].includes(k)) return;
                        obj.set(k, data[k]);
                    });
                    await obj.save();
                    await fetchAll(); 
                    return true;
                } catch (e) { addToast("æ›´æ–°å¤±è´¥: " + e.message, "error"); return false; }
            };
            const lcDelete = async (className, id) => {
                if (typeof AV === 'undefined' || !window.isLCReady) return false;
                try { const obj = AV.Object.createWithoutData(className, id); await obj.destroy(); await fetchAll(); return true; } catch (e) { addToast("åˆ é™¤å¤±è´¥: " + e.message, "error"); return false; }
            };

            const exportToCSV = (filename, rows) => {
                try {
                    const processRow = (row) => row.map(val => `"${String(val).replace(/"/g, '""')}"`).join(",");
                    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + rows.map(processRow).join("\n");
                    const link = document.createElement("a");
                    link.href = encodeURI(csvContent);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click(); document.body.removeChild(link);
                    addToast("å¯¼å‡ºæˆåŠŸ", "success");
                } catch (e) { addToast("å¯¼å‡ºå¤±è´¥", "error"); }
            };

            const fetchAll = useCallback(async () => {
                if (typeof AV === 'undefined' || !window.isLCReady) return;
                setLoading(true);
                try {
                    const fetchTableSafe = async (className) => {
                        try {
                            const q = new AV.Query(className);
                            q.limit(1000); 
                            const results = await q.find();
                            // ä¿®æ”¹ç‚¹ï¼šæ˜ å°„ createdAtï¼Œç”¨äºç»Ÿè®¡å­¦å‘˜å¢é•¿
                            return results.map(item => ({...item.attributes, id: item.id, createdAt: item.createdAt, updatedAt: item.updatedAt}));
                        } catch (err) {
                            // å…³é”®ä¿®å¤: å¦‚æœæ˜¯ 101 é”™è¯¯(Class not found)ï¼Œè¯´æ˜æ˜¯æ–°è´¦å·ï¼Œç›´æ¥è¿”å›ç©ºæ•°ç»„ï¼Œä¸è¦æŠ¥é”™
                            if (err.code === 101) return [];
                            console.warn(`Fetch ${className} failed:`, err);
                            return []; // å®¹é”™å¤„ç†
                        }
                    };
                    // è¿™é‡Œä¸ä½¿ç”¨ Promise.allï¼Œæ”¹ä¸ºä¸²è¡Œï¼Œé˜²æ­¢ä¸€ä¸ªå¤±è´¥å…¨éƒ¨æŒ‚æ‰
                    const s = await fetchTableSafe('Student');
                    const c = await fetchTableSafe('Course');
                    const g = await fetchTableSafe('ClassGroup');
                    const f = await fetchTableSafe('FollowUp');
                    
                    setStudents(s); setCourses(c); setClassGroups(g); setFollowUps(f);
                } catch (error) { 
                    console.error("Fetch error", error); 
                    // ä¸å†å¼¹çª—æŠ¥é”™ï¼Œä»¥å…æ‰“æ‰°ç”¨æˆ·
                } finally { setLoading(false); }
            }, [addToast]);

            useEffect(() => {
                const lsTheme = localStorage.getItem('lms_theme_id');
                // ç¡®ä¿åº”ç”¨ä¸»é¢˜ï¼ˆæ²¡æœ‰ Ripple æ—¶ç›´æ¥åº”ç”¨ï¼‰
                if (lsTheme) {
                    const savedTheme = THEMES.find(t => t.id === lsTheme) || THEMES[0];
                    setTheme(savedTheme);
                    if (savedTheme.isDark) document.documentElement.classList.add('dark');
                    else document.documentElement.classList.remove('dark');
                }
                
                const lsMode = localStorage.getItem('lms_attendance_mode');
                if (lsMode) setAttendanceMode(lsMode);
                
                // å»¶è¿Ÿä¸€ä¸¢ä¸¢åŠ è½½æ•°æ®ï¼Œç¡®ä¿ SDK åˆå§‹åŒ–å®Œæ¯•
                setTimeout(() => {
                    if(window.isLCReady) fetchAll();
                }, 500);
            }, [fetchAll, addToast]);

            // --- æ–°å¢ä¸»é¢˜æ‰©æ•£è¿‡æ¸¡é€»è¾‘ ---
            const handleThemeChange = (t, event) => { 
                // 1. è®¡ç®—ç‚¹å‡»ä½ç½® (å¦‚æœ event å­˜åœ¨)
                let x = window.innerWidth / 2;
                let y = window.innerHeight / 2;

                if (event && event.clientX !== undefined && event.clientY !== undefined) {
                    x = event.clientX;
                    y = event.clientY;
                } else {
                    // å¦‚æœæ²¡æœ‰ç‚¹å‡»äº‹ä»¶ï¼ˆä¾‹å¦‚ä»è®¾ç½®é¡µé¢ç›´æ¥è°ƒç”¨ï¼‰ï¼Œåˆ™ä½¿ç”¨å±å¹•ä¸­å¿ƒ
                    const paletteButton = document.querySelector('.bottom-8.right-8 button');
                    if (paletteButton) {
                        const rect = paletteButton.getBoundingClientRect();
                        x = rect.left + rect.width / 2;
                        y = rect.top + rect.height / 2;
                    }
                }
                
                // 2. è·å–æ–°ä¸»é¢˜çš„é¢œè‰²ç±» (ä½¿ç”¨ Tailwind 500 çº§é¢œè‰²)
                const newPrimaryColorClass = `bg-${t.primary}-500`;

                // 3. è§¦å‘æ‰©æ•£åŠ¨ç”»
                setRippleEffect({
                    x, 
                    y, 
                    colorClass: newPrimaryColorClass,
                    // åŠ¨ç”»ç»“æŸå›è°ƒï¼šçœŸæ­£åº”ç”¨ä¸»é¢˜å¹¶æ¸…é™¤åŠ¨ç”»å±‚
                    onEnd: () => {
                        // 4. åŠ¨ç”»ç»“æŸååº”ç”¨ä¸»é¢˜å’Œé¢œè‰²
                        setTheme(t); 
                        localStorage.setItem('lms_theme_id', t.id); 
                        setIsThemeModalOpen(false); 
                        
                        // 4b. åˆ‡æ¢ dark class
                        if (t.isDark) {
                             document.documentElement.classList.add('dark');
                        } else {
                             // é»˜è®¤æ‰€æœ‰é isDark ä¸»é¢˜éƒ½æ˜¯æµ…è‰²
                             document.documentElement.classList.remove('dark');
                        }
                        
                        // 5. æ¸…é™¤ Ripple æ•ˆæœï¼Œç§»é™¤åŠ¨ç”»å±‚
                        setRippleEffect(null);
                    }
                });
            };

            const ThemeTransitionRipple = React.memo(({ effect, duration }) => {
                if (!effect) return null;

                // effect.colorClass æ ¼å¼å¦‚ 'bg-blue-500'
                return (
                    <div 
                        className="theme-transition-layer"
                        // z-index ç¡®ä¿åœ¨ modal (z-[60]) ä¹‹åå‡ºç°ï¼Œå¹¶åœ¨å®ƒä¸Šé¢
                        style={{ zIndex: 70 }} 
                    >
                        <div
                            className={`ripple-circle ${effect.colorClass} fixed`} 
                            style={{
                                left: `${effect.x}px`,
                                top: `${effect.y}px`,
                                /* ä½¿ç”¨ JS å˜é‡è®¾ç½®åŠ¨ç”»æŒç»­æ—¶é—´ */
                                animation: `ripple-expand ${duration}ms cubic-bezier(0.4, 0, 0.2, 1) forwards`,
                            }}
                            onAnimationEnd={effect.onEnd}
                        />
                    </div>
                );
            });
            // --- ç»“æŸä¸»é¢˜æ‰©æ•£è¿‡æ¸¡é€»è¾‘ ---
            
            const handleAttendanceModeChange = (m) => { setAttendanceMode(m); localStorage.setItem('lms_attendance_mode', m); };

            // æ„å»ºå…¨å±€ Context æ•°æ®å¯¹è±¡
            const contextValue = {
                students, setStudents,
                courses, setCourses,
                followUps, setFollowUps,
                classGroups, setClassGroups,
                theme, setTheme,
                activeTab, setActiveTab,
                attendanceMode, handleAttendanceModeChange,
                loading, setLoading,
                currentWeekStart, setCurrentWeekStart,
                weekDays: calendarDays, changeWeek,
                calendarDays,
                formatDate,
                viewMode, setViewMode,
                teacherLevel, setTeacherLevel,
                classFeeBase, setClassFeeBase,
                fetchAll, exportToCSV,
                lcAdd, lcUpdate, lcDelete,
                quotes, setQuotes,
                showTodayIncome, setShowTodayIncome
            };

            return (
                <AppDataContext.Provider value={contextValue}>
                    <div className="flex h-screen bg-gray-100 dark:bg-slate-900 flex-col md:flex-row overflow-hidden font-sans transition-colors duration-300">
                        <div className={`hidden md:flex w-64 glass-sidebar flex-col z-20`}>
                            <div className="p-6 text-2xl font-bold border-b border-gray-200/50 dark:border-white/10 flex items-center gap-3 tracking-tight">
                                {/* ç§»é™¤äº†åŠ¨æ€å¤´åƒï¼Œä½¿ç”¨é™æ€å›¾æ ‡ */}
                                <div className={`w-10 h-10 rounded-xl bg-${theme.primary}-500 flex items-center justify-center shadow-lg text-white`}><LucideIcon name="Award" size={24}/></div>
                                <span className="text-slate-800 dark:text-white">Veape Studio</span>
                            </div>
                            <nav className="flex-1 py-6 space-y-1 overflow-y-auto px-3">
                                {['dashboard','schedule','groups','students','followup','attendance'].map(k=><button key={k} onClick={()=>setActiveTab(k)} className={`w-full text-left px-4 py-3 rounded-2xl flex items-center gap-3 transition-all duration-200 ${activeTab===k?`bg-${theme.primary}-50 dark:bg-slate-700 text-${theme.primary}-600 dark:text-white shadow-sm font-bold`:'text-slate-500 dark:text-slate-400 hover:bg-white/60 dark:hover:bg-slate-800 hover:text-slate-800 dark:hover:text-white'}`}><LucideIcon name={k==='dashboard'?'Home':k==='schedule'?'Calendar':k==='groups'?'Layers':k==='students'?'Users':k==='followup'?'PhoneCall':'CheckSquare'} size={18} /> {k==='dashboard'?'æ¦‚è§ˆ':k==='schedule'?'è¯¾ç¨‹ç®¡ç†':k==='groups'?'ç­çº§ç®¡ç†':k==='students'?'å­¦å‘˜ç®¡ç†':k==='followup'?'å›è®¿ç®¡ç†':'è€ƒå‹¤ç®¡ç†'}</button>)}
                                <div className="my-2 border-t border-gray-200/50 dark:border-white/10"></div>
                                <button onClick={()=>setActiveTab('settings')} className={`w-full text-left px-4 py-3 rounded-2xl flex items-center gap-3 transition-all duration-200 ${activeTab==='settings'?`bg-${theme.primary}-50 dark:bg-slate-700 text-${theme.primary}-600 dark:text-white shadow-sm`:'text-slate-500 dark:text-slate-400 hover:bg-white/60 dark:hover:bg-slate-800 hover:text-slate-800 dark:hover:text-white'}`}><LucideIcon name="Settings" size={18}/> ç³»ç»Ÿè®¾ç½®</button>
                            </nav>
                            <div className="p-4 border-t border-gray-200/50 dark:border-white/10">
                                {loading ? <div className="text-center text-xs text-slate-400 flex justify-center gap-2"><div className="spinner w-3 h-3 border-slate-300 border-t-blue-500"></div> åŒæ­¥ä¸­...</div> : <div className="mt-3 text-[10px] text-center text-slate-400 font-mono flex justify-center items-center gap-1.5 cursor-pointer hover:text-green-500 transition-colors" onClick={fetchAll} title="ç‚¹å‡»åˆ·æ–°"><span className={`w-2 h-2 rounded-full bg-green-500`}></span> LeanCloud åœ¨çº¿ <LucideIcon name="RefreshCw" size={10} /></div>}
                            </div>
                        </div>
                        <div className="flex-1 flex flex-col overflow-hidden relative bg-white/50 dark:bg-slate-900/50">
                            <div className="absolute top-2 right-2 z-10 flex gap-2 md:hidden"><button onClick={()=>setIsThemeModalOpen(true)} className="bg-white dark:bg-slate-800 p-2 rounded-full shadow-md border border-gray-100 dark:border-slate-700 text-gray-600 dark:text-gray-300"><LucideIcon name="Palette" size={18}/></button></div>
                            <div className="hidden md:block absolute bottom-8 right-8 z-50"><button onClick={()=>setIsThemeModalOpen(true)} className="glass-panel p-3 rounded-full hover:scale-110 transition-transform flex items-center gap-2 text-slate-600 dark:text-slate-300 hover-jelly"><LucideIcon name="Palette" size={20}/><span className="font-medium text-sm">ä¸»é¢˜é£æ ¼</span></button></div>
                            <div className="flex-1 overflow-auto scroll-smooth"><div className="max-w-7xl mx-auto w-full h-full">
                                {activeTab==='dashboard' && <Dashboard />}
                                {activeTab==='schedule' && <CourseSchedule />}
                                {activeTab==='groups' && <ClassGroupManager />}
                                {activeTab==='students' && <StudentManager />}
                                {activeTab==='followup' && <FollowUpManager />}
                                {activeTab==='attendance' && <AttendanceManager />}
                                {activeTab==='settings' && <SettingsManager />}
                            </div></div>
                        </div>
                        <div className={`md:hidden fixed bottom-0 w-full bg-white/90 dark:bg-slate-900/90 backdrop-blur border-t border-gray-200 dark:border-slate-800 flex justify-around p-2 pb-safe z-50 shadow-lg overflow-x-auto`}>
                            {['dashboard','schedule','groups','students','attendance','followup','settings'].map(k => (
                                <button key={k} onClick={()=>setActiveTab(k)} className={`flex flex-col items-center p-2 rounded-xl min-w-[3.5rem] transition-all duration-300 ${activeTab===k?`text-${theme.primary}-600 dark:text-blue-400 bg-${theme.primary}-50 dark:bg-slate-800 scale-105`:'text-gray-400 dark:text-slate-500'}`}>
                                    <LucideIcon name={
                                        k==='dashboard'?'Home':
                                        k==='schedule'?'Calendar':
                                        k==='groups'?'Layers':
                                        k==='students'?'Users':
                                        k==='attendance'?'CheckSquare':
                                        k==='followup'?'PhoneCall':
                                        'Settings'
                                    } size={20}/>
                                    <span className="text-[10px] mt-1 font-medium scale-90">
                                        {k==='dashboard'?'æ¦‚è§ˆ':
                                         k==='schedule'?'æ’è¯¾':
                                         k==='groups'?'ç­çº§':
                                         k==='students'?'å­¦å‘˜':
                                         k==='attendance'?'è€ƒå‹¤':
                                         k==='followup'?'å›è®¿':
                                         'è®¾ç½®'}
                                    </span>
                                </button>
                            ))}
                        </div>
                        
                        {/* ä¸»é¢˜åˆ‡æ¢ Modal */}
                        <Modal isOpen={isThemeModalOpen} onClose={()=>setIsThemeModalOpen(false)} title="ä¸»é¢˜">
                            <div className="grid grid-cols-2 gap-3">
                                {THEMES.map(t=>(
                                    <button 
                                        key={t.id} 
                                        onClick={(e) => handleThemeChange(t, e)} // ä¼ é€’ç‚¹å‡»äº‹ä»¶
                                        className={`p-3 border rounded-xl flex gap-3 items-center ${theme.id===t.id?`bg-${t.primary}-50 border-${t.primary}-500 text-${t.primary}-700 ring-1 ring-${t.primary}-500 shadow-sm`:'hover:bg-gray-50 hover:border-gray-300'}`}
                                    >
                                        <div className={`w-6 h-6 rounded-full bg-${t.primary}-500 shadow-sm ring-2 ring-white`}></div>
                                        {t.name}
                                    </button>
                                ))}
                            </div>
                        </Modal>
                        
                        {/* æ–°å¢ï¼šä¸»é¢˜æ‰©æ•£è¿‡æ¸¡å±‚ */}
                        <ThemeTransitionRipple effect={rippleEffect} duration={RIPPLE_DURATION} />
                        
                    </div>
                </AppDataContext.Provider>
            );
        }

        const App = () => { return <ToastProvider><SchoolSystem /></ToastProvider>; };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>